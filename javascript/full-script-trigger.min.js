var NADZ_TRIGGERS_VERSION="2.0.10.2",NADZ_TRIGGERS_ARRAY_NAME="_nAdzqTriggers",NADZ_TRIGGERS_ARRAY_BACKUP_NAME="_nAdzqTriggersBackup",NADZ_TRIGGERS_WINDOW="NADZ_TRIGGERS",NADZ_TRIGGERS_WELCOME_PUSH_VAR="_nAdzqTriggers_welcomePush",NADZ_TRIGGERS_WELCOME_PUSH_ACTION="welcomePush",NADZ_TRIGGERS_TEST_ACTION="nadzTrigModeTest";void 0!=navigator&&"serviceWorker"in navigator&&void 0!=window&&"Notification"in window&&(window[NADZ_TRIGGERS_ARRAY_NAME]=window[NADZ_TRIGGERS_ARRAY_NAME]||[],window[NADZ_TRIGGERS_WINDOW]=window[NADZ_TRIGGERS_WINDOW]||function(){class e{constructor(e,t,r,i,s){this.base_url_dev=e,this.base_url_prod=t,this.baseApi=r,this.timeBetweenCall=i,this._initMapEndpoints(s)}_initMapEndpoints(e){void 0==e&&(e=new Map),this.endpointsApi=e}getApiBaseUrl(e){let t=this.base_url_dev;return e&&(t=this.base_url_prod),t+="/"+this.baseApi}getEndpointUrl(e,t){return this.getApiBaseUrl(e)+"/"+this.getEndpointConfig(t).endpoint}getEndpointWaitingTime(e){return this.getEndpointConfig(e).waitingTime}getEndpointConfig(e){return this.endpointsApi.get(e)}static fromObject(t){return new e(t.base_url_dev,t.base_url_prod,t.baseApi,t.timeBetweenCall,t.endpointsApi)}}var t;!function(e){e.DEV="DEV",e.PROD="PROD"}(t||(t={}));const r=50,i=9e5,s={base_url_dev:"http://127.0.0.1:3000",base_url_prod:"https://secure-apis.notifadz.com",baseApi:"notifadz-v2",timeBetweenCall:3e4,endpointsApi:new Map([["opti",{endpoint:"oi/opti",waitingTime:2e4}],["cp",{endpoint:"tr/cp-rules",waitingTime:18e5}],["rmkt-opti",{endpoint:"rmkt/opti",waitingTime:18e5}]])},n={base_url_dev:"https://secure-trig.notifadz.com",base_url_prod:"https://secure-trig.notifadz.com",baseApi:"triggers",timeBetweenCall:0,endpointsApi:new Map([["triggers",{endpoint:"",waitingTime:0}],["userProfil",{endpoint:"userProfil",waitingTime:12e4}]])};class a{constructor(t,i,a){this.timeBetweenSameTrigger=6e4,this.env=t,this.activateEncoding=i,this.activateLogging=a,this.arrayMaxSize=r,this.configNotifadzApi=e.fromObject(s),this.configTriggersApi=e.fromObject(n)}envIsDev(){return a.envIsDev(this.env)}envIsProd(){return a.envIsProd(this.env)}getApiBaseUrl(e){return e.getApiBaseUrl(this.envIsProd())}getApiEpUrl(e,t){return e.getEndpointUrl(this.envIsProd(),t)}static envMatch(e,t){return e==t}static envIsDev(e){return void 0==e&&(e=this.ENV),this.envMatch(e,t.DEV)}static envIsProd(e){return void 0==e&&(e=this.ENV),this.envMatch(e,t.PROD)}static getConfigDev(){return new a(t.DEV,!1,!0)}static getConfigProd(){return new a(t.PROD,!1,!1)}static getCurrentConfig(){return this.envIsDev()?this.getConfigDev():this.envIsProd()?this.getConfigProd():null}static get ACTIVATE_ENCODING(){return this.getCurrentConfig().activateEncoding}static get ACTIVATE_LOG(){return this.getCurrentConfig().activateLogging}static get ARRAY_MAX_SIZE(){return this.getCurrentConfig().arrayMaxSize}}a.ENV=t.PROD;class o{static log(e,t){a.ACTIVATE_LOG&&(void 0==t?console.log(e):console.log(e,t))}static debug(e,t){a.ACTIVATE_LOG&&(void 0==t?console.debug(e):console.debug(e,t))}static info(e,t){a.ACTIVATE_LOG&&(void 0==t?console.info(e):console.info(e,t))}static warn(e,t){a.ACTIVATE_LOG&&(void 0==t?console.warn(e):console.warn(e,t))}static error(e,t){a.ACTIVATE_LOG&&(void 0==t?console.error(e):console.error(e,t))}static warnNotYetImplemented(e){this.warn(e+" is not yet implemented")}}class l{static checkObjectStructure(e,t,r){if(void 0==e||void 0==t)return!1;for(let i=0;i<t.length;i++){const s=t[i];if(!e.hasOwnProperty(s)&&(_.arrayIsUndefinedOrEmpty(r)||!r.includes(s)))return!1}return!0}static objectsHasSameProperties(e,t){const r=Object.getOwnPropertyNames(t);return this.checkObjectStructure(e,r)}static objectsHasSamePropertiesAs(e,t,r){const i=Object.getOwnPropertyNames(new t);return this.checkObjectStructure(e,i,r)}}class u{constructor(e,t,r){this.data=e,this.count=r,void 0==t&&(t=Date.now()),this.time=t}ageOfValueInMinutes(){return V.getElaspedTimeSinceNowInMinutes(this.time)}toString(){return this.data,this.time,",count="+this.count}isOk(){return void 0!=this.data&&void 0!=this.time&&this.time>0}isNotOk(){return!this.isOk()}getCount(){return void 0!=this.count&&0!=this.count||(this.count=1),this.count}static fromObject(e){return l.objectsHasSamePropertiesAs(e,u),u.ignorableFieldsForReviver()?new u(e.data,e.time,e.count):null}static ignorableFieldsForReviver(){return["count"]}}class c{constructor(e,t){this.auth=e,this.p256dh=t}isValid(){return void 0!=this.auth&&void 0!=this.p256dh}static fromObject(e){return l.objectsHasSamePropertiesAs(e,c)?new c(e.auth,e.p256dh):null}static objectsHasSamePropertiesAs(e){return void 0!=e.auth&&void 0!=e.p256dh&&2==Object.getOwnPropertyNames(e).length}}class h{constructor(e,t,r,i){this.endpoint=e||null,this.expirationTime=t||null,this.keys=r||null,this.optinInfo=i||null}isValid(){return void 0!=this.endpoint&&void 0!=this.keys&&this.keys.isValid()&&void 0!=this.optinInfo&&this.optinInfo.isValid()}isEqualTo(e){if(void 0==e)return!0;let t=void 0;return t=e instanceof PushSubscription?e.toJSON():e,this.endpoint==t.endpoint&&this.keys.auth==t.keys.auth&&this.keys.p256dh==t.keys.p256dh}isDifferentOf(e){return!this.isEqualTo(e)}getOptinInfo(){return this.optinInfo}hasOptinInfo(){return void 0!=this.getOptinInfo()}static fromObject(e){return l.objectsHasSamePropertiesAs(e,h)?new h(e.endpoint,e.expirationTime,e.keys,e.optinInfo):null}static fromPushSubscription(e){if(void 0!=e){const t=e.toJSON(),r=c.fromObject(t.keys);return new h(e.endpoint,e.expirationTime,r,null)}return null}static fromOptinInfo(e){if(void 0!=e){const t=new c(e.auth,e.p256dh);return new h(e.endpoint,null,t,e)}return null}static optinInfoIsNotOk(e){return void 0==e||!e.isValid()}}var d,p,g;!function(e){e.Optin="nadzOptin",e.DateOptin="nadzDateOptin",e.LastPages="nadzLastPages",e.LastProducts="nadzLastProducts",e.MontantConversion="nadzMontantConversion",e.ProduitsDansPanier="nadzProduitsDansPanier",e.UrlLastPage="nadzUrlLastPage",e.Purchased="nadzPurchased",e.IsAuthenticated="nadzIsAuthenticated",e.GeoCountryCode="nadzGeoCountryCode",e.GeoCountryName="nadzGeoCountryName",e.GeoPostalCode="nadzGeoPostalCode",e.GeoCityName="nadzGeoCityName"}(d||(d={})),function(e){e.String="String",e.Number="Number",e.Boolean="Boolean",e.Date="Date",e.Array="Array",e.ArrayValueCount="ArrayValueCount",e.ArrayValueDate="ArrayValueDate",e.Audience="Audience"}(p||(p={}));class m{constructor(e,t,r,i){this.id=e,this.propertyType=t,this.propertyKey=r,this.isGeneric=0|i}_isType(e){return this.propertyType==e}isPropertyGeneric(){return void 0!=this.isGeneric&&1==this.isGeneric}isTypeString(){return this._isType(p.String)}isTypeNumber(){return this._isType(p.Number)}isTypeBoolean(){return this._isType(p.Boolean)}isTypeDate(){return this._isType(p.Date)}isTypeArray(){return this._isType(p.Array)}isTypeArrayValueCount(){return this._isType(p.ArrayValueCount)}isTypeArrayValueDate(){return this._isType(p.ArrayValueDate)}isTypeAudience(){return this._isType(p.Audience)}toString(){return this.propertyType+"_"+this.propertyKey}static fromObject(e){return l.objectsHasSamePropertiesAs(e,m)?new m(e.id,e.propertyType,e.propertyKey,e.isGeneric):null}static ofTypeString(e){return new m(null,p.String,e)}static ofTypeNumber(e){return new m(null,p.Number,e)}static ofTypeBoolean(e){return new m(null,p.Boolean,e)}static ofTypeDate(e){return new m(null,p.Date,e)}static ofTypeArray(e){return new m(null,p.Array,e)}static dateOptin(){return this.ofTypeDate(d.DateOptin)}static lastPages(){return this.ofTypeArray(d.LastPages)}static lastProducts(){return this.ofTypeArray(d.LastProducts)}}!function(e){e.Between="Between",e.Contains="Contains",e.ContainsNot="ContainsNot",e.StartsWith="StartsWith",e.EndsWith="EndsWith",e.Equals="Equals",e.Exist="Exist",e.GreaterThan="GreaterThan",e.GreaterThanEquals="GreaterThanEquals",e.Is="Is",e.IsNot="IsNot",e.LesserThan="LesserThan",e.LesserThanEquals="LesserThanEquals",e.NotEquals="NotEquals",e.NotExist="NotExist",e.Greatest="Greatest",e.Smallest="Smallest",e.Oldest="Oldest",e.Youngest="Youngest"}(g||(g={}));class y{constructor(e,t,r,i){this.property=e,this.operator=t,this.matchingValue=r,this.subKey=i,this._initMatchingValue(r),this._checkMatchingValue()}_initMatchingValue(e){void 0!=e&&(this.propertyIsBoolean()?this.matchingValue="boolean"==typeof e?e:"true"==e:this.propertyIsTypeArray()&&!Array.isArray(e)&&"string"==typeof e?this.matchingValue=e.split(",").map(e=>e.trim()):this.propertyIsTypeNumber()||this.propertyIsTypeDate()||this.propertyIsTypeArrayValueCount()?this.matchingValue=Number(e):this.matchingValue=e)}_allowedMismatchTypes(){const e=new Map;return e.set(p.Date,"Number"),e.set(p.Audience,"String"),e.set(p.ArrayValueCount,"Number"),e}_getMatchingValueConstructorName(){return this.matchingValue.constructor.name}_checkMatchingValue(){if(void 0!=this.property&&void 0!=this.matchingValue){if(this._allowedMismatchTypes().get(this.getPropertyType())==this._getMatchingValueConstructorName())return;this.property.propertyType!=this.matchingValue.constructor.name&&o.error(`Type mismatch : property type = ${this.property}, matchingValue  type = ${this.matchingValue.constructor.name}`)}}_operatorIs(e){return this.operator.toUpperCase()==e.toUpperCase()}getPropertyKey(){return this.property.propertyKey}getPropertyType(){return this.property.propertyType}propertyIsTypeString(){return this.property.isTypeString()}propertyIsTypeNumber(){return this.property.isTypeNumber()}propertyIsBoolean(){return this.property.isTypeBoolean()}propertyIsTypeDate(){return this.property.isTypeDate()}propertyIsTypeArray(){return this.property.isTypeArray()}propertyIsTypeArrayValueCount(){return this.property.isTypeArrayValueCount()}propertyIsTypeArrayValueDate(){return this.property.isTypeArrayValueDate()}propertyIsTypeAudience(){return this.property.isTypeAudience()}operatorIsBetween(){return this._operatorIs(g.Between)}operatorIsContains(){return this._operatorIs(g.Contains)}operatorIsContainsNot(){return this._operatorIs(g.ContainsNot)}operatorIsEndsWith(){return this._operatorIs(g.EndsWith)}operatorIsEquals(){return this._operatorIs(g.Equals)}operatorIsExists(){return this._operatorIs(g.Exist)}operatorIsGreaterThan(){return this._operatorIs(g.GreaterThan)}operatorIsGreaterThanEquals(){return this._operatorIs(g.GreaterThanEquals)}operatorIsIs(){return this._operatorIs(g.Is)}operatorIsIsNot(){return this._operatorIs(g.IsNot)}operatorIsLesserThan(){return this._operatorIs(g.LesserThan)}operatorIsLesserThanEquals(){return this._operatorIs(g.LesserThanEquals)}operatorIsNotEquals(){return this._operatorIs(g.NotEquals)}operatorIsNotExist(){return this._operatorIs(g.NotExist)}operatorIsStartsWith(){return this._operatorIs(g.StartsWith)}operatorIsGreatest(){return this._operatorIs(g.Greatest)}operatorIsSmallest(){return this._operatorIs(g.Smallest)}operatorIsOldest(){return this._operatorIs(g.Oldest)}operatorIsYoungest(){return this._operatorIs(g.Youngest)}isUsingPropertyKey(e){return this.getPropertyKey()==e}isUsingPropertyKeyOfService(e){return this.isUsingPropertyKey(e.keyOfProperty)}hasSameOperator(e){return this.operator==e}toString(){return this.property+" "+this.operator+" "+this.matchingValue}static fromObject(e){return l.objectsHasSamePropertiesAs(e,y,y.ignorableFieldsForReviver())?new y(e.property,e.operator,e.matchingValue,e.subKey):null}static ignorableFieldsForReviver(){return["subKey"]}static lastProducts(e,t){return new y(m.lastProducts(),e,t)}static lastProductsContains(e){return this.lastProducts(g.Contains,e)}static lastProductsExists(e){return this.lastProducts(g.Exist,e)}static lastPages(e,t){return new y(m.lastPages(),e,t)}static lastPageStartWith(e){return this.lastPages(g.StartsWith,e)}static lastPageEndWith(e){return this.lastPages(g.EndsWith,e)}static lastPageEquals(e){return this.lastPages(g.Equals,e)}static lastPageContains(e){return this.lastPages(g.Contains,e)}}class _{static createArrayFromMap(e){if(le.isEmpty(e))return[];const t=[];for(const r of e)t.push(r);return t}static createArrayFromMapValues(e){if(le.isEmpty(e))return[];const t=[];for(const r of e)t.push(r[1]);return t}static deepCopyArray(e){return JSON.parse(JSON.stringify(e))}static arrayIsUndefinedOrEmpty(e){return e instanceof Map?void 0==e||0==e.size:void 0==e||void 0==e.length||0==e.length}static arrayIsNotEmpty(e){return!this.arrayIsUndefinedOrEmpty(e)}static sameArrays(e,t){return!this.arrayIsUndefinedOrEmpty(e)&&!this.arrayIsUndefinedOrEmpty(t)&&JSON.stringify(e)===JSON.stringify(t)}static notSameArrays(e,t){return!this.sameArrays(e,t)}static _arrayIsNotOk(e,t){return this.arrayIsUndefinedOrEmpty(e)||this.arrayIsUndefinedOrEmpty(t)||e.length<t.length}static arrayStartsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;const r=e.slice(0,t.length);return this.sameArrays(r,t)}static arrayEndsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;let r=this.deepCopyArray(e),i=this.deepCopyArray(t);return this.arrayStartsWithExpectedArray(r.reverse(),i.reverse())}static arrayContainsExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;const r=this.lowerCaseOfStringValues(e);return t.forEach(e=>{let t=e;if("string"==typeof e&&(t=e.toLowerCase()),!r.includes(t))return!1}),!0}static lowerCaseOfStringValues(e){return e.map(e=>"string"==typeof e?e.toLowerCase():e)}static arrayContainsNotExpectedArray(e,t){return!this.arrayContainsExpectedArray(e,t)}static isNotEmptyEvenFirstItem(e){return this.arrayIsNotEmpty(e)&&ce.isNotEmpty(e[0])}static containsStringIgnoreCase(e,t){return e.filter(e=>ce.isNotEmpty(e)).map(e=>e.toUpperCase()).includes(t.toUpperCase())}static containsNotStringIgnoreCase(e,t){return!this.containsStringIgnoreCase(e,t)}}class f{static isTheGreatest(e,t){if(_.arrayIsUndefinedOrEmpty(e)||null==t||t.count<1)return!1;let r=0;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.count>r&&(r=i.count)}return t.count>=r}static isTheSmallest(e,t){if(_.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.count;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.count<r&&(r=i.count)}return t.count<=r}static isTheOldest(e,t){if(_.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.time;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.time<r&&(r=i.time)}return t.time<=r}static isTheYoungest(e,t){if(_.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.time;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.time>r&&(r=i.time)}return t.time>=r}}class v{constructor(e){this._keyOfProperty=e,this._valueOfProperty=this._fetchValueOfProperty()}get keyOfProperty(){return this._keyOfProperty}get valueOfProperty(){return this._valueOfProperty}_fetchValueOfProperty(){if(this._keyOfProperty==d.DateOptin){const e=k.getPushSub();if(void 0!=e&&void 0!=e.optinInfo)return new u(e.optinInfo.timestamp,e.optinInfo.timestamp)}const e=k.storageUserProfile().getItem(this._keyOfProperty);let t=void 0;return void 0!=e&&le.isNotMap(e)&&(t=u.fromObject(e)),void 0!=t&&this._keyOfProperty==d.DateOptin&&(t.data=t.time),null==t&&(t=e),t}_getCurrentValueAsArray(){return _.createArrayFromMapValues(this._valueOfProperty)}_getCurrentSubKeyValue(e){return this._getCurrentValueAsArray().find(t=>t.data==e)}_sortArrayOfTimedValues(e){return e.sort((e,t)=>he.compareTimedValueForSort(e,t))}_getCurrentValueAsArrayOfData(e=!0){let t=this._getCurrentValueAsArray();return e&&(t=this._sortArrayOfTimedValues(t)),Array.isArray(t)?t.map(e=>e.data):[]}_getCurrentValueAsTimedValue(){return this._valueOfProperty}_getCurrentValueData(){const e=this._getCurrentValueAsTimedValue();if(void 0!=e)return e.data}_getCurrentValueTime(){const e=this._getCurrentValueAsTimedValue();if(void 0!=e)return e.time}_checkRuleForOperator(e,t){return e.operator.toUpperCase()==t.toUpperCase()&&e.isUsingPropertyKey(this._keyOfProperty)}_logCheck(e,t,r){}_checkStartsWith(e){const t=g.StartsWith;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.arrayStartsWithExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.startsWithIgnoreCase(r,e.matchingValue)}return o.warn("Check starts with not implemented for the type ",e.getPropertyType()),!1}_checkEndsWith(e){const t=g.EndsWith;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.arrayEndsWithExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.endsWithIgnoreCase(r,e.matchingValue)}return o.warn("Check ends with not implemented for the type ",e.getPropertyType()),!1}_checkEquals(e){const t=g.Equals;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.sameArrays(r,e.matchingValue)}if(e.propertyIsBoolean()||e.propertyIsTypeNumber()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),r==e.matchingValue}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.isEqualsIgnoreCase(r,e.matchingValue)}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count==e.matchingValue}return o.warn("Check equals not implemented for the type ",e.getPropertyType()),!1}_checkNotEquals(e){const t=g.NotEquals;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.notSameArrays(r,e.matchingValue)}if(e.propertyIsBoolean()||e.propertyIsTypeNumber()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),r!=e.matchingValue}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.isNotEqualsIgnoreCase(r,e.matchingValue)}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count!=e.matchingValue}return o.warn("Check equals not implemented for the type ",e.getPropertyType()),!1}_checkContains(e){const t=g.Contains;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.arrayContainsExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.includesIgnoreCase(r,e.matchingValue)}return o.warn("Check contains not implemented for the type ",e.getPropertyType()),!1}_checkContainsNot(e){const t=g.ContainsNot;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),_.arrayContainsNotExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),ce.includesNotIgnoreCase(r,e.matchingValue)}return o.warn("Check containsNot not implemented for the type ",e.getPropertyType()),!1}_checkExist(e){const t=g.Exist;if(!this._checkRuleForOperator(e,t))return o.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),void 0!=r&&(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>void 0!=e),_.arrayIsNotEmpty(r)):e.propertyIsTypeString()?ce.isNotEmpty(r.data)&&"null"!=r.data:void 0!=r.data)}_checkNotExist(e){const t=g.NotExist;if(!this._checkRuleForOperator(e,t))return o.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),void 0==r||(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>void 0!=e),_.arrayIsUndefinedOrEmpty(r)):e.propertyIsTypeString()?ce.isEmpty(r.data):void 0==r.data)}_checkGreaterThan(e){const t=g.GreaterThan;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.greaterThan(r.data,e.matchingValue);if(e.propertyIsTypeDate())return he.valueIsOlderThan(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return _.arrayIsNotEmpty(t)&&t.length>e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count>e.matchingValue}return o.warn("Check greaterThan not implemented for the type ",e.getPropertyType()),!1}_checkGreaterThanEquals(e){const t=g.GreaterThanEquals;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.greaterThanEquals(r.data,e.matchingValue);if(e.propertyIsTypeDate())return he.valueIsOlderThanEquals(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return _.arrayIsNotEmpty(t)&&t.length>=e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count>=e.matchingValue}return o.warn("Check greaterThanEquals not implemented for the type ",e.getPropertyType()),!1}_checkLesserThan(e){const t=g.LesserThan;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.lesserThan(r.data,e.matchingValue);if(e.propertyIsTypeDate())return he.valueIsSmallerThan(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return _.arrayIsNotEmpty(t)&&t.length<e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count<e.matchingValue}return o.warn("Check LesserThan not implemented for the type ",e.getPropertyType()),!1}_checkLesserThanEquals(e){const t=g.LesserThanEquals;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.lesserThanEquals(r.data,e.matchingValue);if(e.propertyIsTypeDate())return he.valueIsSmallerThanEquals(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return _.arrayIsNotEmpty(t)&&t.length<=e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count<=e.matchingValue}return o.warn("Check LesserThanEquals not implemented for the type ",e.getPropertyType()),!1}_checkGreatest(e){const t=g.Greatest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?f.isTheGreatest(r,i):(o.warn("Check _checkGreatest not implemented for the type ",e.getPropertyType()),!1)}_checkSmallest(e){const t=g.Smallest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?f.isTheSmallest(r,i):(o.warn("Check _checkSmallest not implemented for the type ",e.getPropertyType()),!1)}_checkOldest(e){const t=g.Oldest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?f.isTheOldest(r,i):(o.warn("Check _checkOldest not implemented for the type ",e.getPropertyType()),!1)}_checkYoungest(e){const t=g.Youngest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?f.isTheYoungest(r,i):(o.warn("Check _checkYoungest not implemented for the type ",e.getPropertyType()),!1)}_checkIs(e){const t=g.Is,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?L.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(void 0!=e){return new H(e).rulesAreValidated()}return Promise.resolve(!1)}).catch(e=>Promise.resolve(!1)):(o.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(o.info("Rule and operator are different"),Promise.resolve(!1))}_checkIsNot(e){const t=g.IsNot,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?L.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(void 0!=e){return new H(e).rulesAreNotValidated()}return Promise.resolve(!1)}).catch(e=>Promise.resolve(!1)):(o.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(o.info("Rule and operator are different"),Promise.resolve(!1))}_ruleToString(e){let t=this._valueOfProperty;return t instanceof Array&&t.length>1&&(t="[",t+=this._valueOfProperty.join("|"),t+="]"),"prop key = "+this._keyOfProperty+", value = "+t+", rule = "+e}ruleMatchProperty(e){if(this._keyOfProperty!=e.getPropertyKey())return Promise.resolve(!1);let t=Promise.resolve(!1);if(e.operatorIsStartsWith())t=Promise.resolve(this._checkStartsWith(e));else if(e.operatorIsEndsWith())t=Promise.resolve(this._checkEndsWith(e));else if(e.operatorIsEquals())t=Promise.resolve(this._checkEquals(e));else if(e.operatorIsNotEquals())t=Promise.resolve(this._checkNotEquals(e));else if(e.operatorIsContains())t=Promise.resolve(this._checkContains(e));else if(e.operatorIsContainsNot())t=Promise.resolve(this._checkContainsNot(e));else if(e.operatorIsExists()){const r=this._checkExist(e);t=Promise.resolve(r)}else e.operatorIsNotExist()?t=Promise.resolve(this._checkNotExist(e)):e.operatorIsGreaterThan()?t=Promise.resolve(this._checkGreaterThan(e)):e.operatorIsGreaterThanEquals()?t=Promise.resolve(this._checkGreaterThanEquals(e)):e.operatorIsIs()?t=this._checkIs(e):e.operatorIsIsNot()?t=this._checkIsNot(e):e.operatorIsLesserThan()?t=Promise.resolve(this._checkLesserThan(e)):e.operatorIsLesserThanEquals()?t=Promise.resolve(this._checkLesserThanEquals(e)):e.operatorIsGreatest()?t=Promise.resolve(this._checkGreatest(e)):e.operatorIsSmallest()?t=Promise.resolve(this._checkSmallest(e)):e.operatorIsOldest()?t=Promise.resolve(this._checkOldest(e)):e.operatorIsYoungest()&&(t=Promise.resolve(this._checkYoungest(e)));return t}static from(e){return new v(e.getPropertyKey())}}class I{constructor(e,t,r,i,s,n,a,o,l,u,c){this.campaignId=e,this.name=t,this.rules=r,this._initAllRulesNeedToMatch(i),this._initTriggerDelay(s),this._initIsInstant(n),this.waitingTimeInDaysBetweenPushes=a||1,this.pushContent=o,this.ciblage=l,this.startHour=u,this.endHour=c}_initAllRulesNeedToMatch(e){void 0==e&&(e=!0),this.allRulesNeedToMatch=e}_initTriggerDelay(e){void 0==e&&(e=0),this.triggerDelayInMinutes=e}_initIsInstant(e){void 0==e&&(e=!0),this.isInstant=e}_getLogPrefix(e){return this.constructor.name+" - "+e}getId(){return this.campaignId.toString()}getTriggerDelayInMillis(){return V.minutesToMillis(this.triggerDelayInMinutes)}toString(){return`name=${this.name}, triggerDelayInMinutes=${this.triggerDelayInMinutes}, isInstant=${this.isInstant}, \n                waitingTimeInDaysBetweenPushes=${this.waitingTimeInDaysBetweenPushes}, rules=${this.rules}, pushContent=${this.pushContent}`}isUsingPropertyKey(e){return T.atLeastOneRuleUsingPropertyKey(this.rules,e)}canBeUpdated(){return void 0!=this.waitingTimeInDaysBetweenPushes&&this.waitingTimeInDaysBetweenPushes>=0}hasTimeTable(){return ce.isNotEmpty(this.startHour)&&ce.isNotEmpty(this.endHour)}static ignorableFieldsForReviver(){return["ciblage","pushContent"]}static fromObject(e){return l.objectsHasSamePropertiesAs(e,I,I.ignorableFieldsForReviver())?new I(e.campaignId,e.name,e.rules,e.allRulesNeedToMatch,e.triggerDelayInMinutes,e.isInstant,e.waitingTimeInDaysBetweenPushes,e.pushContent,e.ciblage,e.startHour,e.endHour):null}}class A{constructor(e,t){this.title=e,this.options=t}toString(){return`title=${this.title}, options=${this.options}`}static fromObject(e){return l.objectsHasSamePropertiesAs(e,A)?new A(e.title,e.options):null}static newPushContent(e,t,r,i,s){const n=new te(t,r,i,s);return new A(e,n)}}const C={HOME:"home",PRODUITS:"produits",PRODUIT_A:"produitA",PRODUIT_B:"produitB",PANIER:"panier"};class T{static lastProductsContains_A(){let e=[C.PRODUIT_A];return y.lastProductsContains(e)}static lastProductsContains_B(){let e=[C.PRODUIT_B];return y.lastProductsContains(e)}static lastProductsExists(){return y.lastProductsExists(null)}static testLastPagesStartWith_home_produits_produitA(){let e=[C.HOME,C.PRODUITS,C.PRODUIT_A];return y.lastPageStartWith(e)}static testLastPagesEndWith_home_produits_panier(){let e=[C.HOME,C.PRODUITS,C.PANIER];return y.lastPageEndWith(e)}static testLastPagesEquals(){let e=[C.HOME,C.PRODUITS,C.PRODUIT_B,C.PRODUITS,C.PANIER];return y.lastPageEquals(e)}static testLastPagesContains_A_B(){let e=[C.PRODUIT_A,C.PRODUIT_B];return y.lastPageContains(e)}static getRulesUsingPropertyKey(e,t){let r=[];return e.forEach(e=>{e.isUsingPropertyKey(t)&&r.push(e)}),r}static atLeastOneRuleUsingPropertyKey(e,t){let r=[];for(let i=0;i<e.length;i++){const s=e[i];if(s.isUsingPropertyKey(t))return Promise.resolve(!0);if(s.propertyIsTypeAudience()){const e=L.getNestedAudienceByIdString(s.getPropertyKey());r.push(e)}}return Promise.all(r).then(e=>{let r=[];return e.forEach(e=>{const i=this.atLeastOneRuleUsingPropertyKey(e.rules,t);r.push(i)}),r}).then(e=>Promise.all(e).then(e=>{for(let t=0;t<e.length;t++)if(1==e[t])return!0;return!1}).catch(e=>!1)).catch(e=>!1)}static operatorExist(e){return Object.keys(g).map(e=>e.toLowerCase()).includes(e.toLowerCase())}static getRulesUsingAudience(e){return e.filter(e=>e.propertyIsTypeAudience())}static getNestedAudiencesIds(e){return this.getRulesUsingAudience(e).map(e=>e.getPropertyKey()).map(e=>parseInt(e))}}class P{constructor(e){void 0==e&&(e={}),this.id=e.id,this.campaignId=e.campaignId,this.name=e.name,this.rules=e.rules,this._initAllRulesNeedToMatch(e.allRulesNeedToMatch),this._initIsInstant(e.isInstant),this.pushContent=e.pushContent}_initAllRulesNeedToMatch(e){void 0==e&&(e=!0),this.allRulesNeedToMatch=e}_initIsInstant(e){void 0==e&&(e=!0),this.isInstant=e}getId(){return this.id.toString()}toString(){return`id=${this.id}, campaignId=${this.campaignId}, name=${this.name}, isInstant=${this.isInstant}, \n                rules=${this.rules}, pushContent=${this.pushContent}`}isUsingPropertyKey(e){return T.atLeastOneRuleUsingPropertyKey(this.rules,e)}static ignorableFieldsForReviver(){return["pushContent"]}}class E{constructor(e){void 0==e&&(e={}),this.campaigns=e.campaigns,this.nestedAudiences=e.nestedAudiences}}class S{static get badParametersMsg(){return"Bad parameters"}static get badCiblageMsg(){return"Bad ciblage"}static getPromiseRejectForBadParameters(e=this.badParametersMsg){return new Promise((t,r)=>{r(e)})}static getPromiseRejectForBadCiblage(e=this.badCiblageMsg){return new Promise((t,r)=>{r(e)})}static utf8_to_b64(e){if(e)return window.btoa(unescape(encodeURIComponent(e)))}static b64_to_utf8(e){if(e)return decodeURIComponent(escape(window.atob(e)))}static replacer(e,t){const r=this[e];return r instanceof Map?{dataType:"Map",value:_.createArrayFromMap(r)}:t}static reviver(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.value);if(l.objectsHasSamePropertiesAs(t,u,u.ignorableFieldsForReviver()))return u.fromObject(t);if(l.objectsHasSamePropertiesAs(t,I,I.ignorableFieldsForReviver()))return I.fromObject(t);if(l.objectsHasSamePropertiesAs(t,P,P.ignorableFieldsForReviver()))return new P(t);if(l.objectsHasSamePropertiesAs(t,m))return m.fromObject(t);if(l.objectsHasSamePropertiesAs(t,A))return A.fromObject(t);if(l.objectsHasSamePropertiesAs(t,te))return te.fromObject(t);if(l.objectsHasSamePropertiesAs(t,y,y.ignorableFieldsForReviver()))return y.fromObject(t);if(l.objectsHasSamePropertiesAs(t,h))return h.fromObject(t);if("keys"==e&&c.objectsHasSamePropertiesAs(t))return c.fromObject(t);if(l.objectsHasSamePropertiesAs(t,x,x.ignorableFieldsForReviver()))return new x(t);if(l.objectsHasSamePropertiesAs(t,ee))return new ee(t);if(l.objectsHasSamePropertiesAs(t,E))return new E(t)}return t}static checkRecusivite(e,t,r){let i=window[e]||{count:1,timeFirstCall:Date.now()};i.count++,window[e]=i;let s=V.getElaspedTimeSinceNowInSeconds(i.timeFirstCall);return s<1&&(s=1),!(i.count/s>t&&s>r)}static deleteGlobalVarRecursivite(e){window[e]=void 0}}var O,R,w,N;!function(e){e.UserProfile="nadzUserProfile",e.Campaigns="nadzCampaigns",e.ValidatedCampaigns="nadzValidatedCampaigns",e.CampaignsToCheckAgain="nadzCheckAgain",e.TriggersSended="nadzTriggersSended",e.ProfilSended="nadzProfilSended",e.Idv="nadzIdv",e.Rmkt="nadzRmkt"}(O||(O={})),function(e){e.Ids="nadzIds",e.PushSubscription="nadzPushSubscription",e.NadzLastVisit="nadzLastVisit",e.RmktIsActive="nadzRmktIsActive"}(R||(R={}));class k{constructor(e){this._rootKey=e}getRootKey(){return k.ENCODE?this.encode(this._rootKey):this._rootKey}_getRootItem(){if(void 0==this._rootItem){let e=localStorage.getItem(this.getRootKey());void 0!=e&&k.ENCODE&&(e=this.decode(e)),this._rootItem=void 0==e?new Map:JSON.parse(e,S.reviver)}return this._rootItem}_setRootItem(e){this._saveRootItemInStorage(e),this._rootItem=e}_saveRootItemInStorage(e){void 0==e&&(e=this._rootItem);let t=JSON.stringify(e,S.replacer);k.ENCODE&&(t=this.encode(t)),localStorage.setItem(this.getRootKey(),t)}_setItem(e,t){this._getRootItem().set(e,t)}_deleteItem(e){this._getRootItem().delete(e)}encode(e){return S.utf8_to_b64(e)}decode(e){return S.b64_to_utf8(e)}getItem(e){let t=this._getRootItem();return t.has(e)?t.get(e):null}hasItem(e){return void 0!=this.getItem(e)}getAllItems(){return this._getRootItem()}setItems(e){this._saveRootItemInStorage(e)}setItem(e,t){this._setItem(e,t),this._saveRootItemInStorage()}removeItem(e){this._deleteItem(e),this._saveRootItemInStorage()}clearItems(){this._setRootItem(new Map)}static storageUserProfile(){return void 0==k.instanceUserProfile&&(k.instanceUserProfile=new k(O.UserProfile)),k.instanceUserProfile}static storageRmkt(){return new k(O.Rmkt)}static storageRmktGetOptinInfo(){return k.storageRmkt().getItem(d.Optin)}static storageCampaigns(){return new k(O.Campaigns)}static storageValidatedCampaigns(){return new k(O.ValidatedCampaigns)}static storageCheckAgain(){return new k(O.CampaignsToCheckAgain)}static storageTriggersSended(){return new k(O.TriggersSended)}static saveCommonKey(e,t){this.storageUserProfile().setItem(e,t)}static saveIds(e){this.saveCommonKey(R.Ids,e)}static getIds(){let e=this.storageUserProfile().getItem(R.Ids);return ce.isEmpty(e)&&(e=window[R.Ids],ce.isNotEmpty(e)&&this.saveIds(e)),e}static getIdv(){let e=localStorage.getItem(O.Idv),t=JSON.parse(e);if(void 0==t){const e=window[O.Idv];void 0!=e&&(this.saveIdv(e),t=e)}return t}static saveIdv(e){void 0!=e&&localStorage.setItem(O.Idv,JSON.stringify(e))}static saveRmktIsActive(e=!0){this.saveCommonKey(R.RmktIsActive,e)}static getRmktIsActive(){return this.storageUserProfile().getItem(R.RmktIsActive)}static getDateOptin(){return this.storageUserProfile().getItem(d.DateOptin)}static getPushSub(){return this.storageUserProfile().getItem(R.PushSubscription)}static savePushSub(e){o.log("Saving subscription",e),this.saveCommonKey(R.PushSubscription,e)}static clearAll(e=!1){o.log("Clearing all local storage");const t=[O.Rmkt];Object.keys(O).forEach(r=>{t.includes(O[r])||e&&r==O.Campaigns||localStorage.removeItem(O[r])})}static clearItems(e){o.log("Clearing items in "+e.getRootKey()),e.clearItems()}static clearItemsInCheckAgainAndValidatedCampaigns(){this.clearItems(this.storageValidatedCampaigns()),this.clearItems(this.storageCheckAgain())}}k.ENCODE=a.ACTIVATE_ENCODING;class b{static getUsedKeysFromCampaigns(e){let t=[];if(_.arrayIsUndefinedOrEmpty(e))return Promise.resolve(new Set(t));const r=e.map(e=>e.rules);if(_.arrayIsUndefinedOrEmpty(r))return Promise.resolve(new Set(t));const i=r.reduce((e,t)=>e.concat(t));return t=i.filter(e=>!e.propertyIsTypeAudience()).map(e=>e.getPropertyKey()),L.getNestedAudienceByRules(i).then(e=>this.getUsedKeysFromCampaigns(e).then(e=>{e.forEach(e=>t.push(e));const r=new Set(t);return r.size,r}).catch(e=>new Set([]))).catch(e=>new Set([]))}}class V{static getElapsedTime(e,t){return void 0==e&&(e=0),void 0==t&&(t=0),e-t}static getElapsedTimeBetweenDates(e,t){return this.getElapsedTime(e.getTime(),t.getTime())}static getElaspedTimeSinceNow(e){return this.getElapsedTime(Date.now(),e)}static getElaspedTimeSinceNowInSeconds(e){const t=this.getElaspedTimeSinceNow(e);return this.millisToSeconds(t)}static getElaspedTimeSinceNowInMinutes(e){const t=this.getElaspedTimeSinceNow(e);return this.millisToMinutes(t)}static getElaspedTimeSinceNowForDate(e){return this.getElapsedTimeBetweenDates(new Date,e)}static getTimeInSeconds(e){return void 0==e&&(e=0),e/1e3}static getTimeInMinutes(e){return this.getTimeInSeconds(e)/60}static getTimeInHours(e){return this.getTimeInMinutes(e)/60}static getTimeInDays(e){return this.getTimeInHours(e)/24}static millisToSeconds(e){return void 0==e&&(e=0),e/1e3}static secondsToMinutes(e){return void 0==e&&(e=0),e/60}static millisToMinutes(e){return void 0==e&&(e=0),this.secondsToMinutes(this.millisToSeconds(e))}static secondsToMillis(e){return void 0==e&&(e=0),1e3*e}static minutesToMillis(e){return void 0==e&&(e=0),this.secondsToMillis(60*e)}static hoursToMillis(e){return void 0==e&&(e=0),this.minutesToMillis(60*e)}static daysToMillis(e){return void 0==e&&(e=0),this.hoursToMillis(24*e)}static addDays(e,t){return e.setDate(e.getDate()+t),e}static addHours(e,t){return e.setHours(e.getHours()+t),e}static stringMatchesFormatHoursMinutes(e){return void 0!=e&&void 0!=e.match(/^[0-9]{2}:[0-9]{2}$/gm)}static getHoursFromStringHoursMinutes(e){try{return parseInt(e.substring(0,2))}catch(e){return-1}}static getMinutesFromStringHoursMinutes(e){try{return parseInt(e.substring(3,5))}catch(e){return-1}}static getSumOfMinutesFromStringHoursMinutes(e){const t=this.getHoursFromStringHoursMinutes(e),r=this.getMinutesFromStringHoursMinutes(e);return-1==t||-1==r?-1:60*t+r}static getMinutesFromHoursMinutesOfDate(e){try{return 60*e.getHours()+e.getMinutes()}catch(e){return-1}}static hoursAndMinutesAreAfterGivenOnes(e,t){return this.getMinutesFromHoursMinutesOfDate(e)>this.getSumOfMinutesFromStringHoursMinutes(t)}static hoursAndMinutesAreBeforeGivenOnes(e,t){return this.getMinutesFromHoursMinutesOfDate(e)<this.getSumOfMinutesFromStringHoursMinutes(t)}static hoursAndMinutesAreBetweenGivenOnes(e,t,r){return this.hoursAndMinutesAreAfterGivenOnes(e,t)&&this.hoursAndMinutesAreBeforeGivenOnes(e,r)}}class M{constructor(e,t=!1){this._LOG=!1,this._lsService=e.getLocalStorageService(),this._waitingTimeBetweenCalls=e.getWaitingTime(),this._lastCallKeySuffix=e.getLastCallKeySuffix(),this._externalCall=e,this._delayFirstCall=t}_log(e,t){this._LOG&&o.log(e,t)}_info(e,t){this._LOG&&o.info(e,t)}_isFirstCall(){return 0==this._getLastCall()}_getLastCall(){let e=this._lsService.getItem(this._getLastCallFullKey());return void 0==e&&(e=0),e}_getLastCallFullKey(){return M.LAST_CALL_KEY+this._lastCallKeySuffix}_setLastCall(e){this._lsService.setItem(this._getLastCallFullKey(),e)}_updateLastCallToNow(){const e=this._lsService.getRootKey();this._log("Updating lastCall to now for "+e),this._setLastCall(Date.now())}_getElapsedTimeSinceLastCall(){return this._noWaitingTime()?(this._info("No waiting time"),1):V.getElaspedTimeSinceNow(this._getLastCall())}_waitingTimeIsExceeded(){if(this._isFirstCall()&&this._delayFirstCall)return this._log("Delaying first call"),this._updateLastCallToNow(),!1;const e=this._getElapsedTimeSinceLastCall();return this._log("Elapsed waiting time (in seconds) = ",V.getTimeInSeconds(e)),e>this._waitingTimeBetweenCalls}_noWaitingTime(){return 0==this._waitingTimeBetweenCalls}_callExternalApi(...e){return this._log("Fetching remotly : "+this._externalCall.constructor.name),this._noWaitingTime()||this._updateLastCallToNow(),this._externalCall.externalCallFunc(e)}_externalCondition(...e){return void 0!=this._externalCall.conditionnalCallFunc&&this._externalCall.conditionnalCallFunc(e)}_callExternalApiIfNeededAndSaveInLs(...e){const t=this;return new Promise((r,i)=>{if(t._waitingTimeIsExceeded()||t._externalCondition(e)){const i=t._callExternalApi(e);if(void 0!=i)return i.then(e=>{t._externalCall.saveResultInLSFunc(e).then(t=>r(e)).catch(t=>r(e))}).catch(e=>{o.error("Exception while calling external api : ",e)})}r("Not yet the time to call")})}getResult(...e){return this._callExternalApiIfNeededAndSaveInLs(e).then(()=>this._externalCall.getResultInLSFunc()).catch(e=>void 0)}callApi(...e){return this._callExternalApiIfNeededAndSaveInLs(e)}}M.LAST_CALL_KEY="lastCall";class D{constructor(e,t,r){this._lastCallKeySuffix=e,this._lsService=t,this._configApi=r,this._config=a.getCurrentConfig()}getApiBaseUrl(){return this._config.getApiBaseUrl(this._configApi)}getApiUrl(e){return this._config.getApiEpUrl(this._configApi,e)}getEndpointWaitingTime(e){return this._configApi.getEndpointWaitingTime(e)}getLastCallKeySuffix(){return this._lastCallKeySuffix}getLocalStorageService(){return this._lsService}getWaitingTime(){return this._configApi.timeBetweenCall}externalCallFunc(...e){throw new Error("Method not implemented.")}conditionnalCallFunc(...e){return!1}saveResultInLSFunc(e){throw new Error("Method not implemented.")}getResultInLSFunc(){throw new Error("Method not implemented.")}}class F{constructor(){}_getOptinInfo(){return void 0==this.optinInfo?K.getService().getOptinInfo().then(e=>(this.optinInfo=e,Promise.resolve(this.optinInfo))).catch(e=>void 0):Promise.resolve(this.optinInfo)}isCampaignOk(e){return this._getOptinInfo().then(t=>Promise.resolve(this.isCampaignOkWithOptin(e,t))).catch(e=>Promise.resolve(!1))}isCampaignOkWithOptin(e,t){if(void 0==t)return!0;const r=e.ciblage;let i=!0;if([133013,133014,122361,124049].includes(e.campaignId))return!0;if(void 0==r)return!0;const s=k.getIds();return _.isNotEmptyEvenFirstItem(r.ids)?i=void 0!=r.ids.find(e=>e==s):_.isNotEmptyEvenFirstItem(r.idsExclus)&&(i=void 0==r.idsExclus.find(e=>e==s)),0==i||void 0==t?i:(void 0==r.isMobile||r.isMobile==t.isMobile)&&((!ce.isNotEmpty(r.browser)||!ce.isNotEqualsIgnoreCase(r.browser,t.browser))&&((!ce.isNotEmpty(r.postalCode)||!ce.includesNotIgnoreCase(r.postalCode,t.postalCode.toString()))&&((!ce.isNotEmpty(r.cityName)||!ce.includesNotIgnoreCase(r.cityName,t.cityName.toString()))&&((!_.isNotEmptyEvenFirstItem(r.listCountry)||!_.containsNotStringIgnoreCase(r.listCountry,t.countryCode))&&i))))}filterCampaignsByCiblage(e){return this._getOptinInfo().then(t=>{const r=e.filter(e=>void 0!=e).filter(e=>this.isCampaignOkWithOptin(e,t));return Promise.resolve(r)}).catch(e=>Promise.resolve([]))}}class G extends D{constructor(){super("NadzExternalCallCampaigns",k.storageCampaigns(),a.getCurrentConfig().configNotifadzApi),this._keyRules="rules",this._keyEndpoint="cp",this._checkCiblageService=new F}externalCallFunc(...e){const t=k.getIds();if(ce.isEmpty(t))return Promise.resolve(void 0);const r={ids:t};return Y.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{const t=JSON.stringify(e);return JSON.parse(t,S.reviver)}).catch(e=>void 0)}_filterCampaignsByCiblage(e){return this._checkCiblageService.filterCampaignsByCiblage(e)}saveResultInLSFunc(e){if(void 0==e||void 0==e.campaigns)return Promise.resolve();try{return this._filterCampaignsByCiblage(e.campaigns).then(t=>{const r=new E;r.campaigns=t,r.nestedAudiences=e.nestedAudiences,this._lsService.setItem(this._keyRules,r)}).catch(e=>void 0)}catch(e){return o.error("Exception while saveResultInLSFunc of CallCampaigns",e),Promise.resolve()}}getResultInLSFunc(){return this._lsService.getAllItems().get(this._keyRules)}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class L{constructor(){let e=new G;this._externalCallService=new M(e)}getCampaignById(e){return this.getCampaigns().then(t=>{for(let r=0;r<t.length;r++){const i=t[r];if(i.campaignId==e)return Promise.resolve(i)}return Promise.resolve(null)}).catch(e=>Promise.resolve(null))}getCampaignsForPropertyKey(e){return this.getCampaigns().then(t=>{const r=[];if(void 0!=t){const i=[];for(let s=0;s<t.length;s++){const n=t[s],a=n.isUsingPropertyKey(e).then(e=>{e&&r.push(n)}).catch(e=>{});i.push(a)}return Promise.all(i).then(()=>r).catch(e=>[])}return Promise.resolve([])}).catch(e=>Promise.resolve([]))}_callAndGetResult(e){return this._externalCallService.getResult().then(t=>{if(void 0==t)return Promise.resolve([]);{const r=e?t.campaigns:t.nestedAudiences;return Promise.resolve(r)}}).catch(e=>Promise.resolve([]))}getCampaigns(){return this._callAndGetResult(!0)}getAudiences(){return this._callAndGetResult(!1)}getAudienceById(e){return this.getAudiences().then(t=>void 0==t?Promise.resolve(void 0):Promise.resolve(t.find(t=>t.id==e))).catch(e=>Promise.resolve(void 0))}getAudienceByIdList(e){return this.getAudiences().then(t=>void 0==t?Promise.resolve(void 0):Promise.resolve(t.filter(t=>e.includes(t.id)))).catch(e=>Promise.resolve(void 0))}static getCampaigns(){return(new L).getCampaigns()}static callApiAndFetch(e){return(new L)._externalCallService.callApi().then(t=>{if(void 0==t)return Promise.resolve([]);{const r=e?t.campaigns:t.nestedAudiences;return Promise.resolve(r)}}).catch(e=>Promise.resolve([]))}static fetchCampaigns(){return L.callApiAndFetch(!0)}static fetchNestedAudiences(){return L.callApiAndFetch(!1)}static getNestedAudiences(){return(new L).getAudiences()}static getNestedAudienceById(e){return(new L).getAudienceById(e)}static getNestedAudienceByIdList(e){return(new L).getAudienceByIdList(e)}static getNestedAudienceByIdString(e){const t=parseInt(e);return this.getNestedAudienceById(t)}static getNestedAudienceByIdStringList(e){return(new L).getAudienceByIdList(e.map(e=>parseInt(e)))}static getNestedAudienceByRules(e){const t=T.getNestedAudiencesIds(e);return this.getNestedAudienceByIdList(t)}}class U{static userIsOptin(){return"granted"===Notification.permission}static canRunProgram(){return this.userIsOptin()?Promise.resolve(!0):this.getRmktOptinInfo().then(e=>void 0!=e).catch(e=>!1)}static getRmktOptinInfo(){return ie.getOptinFromRmkt().then(e=>e).catch(e=>{o.error("Error while getRmktOptinInfo",e)})}static whenServiceWorkerReadyDo(e){const t="nadzTrig_whenServiceWorkerReadyDo";if(!S.checkRecusivite(t,150,1.5))return console.log("Stopping recursive calls"),S.deleteGlobalVarRecursivite(t),Promise.resolve(!1);const r=Notification.permission;return"granted"===r?navigator.serviceWorker.ready.then(e).catch(e=>o.error("Exception while navigator.serviceWorker.ready",e)):"denied"===r||"default"===r?this.getRmktOptinInfo().then(t=>void 0!=t&&1==t.isFromRmkt?navigator.serviceWorker.ready.then(e).catch(e=>o.error("Exception while navigator.serviceWorker.ready",e)):new Promise((e,t)=>{(new z).deleteProfilInAdrenalead().then(t=>{k.clearAll(!0),e(!0)}).catch(t=>{k.clearAll(!0),e(!0)})})).catch(e=>{}):void 0}static whenGetSubscriptionDo(e){return this.whenServiceWorkerReadyDo(t=>t.pushManager.getSubscription().then(e).catch(e=>o.error("Exception while registration.pushManager.getSubscription()",e)))}static pushLocalNotif(e){this.whenServiceWorkerReadyDo(t=>{t.showNotification(e.title,e.options)})}static pushLocalNotifFromCampaign(e){this.pushLocalNotif(e.pushContent)}}class x{constructor(e){void 0==e&&(e={}),this.endpointId=e.endPointId||e.endpointId||e.endpoint_id,this.userId=e.idv||e.userId||e.user_id,this.timestamp=e.timestamp,this.browser=e.browser,this.os=e.os,this.countryCode=e.countryCode||e.country_code||e.geoCountryCode,this.countryName=e.countryName||e.country_name||e.geoCountryName,this.cityName=e.cityName||e.city_name||e.geoCityName,this.postalCode=e.postalCode||e.postal_code||e.geoPostalCode,this.ids=e.ids,this.endpoint=e.endpoint,this.auth=e.auth,this.p256dh=e.p256dh,this.isMobile=e.isMobile,void 0==this.isMobile&&(this.isMobile=e.is_mobile),void 0==this.isMobile&&(this.isMobile=!1),this.isFromRmkt=e.isFromRmkt,void 0==this.isFromRmkt&&(this.isFromRmkt=!1)}isValid(){return void 0!=this.endpointId&&void 0!=this.timestamp}static ignorableFieldsForReviver(){return["userId","idv"]}}class B extends D{constructor(){super("NadzExternalCallEpi",k.storageUserProfile(),a.getCurrentConfig().configNotifadzApi),this._keyEndpoint="opti"}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||2!=t.length)return S.getPromiseRejectForBadParameters();let r={a:t[0],p:t[1]};return Y.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{if("object"==typeof e)return new x(e)}).catch(e=>void 0)}_refreshCampaigns(){return k.storageCampaigns().clearItems(),(new L).getCampaigns()}_setGeoLocValuesInUserProfil(e){const t=new J;ce.isNotEmpty(e.countryCode)&&t.setValue(d.GeoCountryCode,e.countryCode),ce.isNotEmpty(e.countryName)&&t.setValue(d.GeoCountryName,e.countryName),void 0!=e.postalCode&&t.setValue(d.GeoPostalCode,e.postalCode),ce.isNotEmpty(e.cityName)&&t.setValue(d.GeoCityName,e.cityName),(new z).sendProfilToAdrenalead()}saveResultInLSFunc(e){if(void 0!=e){const t=k.getPushSub();t.optinInfo=e,k.savePushSub(t),this._refreshCampaigns().then(t=>this._setGeoLocValuesInUserProfil(e)).catch(e=>{})}return Promise.resolve()}getResultInLSFunc(){const e=k.getPushSub();if(void 0!=e)return e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class K{constructor(){this._extCallService=new M(new B)}_saveSubscriptionIfNeeded(e){const t=this.getStoredPushSub();if(void 0==t||t.isDifferentOf(e)){void 0!=t&&t.isDifferentOf(e)&&k.clearItemsInCheckAgainAndValidatedCampaigns();let r=void 0;return r=e instanceof PushSubscription?h.fromPushSubscription(e):e,k.savePushSub(r),r}return t}_getSubscription(){const e=this;return U.whenGetSubscriptionDo(t=>U.userIsOptin()&&null!=t?e._saveSubscriptionIfNeeded(t):ie.getOptinFromRmktAsPushSub())}getStoredPushSub(){return k.getPushSub()}getOptinInfo(){const e=this._getSubscription();return void 0==e?Promise.resolve(void 0):e.then(e=>{if(void 0!=e&&void 0!=e.keys){const t=e.keys.auth,r=e.keys.p256dh,i=e.optinInfo;return void 0!=i&&i instanceof x&&i.isValid()?Promise.resolve(e.getOptinInfo()):this._extCallService.getResult(t,r)}return Promise.resolve(void 0)}).catch(e=>Promise.resolve(void 0))}saveSubscription(){return this.getOptinInfo()}static getService(){return new K}static saveSubscription(){return this.getService().saveSubscription()}}class H{constructor(e){this._item=e}rulesAreValidated(){if(void 0==this._item)return Promise.resolve(!1);let e=Promise.resolve(!1);return e=this._item.allRulesNeedToMatch?this._allRulesAreMatching():this._atLeastOneRuleIsMatching()}rulesAreNotValidated(){return this.rulesAreValidated().then(e=>Promise.resolve(!e)).catch(e=>Promise.resolve(!0))}_ruleMatchPropertyPromises(){const e=[];for(let t=0;t<this._item.rules.length;t++){const r=this._item.rules[t],i=v.from(r);e.push(i.ruleMatchProperty(r))}return Promise.all(e)}_atLeastOneRuleIsMatching(){return this._ruleMatchPropertyPromises().then(e=>{let t=!1;for(let r=0;r<e.length;r++){if(1==e[r]){t=!0;break}}return Promise.resolve(t)}).catch(e=>Promise.resolve(!1))}_allRulesAreMatching(){return this._ruleMatchPropertyPromises().then(e=>{let t=!0;for(let r=0;r<e.length;r++){if(0==e[r]){t=!1;break}}return Promise.resolve(t)}).catch(e=>Promise.resolve(!1))}}class W extends D{constructor(){super("NadzExternalCallUserProfilApi",k.storageUserProfile(),a.getCurrentConfig().configTriggersApi),this._keyEndpoint="userProfil",this.KEY_STORAGE=O.ProfilSended}retrieveGlobalParams(...e){let t=e[0];for(let e=0;e<10&&void 0!=t;e++){if(!Array.isArray(t))return t;t=t[0]}}retrieveSendParams(...e){const t=this.retrieveGlobalParams(e);if(void 0!=t)return t.params}retrieveSendCondition(...e){const t=this.retrieveGlobalParams(e);if(void 0!=t)return t.condition}profilIsNotOk(e){return void 0==e||e.isNotOk()}profilEmptyOrWithOnlyOptin(e){return _.arrayIsUndefinedOrEmpty(e.profil)||1==e.profil.length&&e.profil[0].tag==d.Optin}getStoredLastSendedProfil(){return localStorage.getItem(this.KEY_STORAGE)}saveSendedProfil(e){localStorage.setItem(this.KEY_STORAGE,JSON.stringify(e))}canSendProfil(e){const t=this.getStoredLastSendedProfil();if(ce.isNotEmpty(t)){return JSON.stringify(e)!=t}return!0}externalCallFunc(...e){const t=this.retrieveSendParams(e);if(void 0==t)return S.getPromiseRejectForBadParameters();const r=t.userProfil,i=t.httpMethod;return this.profilIsNotOk(r)||void 0==i?S.getPromiseRejectForBadParameters():this.profilEmptyOrWithOnlyOptin(r)&&"DELETE"!=i?void 0:this.canSendProfil(r)||"DELETE"==i?(this.saveSendedProfil(r),Y.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),{p:r},i)):(o.debug("Profil not sended to remote api - values are the same"),Promise.resolve("204"))}conditionnalCallFunc(...e){const t=this.retrieveSendCondition(e),r=void 0!=t&&t.forceSendProfil;return r&&o.info("Forcing send profil"),r}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class z{constructor(){this._externalCallService=new M(new W,!1)}isArrayOfTimedValue(e){return Array.isArray(e)&&e[0]instanceof u}_getPushSub(e){let t=k.storageUserProfile().getAllItems(),r=t.get(R.PushSubscription);return void 0!=r||e&&1!=window.nadzTrigModeTest?Promise.resolve(r):K.saveSubscription().then(e=>(t=k.storageUserProfile().getAllItems(),r=t.get(R.PushSubscription),Promise.resolve(r))).catch(e=>Promise.resolve(void 0))}_prepareProfilTags(e){let t=k.storageUserProfile().getAllItems();const r=[];return e||t.forEach((e,t)=>{let i=void 0;if(e instanceof u)i=re.createFromTimedValue(t,e);else if(e instanceof Map){const r=_.createArrayFromMapValues(e);this.isArrayOfTimedValue(r)&&(i=re.createFromArrayOfTimedValue(t,r))}void 0!=i&&r.push(i)}),r}_createUserProfilBeanFromOptinInfo(e){const t={ids:e.ids,auth:e.auth,p256:e.p256dh,profil:[],epi:e.endpointId,idv:e.userId};return e.isFromRmkt&&(t.fIds=e.ids),new X(t)}_createBeanFromLocalStorage(e){try{return this._getPushSub(e).then(t=>{const r=k.getIds(),i=this._prepareProfilTags(e);if(void 0!=t){const s={ids:r,auth:t.keys.auth,p256:t.keys.p256dh,profil:i};if(!e){const e=t.optinInfo;void 0!=e&&(s.idv=e.userId,s.epi=e.endpointId,e.isFromRmkt&&(s.fIds=e.ids))}return Promise.resolve(new X(s))}return Promise.resolve(void 0)}).catch(e=>Promise.resolve(void 0))}catch(e){return o.error("Error while creating profil bean",e),Promise.resolve(void 0)}}_createSendGlobalParams(e,t,r=!1){return{params:{httpMethod:e,userProfil:t},condition:{forceSendProfil:r}}}_callApi(e,t,r){return this._externalCallService.callApi(this._createSendGlobalParams(e,t,r))}_callApiDelete(e,t){return this._callApi("DELETE",e,t)}sendProfilToAdrenalead(e){return this._createBeanFromLocalStorage().then(t=>{void 0!=t&&(o.debug("sending userProfil",t),this._callApi("POST",t,e))}).catch(e=>{})}deleteProfilInAdrenalead(e){return this._createBeanFromLocalStorage(!0).then(t=>{void 0!=t&&(o.debug("deleting userProfil",t),this._callApiDelete(t,e))}).catch(e=>{})}deleteProfilRmktInAdrenalead(){const e=k.storageRmktGetOptinInfo(),t=this._createUserProfilBeanFromOptinInfo(e);return t.fIds=t.ids,t.ids=k.getIds(),this._callApiDelete(t,!0)}}class j extends D{constructor(){super("NadzExternalCallTriggersApi",k.storageValidatedCampaigns(),a.getCurrentConfig().configTriggersApi),this._storageSendedTriggersService=k.storageTriggersSended(),this._userProfilService=new z}_getDateRules(e){let t=e.filter(e=>e.propertyIsTypeDate);return void 0==t&&(t=[]),t}_delayFromRule(e){if(void 0==e)return Promise.resolve(0);const t=e.matchingValue;return e.operatorIsGreaterThan()?Promise.resolve(t):e.propertyIsTypeAudience()&&e.operatorIsIs()?L.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>void 0!=e?this._delayFromRules(e.rules,!0):0).catch(e=>0):void 0}_delayFromRules(e,t=!1){if(void 0==e)return Promise.resolve(0);const r=[];return this._getDateRules(e).forEach(e=>{r.push(this._delayFromRule(e))}),Promise.all(r).then(e=>{let t=0;for(let r=0;r<e.length;r++){const i=e[r];i>t&&(t=i)}return t}).then(e=>t?e:V.minutesToMillis(e)).catch(e=>0)}_campaignHasTimeTable(e){return e.hasTimeTable()&&V.stringMatchesFormatHoursMinutes(e.startHour)&&V.stringMatchesFormatHoursMinutes(e.endHour)}_getSendingDate(e){let t=e.getTriggerDelayInMillis();t<=0&&(t=i,o.debug(`Replacing delay by default value ${V.millisToMinutes(t)} min`)),o.debug(`Final delay for trigger ${e.campaignId} is ${V.millisToMinutes(t)} min`);let r=new Date(Date.now()+t);if(this._campaignHasTimeTable(e)){let t=!1;if(V.hoursAndMinutesAreBeforeGivenOnes(r,e.startHour)?t=!0:V.hoursAndMinutesAreAfterGivenOnes(r,e.endHour)&&(t=!0,r=V.addDays(r,1),o.debug("Added a day to date, new sendingDate = ",r)),t){const t=V.getHoursFromStringHoursMinutes(e.startHour),i=V.getMinutesFromStringHoursMinutes(e.startHour);-1!=t&&-1!=i&&(r.setHours(t),r.setMinutes(i),o.debug("Changed hours:min, new sendingDate = ",r))}}return r}getStoredTrigger(e){const t=e.idc.toString();return this._storageSendedTriggersService.getItem(t)}saveTrigger(e){const t=new u(e);this._storageSendedTriggersService.setItem(e.idc.toString(),t)}triggerIsNotOk(e){return void 0==e||void 0==e.tr||ce.isEmpty(e.tr.a)||ce.isEmpty(e.tr.p)||ce.isEmpty(e.tr.epu)||void 0==e.tr.idc||ce.isEmpty(e.tr.ids)}canSendTrigger(e,t){if(this.triggerIsNotOk(t))return!1;if("PUT"==e){const e=t.tr,r=this.getStoredTrigger(e);if(void 0==r)return!0;if(V.getElaspedTimeSinceNow(r.time)<a.getCurrentConfig().timeBetweenSameTrigger){const t=r.data;let i="Waiting time between 2 PUT for same trigger NOT OK, checking if some values changed, id = "+t.idc;return o.debug(i),t.a!=e.a||t.epi!=e.epi||t.epu!=e.epu||t.ids!=e.ids||t.idc!=e.idc||t.p!=e.p}}return!0}getUserId(e){var t;let r=void 0;return r=void 0!=e&&ce.isNotEmpty(e.userId)?e.userId:null===(t=k.getIdv())||void 0===t?void 0:t.idv}_fetchOldOptinInfo(){return k.storageRmktGetOptinInfo()}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||t.length<3||t.length>4)return S.getPromiseRejectForBadParameters();const r=t[0],i=t[1],s=t[2],n=t[3],a="DELETE"!=s;if(void 0==r||void 0==i||void 0==s)return S.getPromiseRejectForBadParameters();let o=r.getOptinInfo();if(1==n){const e=this._fetchOldOptinInfo();if((null===e||void 0===e?void 0:e.userId)==(null===o||void 0===o?void 0:o.userId))return Promise.resolve("204");o=e}if(void 0!=o&&a){if(!(new F).isCampaignOkWithOptin(i,o))return S.getPromiseRejectForBadCiblage()}const l=this.getUserId(o),u=o?o.endpointId:void 0,c=o?o.timestamp:void 0,h=i?i.ciblage:void 0,d=!!o&&o.isFromRmkt;void 0!=h&&d&&h.ids.push(o.ids);const p=k.getIds();let g=p;void 0!=o&&void 0!=o.ids&&(g=o.ids);const m=this._getSendingDate(i);let y={tr:{idc:i.campaignId,uid:l,sd:m,epi:u,ids:g,epu:r.endpoint,a:r.keys.auth,p:r.keys.p256dh,t:c,c:h,wait:i.waitingTimeInDaysBetweenPushes}};d&&(y.tr.pIds=p);let _=Promise.resolve();return ce.isEmpty(u)&&(_=ae.getOptinInfo(p).then(e=>{void 0!=e&&(y.tr.hf=e.href,y.tr.hn=e.hostname,y.tr.lg=e.language,y.tr.pf=e.platform,y.tr.ua=e.userAgent)}).catch(e=>{})),_.then(e=>this.canSendTrigger(s,y)?(1!=n&&this.saveTrigger(y.tr),a&&this._userProfilService.sendProfilToAdrenalead(!0),Y.fetchJsonToUrl(this.getApiBaseUrl(),y,s)):Promise.resolve("204")).catch(e=>Promise.resolve("204"))}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}}class q{constructor(){this._campaignStorageService=new L,this._validatedCampaigns=k.storageValidatedCampaigns(),this._campaignsToCheckAgain=k.storageCheckAgain(),this._extCallService=new M(new j,!1),this._mapOfRequestedCalls=new Map}_campaignIsAlreadyValidated(e){return this._validatedCampaigns.hasItem(e.getId())}_putCampaignInLs(e,t){o.log("Putting campaign in LS : "+t.getRootKey()),t.setItem(e.getId(),e)}_removeCampaignInLs(e,t){o.log("Removing campaign in LS : "+t.getRootKey()),t.removeItem(e.getId())}_putCampaignInLsCheckAgain(e){this._putCampaignInLs(e,this._campaignsToCheckAgain)}_removeCampaignInLsCheckAgain(e){this._removeCampaignInLs(e,this._campaignsToCheckAgain)}_putCampaignInLsValidated(e){this._putCampaignInLs(e,this._validatedCampaigns)}_removeCampaignInLsValidated(e){this._removeCampaignInLs(e,this._validatedCampaigns)}_addBeanToListOfCalls(e){this._mapOfRequestedCalls.set(e.getKey(),e)}_callTriggerApi(e,t,r,i,s){if(void 0!=i&&1==i){const i=new Q(e,t,r);return o.info("Putting aside the requested call for "+i.getKey()),void this._addBeanToListOfCalls(i)}const n=K.getService();n.getOptinInfo().then(i=>{const a=n.getStoredPushSub();this._extCallService.callApi(a,e,t,s).then(e=>{r(e)}).catch(r=>{o.error(`Error while calling ${t} trigger API `,r),this._handleCallTriggerApiFailed(e,r)})}).catch(e=>{o.error("Error while getting epi ",e)})}_callTriggerApiWithBean(e){return this._callTriggerApi(e.campaign,e.httpMethod,e.callback)}_handleCallTriggerApiFailed(e,t){t!=S.badCiblageMsg&&this._putCampaignInLsCheckAgain(e)}_insertCampaign(e,t){this._callTriggerApi(e,"POST",t=>{201!=t&&204!=t||(this._putCampaignInLsValidated(e),this._removeCampaignInLsCheckAgain(e))},t)}_updateCampaign(e,t){this._callTriggerApi(e,"PUT",t=>{404==t&&(this._putCampaignInLsCheckAgain(e),this._removeCampaignInLsValidated(e))},t)}_deleteCampaign(e,t,r){this._callTriggerApi(e,"DELETE",t=>{204==t&&this._removeCampaignInLsValidated(e)},t,r)}_handleValidatedCampaign(e,t){1!=e.isInstant?this._campaignIsAlreadyValidated(e)?e.canBeUpdated()&&this._updateCampaign(e,t):this._insertCampaign(e,t):U.pushLocalNotifFromCampaign(e)}_handleUnvalidatedCampaign(e,t){this._validatedCampaigns.hasItem(e.getId())&&this._deleteCampaign(e,t)}_checkCampaign(e,t){return new H(e).rulesAreValidated().then(r=>{r?this._handleValidatedCampaign(e,t):this._handleUnvalidatedCampaign(e,t)}).catch(e=>{})}sendDeleteForValidatedCampaignsAndClean(){for(const e of this._validatedCampaigns.getAllItems().values())this._deleteCampaign(e,!1,!0);return Promise.resolve()}checkRulesForKey(e,t,r){let i=Promise.resolve(t);void 0==t&&(i=this._campaignStorageService.getCampaignsForPropertyKey(e));const s=[];return i.then(t=>{void 0==t&&(t=[]),o.log(`campaigns for key ${e} = `,t);for(let e=0;e<t.length;e++)s.push(this._checkCampaign(t[e],r));return Promise.all(s)}).catch(e=>Promise.all(s))}checkRulesForCheckAgainCampaigns(){let e=_.createArrayFromMapValues(this._campaignsToCheckAgain.getAllItems());return o.log("campaigns in checkAgain = ",e),b.getUsedKeysFromCampaigns(e).then(t=>{const r=[];for(let i=0;i<t.size;i++)r.push(this.checkRulesForKey(t[i],e));return Promise.all(r)}).catch(e=>{})}sendRequestedCalls(){this._mapOfRequestedCalls.forEach((e,t)=>{this._callTriggerApiWithBean(e)})}static deleteValidatedCampaignsAndClean(){return(new q).sendDeleteForValidatedCampaignsAndClean()}}class Y{static getRequestContent(e,t){return{method:e,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}}static fetchJsonToUrl(e,t,r){return new Promise((i,s)=>{if(void 0==e)return void s("Bad parameters, url can't be null");void 0==r&&(r="POST");const n=this.getRequestContent(r,t);o.info("Fetching at "+e+" with body "+JSON.stringify(n));try{fetch(e,n).then(e=>{e.json().then(e=>i(e)).catch(t=>i(e.status))}).catch(e=>{s(e)})}catch(e){return void s(e)}})}}!function(e){e.SPECIAL_CHARS="HTML_SPECIALCHARS",e.ENTITIES="HTML_ENTITIES"}(w||(w={})),function(e){e.NO_QUOTES="ENT_NOQUOTES",e.COMPAT="ENT_COMPAT",e.QUOTES="ENT_QUOTES"}(N||(N={}));class Z{static htmlMappingTable(e,t){const r=e||w.SPECIAL_CHARS,i=t||N.QUOTES,s={},n={};if(r==w.SPECIAL_CHARS)s[38]="&amp;",s[60]="&lt;",s[62]="&gt;";else{if(r!=w.ENTITIES)return;s[38]="&amp;",s[60]="&lt;",s[62]="&gt;",s[160]="&nbsp;",s[161]="&iexcl;",s[162]="&cent;",s[163]="&pound;",s[164]="&curren;",s[165]="&yen;",s[166]="&brvbar;",s[167]="&sect;",s[168]="&uml;",s[169]="&copy;",s[170]="&ordf;",s[171]="&laquo;",s[172]="&not;",s[173]="&shy;",s[174]="&reg;",s[175]="&macr;",s[176]="&deg;",s[177]="&plusmn;",s[178]="&sup2;",s[179]="&sup3;",s[180]="&acute;",s[181]="&micro;",s[182]="&para;",s[183]="&middot;",s[184]="&cedil;",s[185]="&sup1;",s[186]="&ordm;",s[187]="&raquo;",s[188]="&frac14;",s[189]="&frac12;",s[190]="&frac34;",s[191]="&iquest;",s[192]="&Agrave;",s[193]="&Aacute;",s[194]="&Acirc;",s[195]="&Atilde;",s[196]="&Auml;",s[197]="&Aring;",s[198]="&AElig;",s[199]="&Ccedil;",s[200]="&Egrave;",s[201]="&Eacute;",s[202]="&Ecirc;",s[203]="&Euml;",s[204]="&Igrave;",s[205]="&Iacute;",s[206]="&Icirc;",s[207]="&Iuml;",s[208]="&ETH;",s[209]="&Ntilde;",s[210]="&Ograve;",s[211]="&Oacute;",s[212]="&Ocirc;",s[213]="&Otilde;",s[214]="&Ouml;",s[215]="&times;",s[216]="&Oslash;",s[217]="&Ugrave;",s[218]="&Uacute;",s[219]="&Ucirc;",s[220]="&Uuml;",s[221]="&Yacute;",s[222]="&THORN;",s[223]="&szlig;",s[224]="&agrave;",s[225]="&aacute;",s[226]="&acirc;",s[227]="&atilde;",s[228]="&auml;",s[229]="&aring;",s[230]="&aelig;",s[231]="&ccedil;",s[232]="&egrave;",s[233]="&eacute;",s[234]="&ecirc;",s[235]="&euml;",s[236]="&igrave;",s[237]="&iacute;",s[238]="&icirc;",s[239]="&iuml;",s[240]="&eth;",s[241]="&ntilde;",s[242]="&ograve;",s[243]="&oacute;",s[244]="&ocirc;",s[245]="&otilde;",s[246]="&ouml;",s[247]="&divide;",s[248]="&oslash;",s[249]="&ugrave;",s[250]="&uacute;",s[251]="&ucirc;",s[252]="&uuml;",s[253]="&yacute;",s[254]="&thorn;",s[255]="&yuml;"}i!=N.NO_QUOTES&&(s[34]="&quot;"),i==N.QUOTES&&(s[39]="&#039;");for(const e in s){n[String.fromCharCode(e)]=s[e]}return n}static htmlDecode(e,t,r){let i=t.toString();const s=Z.htmlMappingTable(e,r);if(void 0==s)return"";for(const e in s){const t=s[e];i=i.split(t).join(e)}return i}static htmlSpecialCharsDecode(e,t){return Z.htmlDecode(w.SPECIAL_CHARS,e,t)}static htmlEntitiesDecode(e,t){return Z.htmlDecode(w.ENTITIES,e,t)}}class J{constructor(){this._LOG=!1,this._calledOptin=!1,this._nbOfActionsToExecute=0,this._nbOfActionsExecuted=0,this._cpFetched=!1,this._lsUserProfile=k.storageUserProfile(),this._checkCampaignService=new q,this._userProfilService=new z,this._userProfilHasChanged=!1}_log(e,t){this._LOG&&o.log(e,t)}_addToMap(e,t){!le.isEmpty(e)&&e instanceof Map||(e=new Map);const r=new u(t,void 0,1),i=r.data,s=e.get(i);return void 0!=s&&(r.count+=s.getCount()),e.set(i,r),this._userProfilHasChanged=!0,e}_addToArray(e,t){_.arrayIsUndefinedOrEmpty(e)&&(e=[]);let r=e.length-1;if(r<0&&(r=0),!e[r]||e[r].data!=t){let r=new u(t);e.push(r),this._userProfilHasChanged=!0}return e}_removeFromArray(e,t){if(_.arrayIsUndefinedOrEmpty(e))return;const r=[];for(let i=0;i<e.length;i++){e[i].data==t&&r.push(i)}if(_.arrayIsNotEmpty(r))for(let t=0;t<r.length;t++)e.splice(r[t]-t,1);return e}_removeFromMap(e,t){if(!le.isEmpty(e))return e.delete(t),e}_checkMap(e){for(;e.size>a.ARRAY_MAX_SIZE;)for(const t of e.keys()){e.delete(t);break}}_checkArray(e){for(;e.length>a.ARRAY_MAX_SIZE;)e.shift()}_checkRulesForKey(e,t){let r=this._fetchCpPromise;return 1!=this._cpFetched&&void 0!=r||(r=Promise.resolve()),r.then(r=>e==d.DateOptin?this._setDateOptin().then(r=>{this._checkCampaignService.checkRulesForKey(e,void 0,t).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))}).catch(e=>Promise.reject(e)):this._checkCampaignService.checkRulesForKey(e,void 0,t).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))).catch(e=>Promise.reject(e))}_setUserProfilItem(e,t,r){this._lsUserProfile.setItem(e,t),r&&(this._userProfilHasChanged=!0)}_removeUserProfilItem(e){this._lsUserProfile.removeItem(e),this._userProfilHasChanged=!0}_setValue(e,t,r,i){if(e==d.Optin){if(1==this._calledOptin)return Promise.resolve(!0);this._calledOptin=!0}if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);let s=this._lsUserProfile.getItem(e),n=!0;t=this._decodeValue(t),(void 0==s||s instanceof u&&s.data!=t)&&(this._userProfilHasChanged=!0),this._log("LS value for "+e+" : ",s);let a=new u(t);return void 0!=i&&(a.time=i),e==d.Optin&&(n=void 0!=s&&s==a.data),void 0==t&&(a=null),this._setUserProfilItem(e,a,!1),void 0==s&&(s=t),e==d.Optin&&n?Promise.resolve(s):this._checkRulesForKey(e,r).then(()=>(e!=d.Optin&&e!=d.DateOptin&&this._incrementActionExecuted(),Promise.resolve(s))).catch(e=>Promise.resolve(s))}_unsetValue(e,t){return this._log("Removing LS value for "+e),this._removeUserProfilItem(e),this._checkRulesForKey(e,t).then(()=>this._incrementActionExecuted()).catch(()=>this._incrementActionExecuted())}_callbackIncrementAndResolvValue(e){return()=>(this._incrementActionExecuted(),Promise.resolve(e))}_checkRulesForKeyThenIncrementThenResolvValue(e,t,r){return this._checkRulesForKey(e,r).then(this._callbackIncrementAndResolvValue(t)).catch(this._callbackIncrementAndResolvValue(t))}_decodeValue(e){return"string"==typeof e&&(e=Z.htmlSpecialCharsDecode(e))==e&&(e=Z.htmlEntitiesDecode(e)),e}_keyOrValueAreNotOk(e,t){return void 0==e||"null"==e||void 0==t||"null"==t}_addValue(e,t,r){if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);let i=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),i=this._addToMap(i,t),this._checkMap(i),this._log("LS values for "+e+" : ",i),this._setUserProfilItem(e,i,!1),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_removeValue(e,t,r){let i=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),i=this._removeFromMap(i,t),this._checkMap(i),this._log("LS values for "+e+" : ",i),this._setUserProfilItem(e,i,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_incrementValue(e,t,r){void 0==t&&(t=1);let i=this._lsUserProfile.getItem(e);return void 0==i&&(i=new u(0)),i.data+=t,this._log("LS value for "+e+" : ",i),this._setUserProfilItem(e,i,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_setIds(e){void 0==this._ids&&(k.saveIds(e),this._ids=k.getIds()),this._checkCampaignService.checkRulesForCheckAgainCampaigns()}_saveSubscription(){return K.saveSubscription()}_setDateOptin(){if(void 0!=this._dateOptin)return Promise.resolve();const e=k.getDateOptin();return void 0!=e?(this._dateOptin=e,Promise.resolve()):this._saveSubscription().then(e=>{const t=e.timestamp;return void 0!=t&&t>0&&(this.setValue(m.dateOptin().propertyKey,t),this._dateOptin=t),Promise.resolve()}).catch(e=>Promise.resolve())}_setOptinTrueIfNeeded(){return U.userIsOptin()?this._setValue(d.Optin,!0):Promise.resolve()}_incrementActionExecuted(e){this._nbOfActionsExecuted++,this._userProfilHasChanged&&(this._nbOfActionsExecuted>=this._nbOfActionsToExecute||e)&&this._userProfilService.sendProfilToAdrenalead()}directSetValue(e,t,r,i){this._setValue(e,t,r,i)}setValue(e,t,r,i){return U.whenServiceWorkerReadyDo(this._setValue.bind(this,e,t,r,i))}unsetValue(e,t){return U.whenServiceWorkerReadyDo(this._unsetValue.bind(this,e,t))}addValue(e,t,r){return U.whenServiceWorkerReadyDo(this._addValue.bind(this,e,t,r))}removeValue(e,t,r){return U.whenServiceWorkerReadyDo(this._removeValue.bind(this,e,t,r))}addLastPages(e,t){return this.addValue(m.lastPages().propertyKey,e,t)}incrementValue(e,t,r){return U.whenServiceWorkerReadyDo(this._incrementValue.bind(this,e,t,r))}setIds(e){return void 0!=e&&(e=e.trim()),this._incrementActionExecuted(),void 0==this._ids?(k.saveIds(e),this._ids=k.getIds(),U.canRunProgram().then(e=>{e?L.fetchCampaigns().then(e=>Promise.resolve(!0)).catch(e=>Promise.resolve(!1)):Promise.resolve(!0)}).catch(e=>Promise.resolve(!1))):U.whenServiceWorkerReadyDo(this._setIds.bind(this,e))}rmktIsActive(e){void 0==this._rmktIsActive&&(k.saveRmktIsActive(e),this._rmktIsActive=e)}_deleteOldTriggers(){return q.deleteValidatedCampaignsAndClean()}_deleteRmktProfil(){return this._userProfilService.deleteProfilRmktInAdrenalead()}optin(){const e=this;return e._deleteOldTriggers().then(t=>e._deleteRmktProfil()).then(t=>e._saveSubscription()).then(e=>this.setValue(d.Optin,!0)).catch(e=>{})}startOfActions(e){this._lsUserProfile.getAllItems(),this._nbOfActionsToExecute=e;const t=this;return U.whenServiceWorkerReadyDo(()=>(console.log("Start of actions"),t._fetchCpPromise=L.getCampaigns(),t._setOptinTrueIfNeeded(),t._fetchCpPromise.then(e=>{t._cpFetched=!0,t._setOptinTrueIfNeeded()}).catch(e=>{})))}incrementNbOfActions(e){void 0==this._nbOfActionsToExecute&&(this._nbOfActionsToExecute=0),this._nbOfActionsToExecute+=e}endOfActions(){this._checkCampaignService.sendRequestedCalls(),this._incrementActionExecuted(!0)}visitTriggers(e,t){return e?this.setValue(R.NadzLastVisit,Date.now(),t):Promise.resolve()}lastPageIsActive(e,t){const r=window.location.href;return e&&ce.isNotEmpty(r)?this.setValue(d.UrlLastPage,r,t):Promise.resolve()}setMontantConversion(e,t,r){let i=void 0;try{i=parseFloat(e)}catch(e){}return void 0!=i&&NaN!=i?this.setValue(d.MontantConversion,i,t,r):Promise.resolve()}setProduitsDansPanier(e,t){return this.setValue(d.ProduitsDansPanier,e,t)}purchased(e,t){return this.setValue(d.Purchased,e,t)}isAuthenticated(e,t){return this.setValue(d.IsAuthenticated,e,t)}}const $=new J;class Q{constructor(e,t,r){this.campaign=e,this.httpMethod=t,this.callback=r}getKey(){return this.httpMethod+"_"+this.campaign.campaignId}}class X{constructor(e){this.ids=e.ids,this.fIds=e.fIds,this.idv=e.idv,this.epi=e.epi,this.auth=e.auth,this.p256=e.p256,this.profil=e.profil}isNotOk(){return!this.isOk()}isOk(){return void 0!=this.ids&&void 0!=this.auth&&void 0!=this.p256&&void 0!=this.profil}}class ee{constructor(e){void 0==e&&(e={}),this.isMobile=e.isMobile,void 0==this.isMobile&&(this.isMobile=e.is_mobile),void 0==this.isMobile&&(this.isMobile=!1),this.browser=e.browser,this.listCountry=e.listCountry||e.list_country,this.cityName=e.cityName||e.city_name,this.postalCode=e.postalCode||e.postal_code,this.ids=e.ids,this.idsExclus=e.idsExclus||e.ids_exclus}getCitiesAsList(){return this.cityName.split(",")}getPostalCodes(){return this.postalCode.split(",")}}class te{constructor(e,t,r,i){this.body=e,this.icon=t,this.data=r,this.actions=i}toString(){let e="body="+this.body;return void 0!=this.icon&&(e+=this.icon),void 0!=this.data&&(e+=this.data),void 0!=this.actions&&(e+=this.actions.join("|")),e}static fromObject(e){return l.objectsHasSamePropertiesAs(e,te)?new te(e.body,e.icon,e.data,e.actions):null}}class re{constructor(e){void 0==e&&(e={}),this.tag=e.tag,this.data=e.data,this.time=e.time}static createFromTimedValue(e,t){if(!ce.isEmpty(e)&&void 0!=t&&!t.isNotOk())return new re({tag:e,data:t.data,time:t.time})}static createFromArrayOfTimedValue(e,t){if(!ce.isEmpty(e)&&!_.arrayIsUndefinedOrEmpty(t))return new re({tag:e,data:t,time:t[0].time})}}class ie{constructor(){this._externalCallService=new M(new oe,!1)}_callApi(e,t){return this._externalCallService.getResult(e,t)}_isAuthorizedToDoRmkt(e,t){const r=k.getRmktIsActive();return!U.userIsOptin()&&void 0!=e&&void 0!=e.idv&&1!=e.isFromRandom&&void 0!=t&&r}getOptinFromRmkt(){const e=k.getIdv(),t=k.getIds();return this._isAuthorizedToDoRmkt(e,t)?this._callApi(e.idv,t):(o.info("Tried to call optinFromRmkt but user is either optin, missing idv or ids or is not authorized"),Promise.resolve(void 0))}static getOptinFromRmkt(){return(new ie).getOptinFromRmkt()}static getOptinFromRmktAsPushSub(){return ie.getOptinFromRmkt().then(e=>{let t=void 0;return void 0!=e&&(t=h.fromOptinInfo(e)),Promise.resolve(t)}).catch(e=>Promise.resolve(void 0))}}var se,ne;!function(e){e.SAVE_OPTIN_INFO="save",e.GET_OPTIN_INFO="getOptinInfo",e.SAVE_MIGRATION="saveMigration",e.GET_MIGRATION="getMigration"}(se||(se={})),function(e){e.MIGRATION_ACTIVATED="migrationActivated",e.MIGRATION_TREATED="migrationTreated"}(ne||(ne={}));class ae{constructor(){}static _getIndexedDB(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB}static getOptinInfo(e){return void 0==e&&(e=k.getIds()),ae.handleIndexedDB(se.GET_OPTIN_INFO,{key:e})}static saveOptinInfo(e){return ae.handleIndexedDB(se.SAVE_OPTIN_INFO,e)}static saveMigration(e,t){return new Promise((r,i)=>{ae.getMigration(e).then(s=>{let n=0;void 0!=s&&void 0!=s.count&&(n=s.count),n++,ae.handleIndexedDB(se.SAVE_MIGRATION,{key:e,value:{value:t,time:Date.now(),count:n}}).then(e=>r(e)).catch(e=>i(e))}).catch(e=>i(e))})}static getMigration(e){return ae.handleIndexedDB(se.GET_MIGRATION,{key:e})}static handleIndexedDB(e,t){return new Promise((r,i)=>{const s="nadzOptinInfo",n="nadzMigration";try{var a=ae._getIndexedDB();if(a){const i="IndexedDB nadzOpti - ";var o=a.open("nadzOpti");o.onupgradeneeded=(e=>{console.log(i+"onupgradeneeded");var t=e.target.result;try{t.deleteObjectStore(s),t.deleteObjectStore(n)}catch(e){}t.createObjectStore(s,{keyPath:"ids"}).createIndex("ids","ids",{unique:!0}),t.createObjectStore(n,{keyPath:"key"}).createIndex("key","key",{unique:!0})}),o.onsuccess=(i=>{var a=i.target.result;function o(e,t){return a.transaction(e,t).objectStore(e)}function l(e){a.close(),r(e)}function u(e){return o(s,e)}function c(e){return o(n,e)}if(e==se.SAVE_OPTIN_INFO)u("readwrite").put(t),l(t);else if(e==se.GET_OPTIN_INFO){var h=u("readonly");(d=h.get(t.key)).onsuccess=(e=>{void 0!=d.result?l(d.result):l(void 0)}),d.onerror=(e=>{})}else if(e==se.SAVE_MIGRATION)c("readwrite").put(t),l(t);else if(e==se.GET_MIGRATION){var d;h=c("readonly");(d=h.get(t.key)).onsuccess=(e=>{void 0!=d.result?l(d.result.value):l(void 0)})}else l(void 0)}),o.onerror=(e=>{})}else r(void 0)}catch(e){r(void 0)}})}}class oe extends D{constructor(){super("NadzExternalCallRmkt",k.storageRmkt(),a.getCurrentConfig().configNotifadzApi),this._keyEndpoint="rmkt-opti"}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||2!=t.length)return S.getPromiseRejectForBadParameters();let r={idv:t[0],ids:t[1]};return Y.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{if("object"==typeof e){const t=e.result;return t.isFromRmkt=!0,new x(t)}}).catch(e=>void 0)}saveResultInLSFunc(e){let t=k.getPushSub();return void 0==t?t=h.fromOptinInfo(e):void 0!=e?(void 0!=e.auth&&void 0!=e.p256dh&&(t.keys=new c(e.auth,e.p256dh)),t.optinInfo=e):t.optinInfo=null,k.savePushSub(t),this._lsService.setItem(d.Optin,e),Promise.resolve()}getResultInLSFunc(){var e;return null===(e=k.getPushSub())||void 0===e?void 0:e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class le{static isMap(e){return void 0!=e&&e instanceof Map}static isNotMap(e){return!le.isMap(e)}static isEmpty(e){return void 0==e||e.size<1}static isNotEmpty(e){return!le.isEmpty(e)}}class ue{static greaterThan(e,t){return void 0!=e&&void 0!=t&&e>t}static greaterThanEquals(e,t){return void 0!=e&&void 0!=t&&e>=t}static lesserThan(e,t){return void 0!=e&&void 0!=t&&e<t}static lesserThanEquals(e,t){return void 0!=e&&void 0!=t&&e<=t}}class ce{static isEmpty(e){return void 0==e||e.length<1}static isNotEmpty(e){return!this.isEmpty(e)}static isEqualsIgnoreCase(e,t){return void 0!=e&&void 0!=t&&e.toUpperCase()==t.toUpperCase()}static isNotEqualsIgnoreCase(e,t){return!this.isEqualsIgnoreCase(e,t)}static includesIgnoreCase(e,t){return e.toUpperCase().includes(t.toUpperCase())}static includesNotIgnoreCase(e,t){return!this.includesIgnoreCase(e,t)}static startsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().startsWith(t.toLowerCase()))}static endsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().endsWith(t.toLowerCase()))}}class he{static _paramsNotOk(e,t){return!(void 0!=e&&!e.isNotOk()&&void 0!=t)}static compareTimedValueForSort(e,t){return e.time<t.time?-1:e.time>t.time?1:0}static valueIsOlderThan(e,t){return!this._paramsNotOk(e,t)&&ue.greaterThan(e.ageOfValueInMinutes(),t)}static valueIsOlderThanEquals(e,t){return!this._paramsNotOk(e,t)&&ue.greaterThanEquals(e.ageOfValueInMinutes(),t)}static valueIsSmallerThan(e,t){return!this._paramsNotOk(e,t)&&ue.lesserThan(e.ageOfValueInMinutes(),t)}static valueIsSmallerThanEquals(e,t){return!this._paramsNotOk(e,t)&&ue.lesserThanEquals(e.ageOfValueInMinutes(),t)}}window.nadzTrigClean=!0;var de,pe=(de=$,{startOfActions:function(e){return de.startOfActions(e)},setIds:function(e){return de.setIds(e)},rmktIsActive:function(e){return de.rmktIsActive(e)},unsetValue:function(e,t){return de.unsetValue(e,t)},setValue:function(e,t,r,i){return de.setValue(e,t,r,i)},addValue:function(e,t,r){return de.addValue(e,t,r)},removeValue:function(e,t,r){return de.removeValue(e,t,r)},addLastPage:function(e,t){return de.addLastPages(e,t)},incrementValue:function(e,t,r){return de.incrementValue(e,t,r)},optin:function(){return de.optin()},visitTriggers:function(e,t){return de.visitTriggers(e,t)},lastPageIsActive:function(e,t){return de.lastPageIsActive(e,t)},setMontantConversion:function(e,t,r){return de.setMontantConversion(e,t,r)},setProduitsDansPanier:function(e,t){return de.setProduitsDansPanier(e,t)},purchased:function(e,t){return de.purchased(e,t)},isAuthenticated:function(e,t){return de.isAuthenticated(e,t)},handleActions:function(e){if(void 0!=e&&e.shift&&e.length>0){const t=[];de.incrementNbOfActions(e.length);for(let r=0;r<e.length;r++){const i=e[r];if(void 0==i)continue;const s=i.shift();i.push(!0),t.push(this[s].apply(this,i))}Promise.all(t).then(e=>{de.endOfActions()}).catch(e=>{})}}});let ge=window[NADZ_TRIGGERS_ARRAY_NAME].length;const me="nadzIdv",ye="setIds",_e="rmktIsActive";function fe(){return ve("9"+(Date.now()+Math.round(window.performance.now()))+Math.floor(100*Math.random())+1,!0)}function ve(e,t){return{idv:e,isFromRandom:t,nadzTrigClean:window.nadzTrigClean}}window.addEventListener("nadzOptinEvent",e=>{if(void 0!=e&&void 0!=e.detail&&void 0!=e.detail.optinInfo){const t=e.detail.optinInfo;void 0!=t.idv&&Oe(t.idv),void 0!=pe&&void 0!=pe.optin&&pe.optin(),Pe(!0)}},!1);const Ie=[ye];function Ae(e){const t=e[0],r=e[1];t==NADZ_TRIGGERS_WELCOME_PUSH_ACTION&&!0===r&&(window[NADZ_TRIGGERS_WELCOME_PUSH_VAR]=!0)}function Ce(e){return new Promise((t,r)=>{if(e.shift){var i=e.shift();Ae(i,e[0]),t(pe[i].apply(pe,e))}})}function Te(e){if(void 0!=e)return JSON.parse(JSON.stringify(e))}function Pe(e){!function(){if(!(void 0==window[NADZ_TRIGGERS_ARRAY_NAME]||window[NADZ_TRIGGERS_ARRAY_NAME].length<1))for(var e=0;e<ge;e++){const t=window[NADZ_TRIGGERS_ARRAY_NAME][e],r=t[0],i=t[1];if(r==NADZ_TRIGGERS_TEST_ACTION){window[NADZ_TRIGGERS_TEST_ACTION]=i,window[NADZ_TRIGGERS_ARRAY_NAME].splice(e,1),ge--;break}}}();const t=["startOfActions",ge-1];1!=e?window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]=Te(window[NADZ_TRIGGERS_ARRAY_NAME]):window[NADZ_TRIGGERS_ARRAY_NAME]=Te(window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]),Ce(t).then(e=>{for(var t=0;t<ge;t++){const e=window[NADZ_TRIGGERS_ARRAY_NAME][t];e[0]==NADZ_TRIGGERS_WELCOME_PUSH_ACTION?Ae(e):Ce(e)}window[NADZ_TRIGGERS_ARRAY_NAME]=null}).catch(e=>{})}function Ee(){if(window[NADZ_TRIGGERS_ARRAY_NAME][0][0]==_e){const e=window[NADZ_TRIGGERS_ARRAY_NAME].shift();ge--,Ce(e).then(e=>Pe()).catch(e=>{})}else Pe()}function Se(){return new Promise((e,t)=>{new Promise((e,t)=>{window.nadzTrigAuthorized=!0,e(!0)}).then(t=>{(function(e,t=!1,r=!0){return new Promise(function(i,s){try{if(!t||t&&r){var n=document.getElementsByTagName("body")[0],a=document.createElement("iframe");n||(n=document.documentElement);var o=document.createElement("div");function l(e){var t=e.data;"object"==typeof t&&t.i&&i(t.i)}o.height="1px",o.width="1px",o.style.position="absolute",o.style.top="-42px",o.style.left="-42px",o.style.display="none",n.appendChild(o),a.src=e,a.id="nadz_iframec",a.name="nadz_iframec",a.height="1px",a.width="1px",a.style.position="absolute",a.style.top="-42px",a.style.left="-42px",o.appendChild(a),window.addEventListener?window.addEventListener("message",l,!1):window.attachEvent&&window.attachEvent("onmessage",l,!1),setTimeout(function(){n.removeChild(o),s()},2500)}else i(fe())}catch(e){console.log("Error : ",e)}})})("https://gjigle.com/cgp",window.nadzTrigClean,window.nadzTrigAuthorized).then(t=>{e(t)}).catch(t=>e(void 0)).catch(e=>{})})})}function Oe(e){let t=e;void 0==e.idv&&void 0==e.isFromRandom&&(t=ve(e,!1)),localStorage&&localStorage.setItem(me,JSON.stringify(t)),window[me]=t}function Re(){let e=function(){if(localStorage){const e=localStorage.getItem(me),t=JSON.parse(e);return window[me]=t,t}return{}}();return void 0!=e&&void 0!=e.idv&&e.idv.length>0&&(0==e.isFromRandom||!window.nadzTrigAuthorized)&&e.nadzTrigClean==window.nadzTrigClean}var we;return new Promise((e,t)=>{const r=[];new Promise((e,t)=>{for(var r=0;r<ge;r++)if(window[NADZ_TRIGGERS_ARRAY_NAME][r][0]==ye){const t=window[NADZ_TRIGGERS_ARRAY_NAME][r][1];void 0!=t&&t.length>0&&e(t.trim());break}void 0!=window.nadzIds&&window.nadzIds.length>0&&e(window.nadzIds.trim())}).then(e=>(e=e,new Promise((t,r)=>{try{fetch("https://notifpush.com/script_parameters/triggers/p_tr_"+e+".json",{method:"GET"}).then(e=>{if(e.ok)try{e.json().then(e=>{t(e._nAdzqTriggers)}).catch(e=>{t(!1)})}catch(e){t(!1)}else t(!1)}).catch(e=>{t(!1)})}catch(e){t(!1)}}))).then(t=>{0==t&&e(!1),t.forEach(e=>{const t=e[0];Ie.includes(t)||r.push(e)});const i=t.map(e=>e[0]);window[NADZ_TRIGGERS_ARRAY_NAME].forEach(e=>{const t=e[0];i.includes(t)&&"handleActions"!=t||r.push(e)});let s=r.find(e=>e[0]==_e);const n=r.find(e=>e[0]==ye);window[NADZ_TRIGGERS_ARRAY_NAME]=[],void 0==s&&(s=[_e,!1]),window[NADZ_TRIGGERS_ARRAY_NAME].push(s),void 0!=n&&window[NADZ_TRIGGERS_ARRAY_NAME].push(n);const a=[];a.push(_e),a.push(ye),r.forEach(e=>{a.includes(e[0])||window[NADZ_TRIGGERS_ARRAY_NAME].push(e)}),ge=window[NADZ_TRIGGERS_ARRAY_NAME].length,e(!0)}).catch(t=>e(!1))}).then(e=>{0!=e?"granted"!==Notification.permission?Re()?Ee():Se().then(e=>{void 0==e&&(e=fe()),Oe(e),Ee()}).catch(e=>{}):Ee():console.log("Triggers are probably not remotly activated")}).catch(e=>{}),{getNadzTriggerActions:function(){return pe}}}());