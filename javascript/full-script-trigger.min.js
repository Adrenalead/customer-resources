var NADZ_TRIGGERS_VERSION="2.1.0",NADZ_TRIGGERS_ARRAY_NAME="_nAdzqTriggers",NADZ_TRIGGERS_ARRAY_BACKUP_NAME="_nAdzqTriggersBackup",NADZ_TRIGGERS_WINDOW="NADZ_TRIGGERS",NADZ_TRIGGERS_WELCOME_PUSH_VAR="_nAdzqTriggers_welcomePush",NADZ_TRIGGERS_WELCOME_PUSH_ACTION="welcomePush",NADZ_TRIGGERS_TEST_ACTION="nadzTrigModeTest";null!=navigator&&"serviceWorker"in navigator&&null!=window&&"Notification"in window&&(window[NADZ_TRIGGERS_ARRAY_NAME]=window[NADZ_TRIGGERS_ARRAY_NAME]||[],window[NADZ_TRIGGERS_WINDOW]=window[NADZ_TRIGGERS_WINDOW]||function(){class F{constructor(e,t,r,s,i){this.base_url_dev=e,this.base_url_prod=t,this.baseApi=r,this.timeBetweenCall=s,this._initMapEndpoints(i)}_initMapEndpoints(e){null==e&&(e=new Map),this.endpointsApi=e}getApiBaseUrl(e){let t=this.base_url_dev;return e&&(t=this.base_url_prod),t+="/"+this.baseApi}getEndpointUrl(e,t){return this.getApiBaseUrl(e)+"/"+this.getEndpointConfig(t).endpoint}getEndpointWaitingTime(e){return this.getEndpointConfig(e).waitingTime}getEndpointConfig(e){return this.endpointsApi.get(e)}static fromObject(e){return new F(e.base_url_dev,e.base_url_prod,e.baseApi,e.timeBetweenCall,e.endpointsApi)}}var t,o,r,i,s,n,a,l,d,e;(e=t=t||{}).DEV="DEV",e.PROD="PROD";const G={base_url_dev:"http://127.0.0.1:3000",base_url_prod:"https://secure-apis.notifadz.com",baseApi:"notifadz-v2",timeBetweenCall:3e4,endpointsApi:new Map([["opti",{endpoint:"oi/opti",waitingTime:2e4}],["cp",{endpoint:"tr/cp-rules",waitingTime:18e5}],["rmkt-opti",{endpoint:"rmkt/opti",waitingTime:18e5}]])},L={base_url_dev:"https://secure-apis.notifadz.com",base_url_prod:"https://secure-apis.notifadz.com",baseApi:"api/v1",timeBetweenCall:3e4,endpointsApi:new Map([["rmkt-opti",{endpoint:"oi/rmkt",waitingTime:18e5}]])},U={base_url_dev:"https://secure-trig.notifadz.com",base_url_prod:"https://secure-trig.notifadz.com",baseApi:"triggers",timeBetweenCall:0,endpointsApi:new Map([["triggers",{endpoint:"",waitingTime:0}],["userProfil",{endpoint:"userProfil",waitingTime:0}]])};class u{constructor(e,t,r){this.timeBetweenSameTrigger=6e4,this.env=e,this.activateEncoding=t,this.activateLogging=r,this.arrayMaxSize=7,this.configNotifadzApi=F.fromObject(G),this.configOptinInfoApi=F.fromObject(L),this.configTriggersApi=F.fromObject(U)}envIsDev(){return u.envIsDev(this.env)}envIsProd(){return u.envIsProd(this.env)}getApiBaseUrl(e){return e.getApiBaseUrl(this.envIsProd())}getApiEpUrl(e,t){return e.getEndpointUrl(this.envIsProd(),t)}static envMatch(e,t){return e==t}static envIsDev(e){return null==e&&(e=this.ENV),this.envMatch(e,t.DEV)}static envIsProd(e){return null==e&&(e=this.ENV),this.envMatch(e,t.PROD)}static getConfigDev(){return new u(t.DEV,!1,!0)}static getConfigProd(){return new u(t.PROD,!1,!1)}static getCurrentConfig(){return this.envIsDev()?this.getConfigDev():this.envIsProd()?this.getConfigProd():null}static get ACTIVATE_ENCODING(){return this.getCurrentConfig().activateEncoding}static get ACTIVATE_LOG(){return this.getCurrentConfig().activateLogging}static get ARRAY_MAX_SIZE(){return this.getCurrentConfig().arrayMaxSize}}u.ENV=t.PROD;class c{static log(e,t){u.ACTIVATE_LOG&&(null==t?console.log(e):console.log(e,t))}static debug(e,t){u.ACTIVATE_LOG&&(null==t?console.debug(e):console.debug(e,t))}static info(e,t){u.ACTIVATE_LOG&&(null==t?console.info(e):console.info(e,t))}static warn(e,t){u.ACTIVATE_LOG&&(null==t?console.warn(e):console.warn(e,t))}static error(e,t){u.ACTIVATE_LOG&&(null==t?console.error(e):console.error(e,t))}static warnNotYetImplemented(e){this.warn(e+" is not yet implemented")}}class h{static checkObjectStructure(t,r,s){if(null==t||null==r)return!1;for(let e=0;e<r.length;e++){var i=r[e];if(!t.hasOwnProperty(i)&&(f.arrayIsUndefinedOrEmpty(s)||!s.includes(i)))return!1}return!0}static objectsHasSameProperties(e,t){t=Object.getOwnPropertyNames(t);return this.checkObjectStructure(e,t)}static objectsHasSamePropertiesAs(e,t,r){t=Object.getOwnPropertyNames(new t);return this.checkObjectStructure(e,t,r)}}class p{constructor(e,t,r){this.data=e,this.count=r,null==t&&(t=Date.now()),this.time=t}ageOfValueInMinutes(){return P.getElaspedTimeSinceNowInMinutes(this.time)}toString(){return this.data,this.time,",count="+this.count}isOk(){return null!=this.data&&null!=this.time&&0<this.time}isNotOk(){return!this.isOk()}getCount(){return null!=this.count&&0!=this.count||(this.count=1),this.count}static fromObject(e){return h.objectsHasSamePropertiesAs(e,p),p.ignorableFieldsForReviver()?new p(e.data,e.time,e.count):null}static ignorableFieldsForReviver(){return["count"]}}class g{constructor(e,t){this.auth=e,this.p256dh=t}isValid(){return null!=this.auth&&null!=this.p256dh}static fromObject(e){return h.objectsHasSamePropertiesAs(e,g)?new g(e.auth,e.p256dh):null}static objectsHasSamePropertiesAs(e){return null!=e.auth&&null!=e.p256dh&&2==Object.getOwnPropertyNames(e).length}}class m{constructor(e,t,r,s){this.endpoint=e||null,this.expirationTime=t||null,this.keys=r||null,this.optinInfo=s||null}isValid(){return null!=this.endpoint&&null!=this.keys&&this.keys.isValid()&&null!=this.optinInfo&&this.optinInfo.isValid()}isEqualTo(e){if(null==e)return!0;let t=void 0;return t=e instanceof PushSubscription?e.toJSON():e,this.endpoint==t.endpoint&&this.keys.auth==t.keys.auth&&this.keys.p256dh==t.keys.p256dh}isDifferentOf(e){return!this.isEqualTo(e)}getOptinInfo(){return this.optinInfo}hasOptinInfo(){return null!=this.getOptinInfo()}static fromObject(e){return h.objectsHasSamePropertiesAs(e,m)?new m(e.endpoint,e.expirationTime,e.keys,e.optinInfo):null}static fromPushSubscription(e){var t;return null!=e?(t=e.toJSON(),t=g.fromObject(t.keys),new m(e.endpoint,e.expirationTime,t,null)):null}static fromOptinInfo(e){var t;return null!=e?(t=new g(e.auth,e.p256dh),new m(e.endpoint,null,t,e)):null}static optinInfoIsNotOk(e){return null==e||!e.isValid()}}(e=o=o||{}).Optin="nadzOptin",e.DateOptin="nadzDateOptin",e.LastPages="nadzLastPages",e.LastProducts="nadzLastProducts",e.MontantConversion="nadzMontantConversion",e.ProduitsDansPanier="nadzProduitsDansPanier",e.UrlLastPage="nadzUrlLastPage",e.Purchased="nadzPurchased",e.IsAuthenticated="nadzIsAuthenticated",e.GeoCountryCode="nadzGeoCountryCode",e.GeoCountryName="nadzGeoCountryName",e.GeoPostalCode="nadzGeoPostalCode",e.GeoCityName="nadzGeoCityName",(e=r=r||{}).String="String",e.Number="Number",e.Boolean="Boolean",e.Date="Date",e.Array="Array",e.ArrayValueCount="ArrayValueCount",e.ArrayValueDate="ArrayValueDate",e.Audience="Audience";class y{constructor(e,t,r,s){this.id=e,this.propertyType=t,this.propertyKey=r,this.isGeneric=0|s}_isType(e){return this.propertyType==e}isPropertyGeneric(){return null!=this.isGeneric&&1==this.isGeneric}isTypeString(){return this._isType(r.String)}isTypeNumber(){return this._isType(r.Number)}isTypeBoolean(){return this._isType(r.Boolean)}isTypeDate(){return this._isType(r.Date)}isTypeArray(){return this._isType(r.Array)}isTypeArrayValueCount(){return this._isType(r.ArrayValueCount)}isTypeArrayValueDate(){return this._isType(r.ArrayValueDate)}isTypeAudience(){return this._isType(r.Audience)}toString(){return this.propertyType+"_"+this.propertyKey}static fromObject(e){return h.objectsHasSamePropertiesAs(e,y)?new y(e.id,e.propertyType,e.propertyKey,e.isGeneric):null}static ofTypeString(e){return new y(null,r.String,e)}static ofTypeNumber(e){return new y(null,r.Number,e)}static ofTypeBoolean(e){return new y(null,r.Boolean,e)}static ofTypeDate(e){return new y(null,r.Date,e)}static ofTypeArray(e){return new y(null,r.Array,e)}static dateOptin(){return this.ofTypeDate(o.DateOptin)}static lastPages(){return this.ofTypeArray(o.LastPages)}static lastProducts(){return this.ofTypeArray(o.LastProducts)}}(e=i=i||{}).Between="Between",e.Contains="Contains",e.ContainsNot="ContainsNot",e.StartsWith="StartsWith",e.EndsWith="EndsWith",e.Equals="Equals",e.Exist="Exist",e.GreaterThan="GreaterThan",e.GreaterThanEquals="GreaterThanEquals",e.Is="Is",e.IsNot="IsNot",e.LesserThan="LesserThan",e.LesserThanEquals="LesserThanEquals",e.NotEquals="NotEquals",e.NotExist="NotExist",e.Greatest="Greatest",e.Smallest="Smallest",e.Oldest="Oldest",e.Youngest="Youngest";class _{constructor(e,t,r,s){"undefined"===r&&(r=void 0),this.property=e,this.operator=t,this.matchingValue=r,this.subKey=s,this._initMatchingValue(r),this._checkMatchingValue()}_initMatchingValue(e){null!=e&&(this.propertyIsBoolean()?this.matchingValue="boolean"==typeof e?e:"true"==e:this.propertyIsTypeArray()&&!Array.isArray(e)&&"string"==typeof e?this.matchingValue=e.split(",").map(e=>e.trim()):this.propertyIsTypeNumber()||this.propertyIsTypeDate()||this.propertyIsTypeArrayValueCount()?this.matchingValue=Number(e):this.matchingValue=e)}_allowedMismatchTypes(){const e=new Map;return e.set(r.Date,"Number"),e.set(r.Audience,"String"),e.set(r.ArrayValueCount,"Number"),e}_getMatchingValueConstructorName(){return this.matchingValue.constructor.name}_checkMatchingValue(){null!=this.property&&null!=this.matchingValue&&this._allowedMismatchTypes().get(this.getPropertyType())!=this._getMatchingValueConstructorName()&&this.property.propertyType!=this.matchingValue.constructor.name&&c.error(`Type mismatch : property type = ${this.property}, matchingValue  type = `+this.matchingValue.constructor.name)}_operatorIs(e){return this.operator.toUpperCase()==e.toUpperCase()}getPropertyKey(){return this.property.propertyKey}getPropertyType(){return this.property.propertyType}propertyIsTypeString(){return this.property.isTypeString()}propertyIsTypeNumber(){return this.property.isTypeNumber()}propertyIsBoolean(){return this.property.isTypeBoolean()}propertyIsTypeDate(){return this.property.isTypeDate()}propertyIsTypeArray(){return this.property.isTypeArray()}propertyIsTypeArrayValueCount(){return this.property.isTypeArrayValueCount()}propertyIsTypeArrayValueDate(){return this.property.isTypeArrayValueDate()}propertyIsTypeAudience(){return this.property.isTypeAudience()}operatorIsBetween(){return this._operatorIs(i.Between)}operatorIsContains(){return this._operatorIs(i.Contains)}operatorIsContainsNot(){return this._operatorIs(i.ContainsNot)}operatorIsEndsWith(){return this._operatorIs(i.EndsWith)}operatorIsEquals(){return this._operatorIs(i.Equals)}operatorIsExists(){return this._operatorIs(i.Exist)}operatorIsGreaterThan(){return this._operatorIs(i.GreaterThan)}operatorIsGreaterThanEquals(){return this._operatorIs(i.GreaterThanEquals)}operatorIsIs(){return this._operatorIs(i.Is)}operatorIsIsNot(){return this._operatorIs(i.IsNot)}operatorIsLesserThan(){return this._operatorIs(i.LesserThan)}operatorIsLesserThanEquals(){return this._operatorIs(i.LesserThanEquals)}operatorIsNotEquals(){return this._operatorIs(i.NotEquals)}operatorIsNotExist(){return this._operatorIs(i.NotExist)}operatorIsStartsWith(){return this._operatorIs(i.StartsWith)}operatorIsGreatest(){return this._operatorIs(i.Greatest)}operatorIsSmallest(){return this._operatorIs(i.Smallest)}operatorIsOldest(){return this._operatorIs(i.Oldest)}operatorIsYoungest(){return this._operatorIs(i.Youngest)}isUsingPropertyKey(e){return this.getPropertyKey()==e}isUsingPropertyKeyOfService(e){return this.isUsingPropertyKey(e.keyOfProperty)}hasSameOperator(e){return this.operator==e}toString(){return this.property+" "+this.operator+" "+this.matchingValue}static fromObject(e){return h.objectsHasSamePropertiesAs(e,_,_.ignorableFieldsForReviver())?new _(e.property,e.operator,e.matchingValue,e.subKey):null}static ignorableFieldsForReviver(){return["subKey"]}static lastProducts(e,t){return new _(y.lastProducts(),e,t)}static lastProductsContains(e){return this.lastProducts(i.Contains,e)}static lastProductsExists(e){return this.lastProducts(i.Exist,e)}static lastPages(e,t){return new _(y.lastPages(),e,t)}static lastPageStartWith(e){return this.lastPages(i.StartsWith,e)}static lastPageEndWith(e){return this.lastPages(i.EndsWith,e)}static lastPageEquals(e){return this.lastPages(i.Equals,e)}static lastPageContains(e){return this.lastPages(i.Contains,e)}}class f{static createArrayFromMap(e){if(N.isEmpty(e))return[];const t=[];for(const r of e)t.push(r);return t}static createArrayFromMapValues(e){if(N.isEmpty(e))return[];const t=[];for(const r of e)t.push(r[1]);return t}static deepCopyArray(e){return JSON.parse(JSON.stringify(e))}static arrayIsUndefinedOrEmpty(e){return e instanceof Map?null==e||0==e.size:null==e||null==e.length||0==e.length}static arrayIsNotEmpty(e){return!this.arrayIsUndefinedOrEmpty(e)}static sameArrays(e,t){return!this.arrayIsUndefinedOrEmpty(e)&&!this.arrayIsUndefinedOrEmpty(t)&&JSON.stringify(e)===JSON.stringify(t)}static notSameArrays(e,t){return!this.sameArrays(e,t)}static _arrayIsNotOk(e,t){return this.arrayIsUndefinedOrEmpty(e)||this.arrayIsUndefinedOrEmpty(t)||e.length<t.length}static arrayStartsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;e=e.slice(0,t.length);return this.sameArrays(e,t)}static arrayEndsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;let r=this.deepCopyArray(e),s=this.deepCopyArray(t);return this.arrayStartsWithExpectedArray(r.reverse(),s.reverse())}static arrayContainsExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;const r=this.lowerCaseOfStringValues(e);return t.forEach(e=>{let t=e;if("string"==typeof e&&(t=e.toLowerCase()),!r.includes(t))return!1}),!0}static lowerCaseOfStringValues(e){return e.map(e=>"string"==typeof e?e.toLowerCase():e)}static arrayContainsNotExpectedArray(e,t){return!this.arrayContainsExpectedArray(e,t)}static isNotEmptyEvenFirstItem(e){return this.arrayIsNotEmpty(e)&&b.isNotEmpty(e[0])}static containsStringIgnoreCase(e,t){return e.filter(e=>b.isNotEmpty(e)).map(e=>e.toUpperCase()).includes(t.toUpperCase())}static containsNotStringIgnoreCase(e,t){return!this.containsStringIgnoreCase(e,t)}}class x{static isTheGreatest(t,e){if(f.arrayIsUndefinedOrEmpty(t)||null==e||e.count<1)return!1;let r=0;for(let e=0;e<t.length;e++){var s=t[e];null!=s&&s.count>r&&(r=s.count)}return e.count>=r}static isTheSmallest(t,e){if(f.arrayIsUndefinedOrEmpty(t)||null==e)return!1;let r=e.count;for(let e=0;e<t.length;e++){var s=t[e];null!=s&&s.count<r&&(r=s.count)}return e.count<=r}static isTheOldest(t,e){if(f.arrayIsUndefinedOrEmpty(t)||null==e)return!1;let r=e.time;for(let e=0;e<t.length;e++){var s=t[e];null!=s&&s.time<r&&(r=s.time)}return e.time<=r}static isTheYoungest(t,e){if(f.arrayIsUndefinedOrEmpty(t)||null==e)return!1;let r=e.time;for(let e=0;e<t.length;e++){var s=t[e];null!=s&&s.time>r&&(r=s.time)}return e.time>=r}}class B{constructor(e){this._keyOfProperty=e,this._valueOfProperty=this._fetchValueOfProperty()}get keyOfProperty(){return this._keyOfProperty}get valueOfProperty(){return this._valueOfProperty}_fetchValueOfProperty(){if(this._keyOfProperty==o.DateOptin){var e=T.getPushSub();if(null!=e&&null!=e.optinInfo)return new p(e.optinInfo.timestamp,e.optinInfo.timestamp)}e=T.storageUserProfile().getItem(this._keyOfProperty);let t=void 0;return null!=(t=null!=e&&N.isNotMap(e)?p.fromObject(e):t)&&this._keyOfProperty==o.DateOptin&&(t.data=t.time),t=null==t?e:t}_getCurrentValueAsArray(){return f.createArrayFromMapValues(this._valueOfProperty)}_getCurrentSubKeyValue(t){return this._getCurrentValueAsArray().find(e=>e.data==t)}_sortArrayOfTimedValues(e){return e.sort((e,t)=>pe.compareTimedValueForSort(e,t))}_getCurrentValueAsArrayOfData(e=!0){let t=this._getCurrentValueAsArray();return e&&(t=this._sortArrayOfTimedValues(t)),Array.isArray(t)?t.map(e=>e.data):[]}_getCurrentValueAsTimedValue(){return this._valueOfProperty}_getCurrentValueData(){var e=this._getCurrentValueAsTimedValue();if(null!=e)return e.data}_getCurrentValueTime(){var e=this._getCurrentValueAsTimedValue();if(null!=e)return e.time}_checkRuleForOperator(e,t){return e.operator.toUpperCase()==t.toUpperCase()&&e.isUsingPropertyKey(this._keyOfProperty)}_logCheck(e,t,r){}_checkStartsWith(e){var t,r=i.StartsWith;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.arrayStartsWithExpectedArray(t,e.matchingValue)):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.startsWithIgnoreCase(t,e.matchingValue)):(c.warn("Check starts with not implemented for the type ",e.getPropertyType()),!1))}_checkEndsWith(e){var t,r=i.EndsWith;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.arrayEndsWithExpectedArray(t,e.matchingValue)):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.endsWithIgnoreCase(t,e.matchingValue)):(c.warn("Check ends with not implemented for the type ",e.getPropertyType()),!1))}_checkEquals(e){var t,r=i.Equals;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.sameArrays(t,e.matchingValue)):e.propertyIsBoolean()||e.propertyIsTypeNumber()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),t==e.matchingValue):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.isEqualsIgnoreCase(t,e.matchingValue)):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count==e.matchingValue:(c.warn("Check equals not implemented for the type ",e.getPropertyType()),!1))}_checkNotEquals(e){var t,r=i.NotEquals;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.notSameArrays(t,e.matchingValue)):e.propertyIsBoolean()||e.propertyIsTypeNumber()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),t!=e.matchingValue):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.isNotEqualsIgnoreCase(t,e.matchingValue)):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count!=e.matchingValue:(c.warn("Check equals not implemented for the type ",e.getPropertyType()),!1))}_checkContains(e){var t,r=i.Contains;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.arrayContainsExpectedArray(t,e.matchingValue)):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.includesIgnoreCase(t,e.matchingValue)):(c.warn("Check contains not implemented for the type ",e.getPropertyType()),!1))}_checkContainsNot(e){var t,r=i.ContainsNot;return!!this._checkRuleForOperator(e,r)&&(e.propertyIsTypeArray()?(t=this._getCurrentValueAsArrayOfData(),this._logCheck(r,t,e),f.arrayContainsNotExpectedArray(t,e.matchingValue)):e.propertyIsTypeString()?(t=this._getCurrentValueData(),this._logCheck(r,t,e),b.includesNotIgnoreCase(t,e.matchingValue)):(c.warn("Check containsNot not implemented for the type ",e.getPropertyType()),!1))}_checkExist(e){var t=i.Exist;if(!this._checkRuleForOperator(e,t))return c.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),null!=r&&(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>null!=e),f.arrayIsNotEmpty(r)):e.propertyIsTypeString()?b.isNotEmpty(r.data)&&"null"!=r.data:null!=r.data)}_checkNotExist(e){var t=i.NotExist;if(!this._checkRuleForOperator(e,t))return c.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),null==r||(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>null!=e),f.arrayIsUndefinedOrEmpty(r)):e.propertyIsTypeString()?b.isEmpty(r.data):null==r.data)}_checkGreaterThan(e){var t=i.GreaterThan;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),e.propertyIsTypeNumber()?null!=r&&k.greaterThan(r.data,e.matchingValue):e.propertyIsTypeDate()?pe.valueIsOlderThan(r,e.matchingValue):e.propertyIsTypeArray()?(t=this._getCurrentValueAsArray(),f.arrayIsNotEmpty(t)&&t.length>e.matchingValue):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count>e.matchingValue:(c.warn("Check greaterThan not implemented for the type ",e.getPropertyType()),!1)}_checkGreaterThanEquals(e){var t=i.GreaterThanEquals;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),e.propertyIsTypeNumber()?null!=r&&k.greaterThanEquals(r.data,e.matchingValue):e.propertyIsTypeDate()?pe.valueIsOlderThanEquals(r,e.matchingValue):e.propertyIsTypeArray()?(t=this._getCurrentValueAsArray(),f.arrayIsNotEmpty(t)&&t.length>=e.matchingValue):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count>=e.matchingValue:(c.warn("Check greaterThanEquals not implemented for the type ",e.getPropertyType()),!1)}_checkLesserThan(e){var t=i.LesserThan;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),e.propertyIsTypeNumber()?null!=r&&k.lesserThan(r.data,e.matchingValue):e.propertyIsTypeDate()?pe.valueIsSmallerThan(r,e.matchingValue):e.propertyIsTypeArray()?(t=this._getCurrentValueAsArray(),f.arrayIsNotEmpty(t)&&t.length<e.matchingValue):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count<e.matchingValue:(c.warn("Check LesserThan not implemented for the type ",e.getPropertyType()),!1)}_checkLesserThanEquals(e){var t=i.LesserThanEquals;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),e.propertyIsTypeNumber()?null!=r&&k.lesserThanEquals(r.data,e.matchingValue):e.propertyIsTypeDate()?pe.valueIsSmallerThanEquals(r,e.matchingValue):e.propertyIsTypeArray()?(t=this._getCurrentValueAsArray(),f.arrayIsNotEmpty(t)&&t.length<=e.matchingValue):e.propertyIsTypeArrayValueCount()?null!=(r=this._getCurrentSubKeyValue(e.subKey))&&r.count<=e.matchingValue:(c.warn("Check LesserThanEquals not implemented for the type ",e.getPropertyType()),!1)}_checkGreatest(e){var t=i.Greatest;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsArray(),s=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?x.isTheGreatest(r,s):(c.warn("Check _checkGreatest not implemented for the type ",e.getPropertyType()),!1)}_checkSmallest(e){var t=i.Smallest;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsArray(),s=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?x.isTheSmallest(r,s):(c.warn("Check _checkSmallest not implemented for the type ",e.getPropertyType()),!1)}_checkOldest(e){var t=i.Oldest;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsArray(),s=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?x.isTheOldest(r,s):(c.warn("Check _checkOldest not implemented for the type ",e.getPropertyType()),!1)}_checkYoungest(e){var t=i.Youngest;if(!this._checkRuleForOperator(e,t))return!1;var r=this._getCurrentValueAsArray(),s=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?x.isTheYoungest(r,s):(c.warn("Check _checkYoungest not implemented for the type ",e.getPropertyType()),!1)}_checkIs(e){var t=i.Is,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?S.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(null==e)return Promise.resolve(!1);{const t=new J(e);return t.rulesAreValidated()}}).catch(e=>Promise.resolve(!1)):(c.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(c.info("Rule and operator are different"),Promise.resolve(!1))}_checkIsNot(e){var t=i.IsNot,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?S.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(null==e)return Promise.resolve(!1);{const t=new J(e);return t.rulesAreNotValidated()}}).catch(e=>Promise.resolve(!1)):(c.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(c.info("Rule and operator are different"),Promise.resolve(!1))}_ruleToString(e){let t=this._valueOfProperty;return t instanceof Array&&1<t.length&&(t=(t="[")+this._valueOfProperty.join("|")+"]"),"prop key = "+this._keyOfProperty+", value = "+t+", rule = "+e}ruleMatchProperty(e){if(this._keyOfProperty!=e.getPropertyKey())return Promise.resolve(!1);let t=Promise.resolve(!1);var r;return e.operatorIsStartsWith()?t=Promise.resolve(this._checkStartsWith(e)):e.operatorIsEndsWith()?t=Promise.resolve(this._checkEndsWith(e)):e.operatorIsEquals()?t=Promise.resolve(this._checkEquals(e)):e.operatorIsNotEquals()?t=Promise.resolve(this._checkNotEquals(e)):e.operatorIsContains()?t=Promise.resolve(this._checkContains(e)):e.operatorIsContainsNot()?t=Promise.resolve(this._checkContainsNot(e)):e.operatorIsExists()?(r=this._checkExist(e),t=Promise.resolve(r)):e.operatorIsNotExist()?t=Promise.resolve(this._checkNotExist(e)):e.operatorIsGreaterThan()?t=Promise.resolve(this._checkGreaterThan(e)):e.operatorIsGreaterThanEquals()?t=Promise.resolve(this._checkGreaterThanEquals(e)):e.operatorIsIs()?t=this._checkIs(e):e.operatorIsIsNot()?t=this._checkIsNot(e):e.operatorIsLesserThan()?t=Promise.resolve(this._checkLesserThan(e)):e.operatorIsLesserThanEquals()?t=Promise.resolve(this._checkLesserThanEquals(e)):e.operatorIsGreatest()?t=Promise.resolve(this._checkGreatest(e)):e.operatorIsSmallest()?t=Promise.resolve(this._checkSmallest(e)):e.operatorIsOldest()?t=Promise.resolve(this._checkOldest(e)):e.operatorIsYoungest()&&(t=Promise.resolve(this._checkYoungest(e))),t}static from(e){return new B(e.getPropertyKey())}}class I{constructor(e,t,r,s,i,n,a,o,l,u,c){this.campaignId=e,this.name=t,this.rules=r,this._initAllRulesNeedToMatch(s),this._initTriggerDelay(i),this._initIsInstant(n),this.waitingTimeInDaysBetweenPushes=a||1,this.pushContent=o,this.ciblage=l,this.startHour=u,this.endHour=c}_initAllRulesNeedToMatch(e){this.allRulesNeedToMatch=e=null==e?!0:e}_initTriggerDelay(e){this.triggerDelayInMinutes=e=null==e?0:e}_initIsInstant(e){this.isInstant=e=null==e?!0:e}_getLogPrefix(e){return this.constructor.name+" - "+e}getId(){return this.campaignId.toString()}getTriggerDelayInMillis(){return P.minutesToMillis(this.triggerDelayInMinutes)}toString(){return`name=${this.name}, triggerDelayInMinutes=${this.triggerDelayInMinutes}, isInstant=${this.isInstant}, 
                waitingTimeInDaysBetweenPushes=${this.waitingTimeInDaysBetweenPushes}, rules=${this.rules}, pushContent=`+this.pushContent}isUsingPropertyKey(e){return K.atLeastOneRuleUsingPropertyKey(this.rules,e)}canBeUpdated(){return null!=this.waitingTimeInDaysBetweenPushes&&0<=this.waitingTimeInDaysBetweenPushes}hasTimeTable(){return b.isNotEmpty(this.startHour)&&b.isNotEmpty(this.endHour)}static ignorableFieldsForReviver(){return["ciblage","pushContent"]}static fromObject(e){return h.objectsHasSamePropertiesAs(e,I,I.ignorableFieldsForReviver())?new I(e.campaignId,e.name,e.rules,e.allRulesNeedToMatch,e.triggerDelayInMinutes,e.isInstant,e.waitingTimeInDaysBetweenPushes,e.pushContent,e.ciblage,e.startHour,e.endHour):null}}class v{constructor(e,t){this.title=e,this.options=t}toString(){return`title=${this.title}, options=`+this.options}static fromObject(e){return h.objectsHasSamePropertiesAs(e,v)?new v(e.title,e.options):null}static newPushContent(e,t,r,s,i){t=new le(t,r,s,i);return new v(e,t)}}const A={HOME:"home",PRODUITS:"produits",PRODUIT_A:"produitA",PRODUIT_B:"produitB",PANIER:"panier"};class K{static lastProductsContains_A(){var e=[A.PRODUIT_A];return _.lastProductsContains(e)}static lastProductsContains_B(){var e=[A.PRODUIT_B];return _.lastProductsContains(e)}static lastProductsExists(){return _.lastProductsExists(null)}static testLastPagesStartWith_home_produits_produitA(){var e=[A.HOME,A.PRODUITS,A.PRODUIT_A];return _.lastPageStartWith(e)}static testLastPagesEndWith_home_produits_panier(){var e=[A.HOME,A.PRODUITS,A.PANIER];return _.lastPageEndWith(e)}static testLastPagesEquals(){var e=[A.HOME,A.PRODUITS,A.PRODUIT_B,A.PRODUITS,A.PANIER];return _.lastPageEquals(e)}static testLastPagesContains_A_B(){var e=[A.PRODUIT_A,A.PRODUIT_B];return _.lastPageContains(e)}static getRulesUsingPropertyKey(e,t){let r=[];return e.forEach(e=>{e.isUsingPropertyKey(t)&&r.push(e)}),r}static atLeastOneRuleUsingPropertyKey(t,r){var s;let i=[];for(let e=0;e<t.length;e++){const n=t[e];if(n.isUsingPropertyKey(r))return Promise.resolve(!0);n.propertyIsTypeAudience()&&(s=S.getNestedAudienceByIdString(n.getPropertyKey()),i.push(s))}return Promise.all(i).then(e=>{let t=[];return e.forEach(e=>{e=this.atLeastOneRuleUsingPropertyKey(e.rules,r);t.push(e)}),t}).then(e=>Promise.all(e).then(t=>{for(let e=0;e<t.length;e++)if(1==t[e])return!0;return!1}).catch(e=>!1)).catch(e=>!1)}static operatorExist(e){return Object.keys(i).map(e=>e.toLowerCase()).includes(e.toLowerCase())}static getRulesUsingAudience(e){return e.filter(e=>e.propertyIsTypeAudience())}static getNestedAudiencesIds(e){return this.getRulesUsingAudience(e).map(e=>e.getPropertyKey()).map(e=>parseInt(e))}}class z{constructor(e){this.id=(e=null==e?{}:e).id,this.campaignId=e.campaignId,this.name=e.name,this.rules=e.rules,this._initAllRulesNeedToMatch(e.allRulesNeedToMatch),this._initIsInstant(e.isInstant),this.pushContent=e.pushContent}_initAllRulesNeedToMatch(e){this.allRulesNeedToMatch=e=null==e?!0:e}_initIsInstant(e){this.isInstant=e=null==e?!0:e}getId(){return this.id.toString()}toString(){return`id=${this.id}, campaignId=${this.campaignId}, name=${this.name}, isInstant=${this.isInstant}, 
                rules=${this.rules}, pushContent=`+this.pushContent}isUsingPropertyKey(e){return K.atLeastOneRuleUsingPropertyKey(this.rules,e)}static ignorableFieldsForReviver(){return["pushContent"]}}class H{constructor(e){this.campaigns=(e=null==e?{}:e).campaigns,this.nestedAudiences=e.nestedAudiences}}class C{static get badParametersMsg(){return"Bad parameters"}static get badCiblageMsg(){return"Bad ciblage"}static getPromiseRejectForBadParameters(r=this.badParametersMsg){return new Promise((e,t)=>{t(r)})}static getPromiseRejectForBadCiblage(r=this.badCiblageMsg){return new Promise((e,t)=>{t(r)})}static utf8_to_b64(e){if(e)return window.btoa(unescape(encodeURIComponent(e)))}static b64_to_utf8(e){if(e)return decodeURIComponent(escape(window.atob(e)))}static replacer(e,t){e=this[e];return e instanceof Map?{dataType:"Map",value:f.createArrayFromMap(e)}:t}static reviver(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.value);if(h.objectsHasSamePropertiesAs(t,p,p.ignorableFieldsForReviver()))return p.fromObject(t);if(h.objectsHasSamePropertiesAs(t,I,I.ignorableFieldsForReviver()))return I.fromObject(t);if(h.objectsHasSamePropertiesAs(t,z,z.ignorableFieldsForReviver()))return new z(t);if(h.objectsHasSamePropertiesAs(t,y))return y.fromObject(t);if(h.objectsHasSamePropertiesAs(t,v))return v.fromObject(t);if(h.objectsHasSamePropertiesAs(t,le))return le.fromObject(t);if(h.objectsHasSamePropertiesAs(t,_,_.ignorableFieldsForReviver()))return _.fromObject(t);if(h.objectsHasSamePropertiesAs(t,m))return m.fromObject(t);if("keys"==e&&g.objectsHasSamePropertiesAs(t))return g.fromObject(t);if(h.objectsHasSamePropertiesAs(t,O,O.ignorableFieldsForReviver()))return new O(t);if(h.objectsHasSamePropertiesAs(t,oe))return new oe(t);if(h.objectsHasSamePropertiesAs(t,H))return new H(t)}return t}static checkRecusivite(e,t,r){let s=window[e]||{count:1,timeFirstCall:Date.now()},i=(s.count++,window[e]=s,P.getElaspedTimeSinceNowInSeconds(s.timeFirstCall));return i<1&&(i=1),!(t<s.count/i&&i>r)}static deleteGlobalVarRecursivite(e){window[e]=void 0}}(e=s=s||{}).UserProfile="nadzUserProfile",e.Campaigns="nadzCampaigns",e.ValidatedCampaigns="nadzValidatedCampaigns",e.CampaignsToCheckAgain="nadzCheckAgain",e.TriggersSended="nadzTriggersSended",e.ProfilSended="nadzProfilSended",e.Idv="nadzIdv",e.Rmkt="nadzRmkt",(e=n=n||{}).Ids="nadzIds",e.PushSubscription="nadzPushSubscription",e.NadzLastVisit="nadzLastVisit",e.RmktIsActive="nadzRmktIsActive";class T{constructor(e){this._rootKey=e}getRootKey(){return T.ENCODE?this.encode(this._rootKey):this._rootKey}_getRootItem(){if(null==this._rootItem){let e=localStorage.getItem(this.getRootKey());null==(e=null!=e&&T.ENCODE?this.decode(e):e)?this._rootItem=new Map:this._rootItem=JSON.parse(e,C.reviver)}return this._rootItem}_setRootItem(e){this._saveRootItemInStorage(e),this._rootItem=e}_saveRootItemInStorage(e){null==e&&(e=this._rootItem);let t=JSON.stringify(e,C.replacer);T.ENCODE&&(t=this.encode(t)),localStorage.setItem(this.getRootKey(),t)}_setItem(e,t){this._getRootItem().set(e,t)}_deleteItem(e){this._getRootItem().delete(e)}encode(e){return C.utf8_to_b64(e)}decode(e){return C.b64_to_utf8(e)}getItem(e){let t=this._getRootItem();return t.has(e)?t.get(e):null}hasItem(e){return null!=this.getItem(e)}getAllItems(){return this._getRootItem()}setItems(e){this._saveRootItemInStorage(e)}setItem(e,t){this._setItem(e,t),this._saveRootItemInStorage()}removeItem(e){this._deleteItem(e),this._saveRootItemInStorage()}clearItems(){this._setRootItem(new Map)}static storageUserProfile(){return null==T.instanceUserProfile&&(T.instanceUserProfile=new T(s.UserProfile)),T.instanceUserProfile}static storageRmkt(){return new T(s.Rmkt)}static storageRmktGetOptinInfo(){return T.storageRmkt().getItem(o.Optin)}static storageCampaigns(){return null==T._iCampaigns&&(T._iCampaigns=new T(s.Campaigns)),T._iCampaigns}static storageValidatedCampaigns(){return new T(s.ValidatedCampaigns)}static storageCheckAgain(){return new T(s.CampaignsToCheckAgain)}static storageTriggersSended(){return new T(s.TriggersSended)}static saveCommonKey(e,t){this.storageUserProfile().setItem(e,t)}static saveIds(e){this.saveCommonKey(n.Ids,e)}static getIds(){let e=this.storageUserProfile().getItem(n.Ids);return b.isEmpty(e)&&(e=window[n.Ids],b.isNotEmpty(e)&&this.saveIds(e)),e}static getIdv(){var e=localStorage.getItem(s.Idv);let t=JSON.parse(e);return null==t&&null!=(e=window[s.Idv])&&(this.saveIdv(e),t=e),t}static saveIdv(e){null!=e&&localStorage.setItem(s.Idv,JSON.stringify(e))}static saveRmktIsActive(e=!0){this.saveCommonKey(n.RmktIsActive,e)}static getRmktIsActive(){return this.storageUserProfile().getItem(n.RmktIsActive)}static getDateOptin(){return this.storageUserProfile().getItem(o.DateOptin)}static getPushSub(){return this.storageUserProfile().getItem(n.PushSubscription)}static savePushSub(e){c.log("Saving subscription",e),this.saveCommonKey(n.PushSubscription,e)}static clearAll(t=!1){c.log("Clearing all local storage");const r=[s.Rmkt];Object.keys(s).forEach(e=>{r.includes(s[e])||t&&e==s.Campaigns||localStorage.removeItem(s[e])})}static clearItems(e){c.log("Clearing items in "+e.getRootKey()),e.clearItems()}static clearItemsInCheckAgainAndValidatedCampaigns(){this.clearItems(this.storageValidatedCampaigns()),this.clearItems(this.storageCheckAgain())}}T.ENCODE=u.ACTIVATE_ENCODING;class P{static getElapsedTime(e,t){return(e=null==e?0:e)-(t=null==t?0:t)}static getElapsedTimeBetweenDates(e,t){return this.getElapsedTime(e.getTime(),t.getTime())}static getElaspedTimeSinceNow(e){return this.getElapsedTime(Date.now(),e)}static getElaspedTimeSinceNowInSeconds(e){e=this.getElaspedTimeSinceNow(e);return this.millisToSeconds(e)}static getElaspedTimeSinceNowInMinutes(e){e=this.getElaspedTimeSinceNow(e);return this.millisToMinutes(e)}static getElaspedTimeSinceNowForDate(e){return this.getElapsedTimeBetweenDates(new Date,e)}static getTimeInSeconds(e){return(e=null==e?0:e)/1e3}static getTimeInMinutes(e){return this.getTimeInSeconds(e)/60}static getTimeInHours(e){return this.getTimeInMinutes(e)/60}static getTimeInDays(e){return this.getTimeInHours(e)/24}static millisToSeconds(e){return(e=null==e?0:e)/1e3}static secondsToMinutes(e){return(e=null==e?0:e)/60}static millisToMinutes(e){return this.secondsToMinutes(this.millisToSeconds(e=null==e?0:e))}static secondsToMillis(e){return 1e3*(e=null==e?0:e)}static minutesToMillis(e){return this.secondsToMillis(60*(e=null==e?0:e))}static hoursToMillis(e){return this.minutesToMillis(60*(e=null==e?0:e))}static daysToMillis(e){return this.hoursToMillis(24*(e=null==e?0:e))}static addDays(e,t){return e.setDate(e.getDate()+t),e}static addHours(e,t){return e.setHours(e.getHours()+t),e}static stringMatchesFormatHoursMinutes(e){return null!=e&&null!=e.match(/^[0-9]{2}:[0-9]{2}$/gm)}static getHoursFromStringHoursMinutes(e){try{return parseInt(e.substring(0,2))}catch(e){return-1}}static getMinutesFromStringHoursMinutes(e){try{return parseInt(e.substring(3,5))}catch(e){return-1}}static getSumOfMinutesFromStringHoursMinutes(e){var t=this.getHoursFromStringHoursMinutes(e),e=this.getMinutesFromStringHoursMinutes(e);return-1==t||-1==e?-1:60*t+e}static getMinutesFromHoursMinutesOfDate(e){try{return 60*e.getHours()+e.getMinutes()}catch(e){return-1}}static hoursAndMinutesAreAfterGivenOnes(e,t){e=this.getMinutesFromHoursMinutesOfDate(e);return this.getSumOfMinutesFromStringHoursMinutes(t)<e}static hoursAndMinutesAreBeforeGivenOnes(e,t){return this.getMinutesFromHoursMinutesOfDate(e)<this.getSumOfMinutesFromStringHoursMinutes(t)}static hoursAndMinutesAreBetweenGivenOnes(e,t,r){return this.hoursAndMinutesAreAfterGivenOnes(e,t)&&this.hoursAndMinutesAreBeforeGivenOnes(e,r)}}class E{constructor(e,t=!1){this._LOG=!1,this._lsService=e.getLocalStorageService(),this._waitingTimeBetweenCalls=e.getWaitingTime(),this._lastCallKeySuffix=e.getLastCallKeySuffix(),this._externalCall=e,this._delayFirstCall=t}_log(e,t){this._LOG&&c.log(e,t)}_info(e,t){this._LOG&&c.info(e,t)}_isFirstCall(){return 0==this._getLastCall()}_getLastCall(){let e=this._lsService.getItem(this._getLastCallFullKey());return e=null==e?0:e}_getLastCallFullKey(){return E.LAST_CALL_KEY+this._lastCallKeySuffix}_setLastCall(e){this._lsService.setItem(this._getLastCallFullKey(),e)}_updateLastCallToNow(){var e=this._lsService.getRootKey();this._log("Updating lastCall to now for "+e),this._setLastCall(Date.now())}_getElapsedTimeSinceLastCall(){return this._noWaitingTime()?(this._info("No waiting time"),1):P.getElaspedTimeSinceNow(this._getLastCall())}_waitingTimeIsExceeded(){if(this._isFirstCall()&&this._delayFirstCall)return this._log("Delaying first call"),this._updateLastCallToNow(),!1;var e=this._getElapsedTimeSinceLastCall();return this._log("Elapsed waiting time (in seconds) = ",P.getTimeInSeconds(e)),e>this._waitingTimeBetweenCalls}_noWaitingTime(){return 0==this._waitingTimeBetweenCalls}_callExternalApi(...e){return this._log("Fetching remotly : "+this._externalCall.constructor.name),this._noWaitingTime()||this._updateLastCallToNow(),this._externalCall.externalCallFunc(e)}_externalCondition(...e){return null!=this._externalCall.conditionnalCallFunc&&this._externalCall.conditionnalCallFunc(e)}_callExternalApiIfNeededAndSaveInLs(...s){const i=this;return new Promise((r,e)=>{if(i._waitingTimeIsExceeded()||i._externalCondition(s)){const t=i._callExternalApi(s);if(null!=t)return t.then(t=>{i._externalCall.saveResultInLSFunc(t).then(e=>r(t)).catch(e=>r(t))}).catch(e=>{c.error("Exception while calling external api : ",e)})}r("Not yet the time to call")})}getResult(...e){return this._callExternalApiIfNeededAndSaveInLs(e).then(()=>this._externalCall.getResultInLSFunc()).catch(e=>{})}callApi(...e){return this._callExternalApiIfNeededAndSaveInLs(e)}}E.LAST_CALL_KEY="lastCall";class j{constructor(e,t,r){this._lastCallKeySuffix=e,this._lsService=t,this._configApi=r,this._config=u.getCurrentConfig()}getApiBaseUrl(){return this._config.getApiBaseUrl(this._configApi)}getApiUrl(e){return this._config.getApiEpUrl(this._configApi,e)}getEndpointWaitingTime(e){return this._configApi.getEndpointWaitingTime(e)}getLastCallKeySuffix(){return this._lastCallKeySuffix}getLocalStorageService(){return this._lsService}getWaitingTime(){return this._configApi.timeBetweenCall}externalCallFunc(){throw new Error("Method not implemented.")}conditionnalCallFunc(){return!1}saveResultInLSFunc(e){throw new Error("Method not implemented.")}getResultInLSFunc(){throw new Error("Method not implemented.")}}class W{constructor(){}_getOptinInfo(){return null==this.optinInfo?Z.getService().getOptinInfo().then(e=>(this.optinInfo=e,Promise.resolve(this.optinInfo))).catch(e=>{}):Promise.resolve(this.optinInfo)}isCampaignOk(t){return this._getOptinInfo().then(e=>Promise.resolve(this.isCampaignOkWithOptin(t,e))).catch(e=>Promise.resolve(!1))}isCampaignOkWithOptin(e,t){if(null==t)return!0;const r=e.ciblage;let s=!0;if([133013,133014,122361,124049].includes(e.campaignId))return!0;if(null==r)return!0;const i=T.getIds();return f.isNotEmptyEvenFirstItem(r.ids)?s=null!=r.ids.find(e=>e==i):f.isNotEmptyEvenFirstItem(r.idsExclus)&&(s=null==r.idsExclus.find(e=>e==i)),0==s||null==t?s:(null==r.isMobile||r.isMobile==t.isMobile)&&((!b.isNotEmpty(r.browser)||!b.isNotEqualsIgnoreCase(r.browser,t.browser))&&((!b.isNotEmpty(r.postalCode)||!b.includesNotIgnoreCase(r.postalCode,t.postalCode.toString()))&&((!b.isNotEmpty(r.cityName)||!b.includesNotIgnoreCase(r.cityName,t.cityName.toString()))&&((!f.isNotEmptyEvenFirstItem(r.listCountry)||!f.containsNotStringIgnoreCase(r.listCountry,t.countryCode))&&s))))}filterCampaignsByCiblage(r){return this._getOptinInfo().then(t=>{var e=r.filter(e=>null!=e).filter(e=>this.isCampaignOkWithOptin(e,t));return Promise.resolve(e)}).catch(e=>Promise.resolve([]))}}class q extends j{constructor(){super("NadzExternalCallCampaigns",T.storageCampaigns(),u.getCurrentConfig().configNotifadzApi),this._keyRules="rules",this._keyEndpoint="cp",this._checkCiblageService=new W}externalCallFunc(){var e=T.getIds();if(b.isEmpty(e))return Promise.resolve(void 0);e={ids:e};return te.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),e).then(e=>{e=JSON.stringify(e);return JSON.parse(e,C.reviver)}).catch(e=>{})}_filterCampaignsByCiblage(e){return this._checkCiblageService.filterCampaignsByCiblage(e)}saveResultInLSFunc(r){if(null==r||null==r.campaigns)return Promise.resolve();try{return this._filterCampaignsByCiblage(r.campaigns).then(e=>{const t=new H;t.campaigns=e,t.nestedAudiences=r.nestedAudiences,this._lsService.setItem(this._keyRules,t)}).catch(e=>{})}catch(e){return c.error("Exception while saveResultInLSFunc of CallCampaigns",e),Promise.resolve()}}getResultInLSFunc(){return this._lsService.getAllItems().get(this._keyRules)}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class S{constructor(){this._mapCpUsingKeys=new Map;var e=new q;this._externalCallService=new E(e)}getCampaignById(s){return this.getCampaigns().then(t=>{for(let e=0;e<t.length;e++){var r=t[e];if(r.campaignId==s)return Promise.resolve(r)}return Promise.resolve(null)}).catch(e=>Promise.resolve(null))}getCampaignsForPropertyKey(a){var e=this._mapCpUsingKeys.get(a);return null!=e&&0<e.length?Promise.resolve(e):this.getCampaigns().then(t=>{const r=[];if(null==t)return Promise.resolve([]);{const i=[];for(let e=0;e<t.length;e++){const n=t[e];var s=n.isUsingPropertyKey(a).then(e=>{e&&r.push(n)}).catch(e=>{});i.push(s)}return Promise.all(i).then(()=>(null!=r&&0<r.length&&this._mapCpUsingKeys.set(a,r),r)).catch(e=>[])}}).catch(e=>Promise.resolve([]))}_callAndGetResult(t){return this._externalCallService.getResult().then(e=>{return null==e?Promise.resolve([]):(e=t?e.campaigns:e.nestedAudiences,Promise.resolve(e))}).catch(e=>Promise.resolve([]))}getCampaigns(){return f.arrayIsNotEmpty(this._campaigns)?Promise.resolve(this._campaigns):this._callAndGetResult(!0).then(e=>this._campaigns=e).catch(e=>[])}getAudiences(){return f.arrayIsNotEmpty(this._audiences)?Promise.resolve(this._audiences):this._callAndGetResult(!1).then(e=>this._audiences=e).catch(e=>[])}getAudienceById(t){return this.getAudiences().then(e=>null==e?Promise.resolve(void 0):Promise.resolve(e.find(e=>e.id==t))).catch(e=>Promise.resolve(void 0))}getAudienceByIdList(t){return this.getAudiences().then(e=>null==e?Promise.resolve(void 0):Promise.resolve(e.filter(e=>t.includes(e.id)))).catch(e=>Promise.resolve(void 0))}static getCampaigns(){const e=new S;return e.getCampaigns()}static callApiAndFetch(t){const e=new S;return e._externalCallService.callApi().then(e=>{return null==e?Promise.resolve([]):(e=t?e.campaigns:e.nestedAudiences,Promise.resolve(e))}).catch(e=>Promise.resolve([]))}static fetchCampaigns(){return S.callApiAndFetch(!0)}static fetchNestedAudiences(){return S.callApiAndFetch(!1)}static getNestedAudiences(){const e=new S;return e.getAudiences()}static getNestedAudienceById(e){const t=new S;return t.getAudienceById(e)}static getNestedAudienceByIdList(e){const t=new S;return t.getAudienceByIdList(e)}static getNestedAudienceByIdString(e){e=parseInt(e);return this.getNestedAudienceById(e)}static getNestedAudienceByIdStringList(e){const t=new S;return t.getAudienceByIdList(e.map(e=>parseInt(e)))}static getNestedAudienceByRules(e){e=K.getNestedAudiencesIds(e);return this.getNestedAudienceByIdList(e)}}class w{static userIsOptin(){return"granted"===Notification.permission}static canRunProgram(){return this.userIsOptin()?Promise.resolve(!0):this.getRmktOptinInfo().then(e=>null!=e).catch(e=>!1)}static getRmktOptinInfo(){return ce.getOptinFromRmkt().then(e=>e).catch(e=>{c.error("Error while getRmktOptinInfo",e)})}static isModeIframe(){return 1==window.usesNoRootIframe}static whenBrowserReadyDo(e,t=!1){var r="nadzTrig_whenServiceWorkerReadyDo";return C.checkRecusivite(r,150,1.5)?w.isModeIframe()?0==t?Promise.resolve(e(void 0)):w.getSubscriptionFromIframe().then(e).catch(e=>c.error("Exception while registration.pushManager.getSubscription()",e)):w.whenServiceWorkerReadyDo(e):(C.deleteGlobalVarRecursivite(r),Promise.resolve(!1))}static whenServiceWorkerReadyDo(t){var e=Notification.permission;return"granted"===e?navigator.serviceWorker.ready.then(t).catch(e=>c.error("Exception while navigator.serviceWorker.ready",e)):"denied"===e||"default"===e?this.getRmktOptinInfo().then(e=>null!=e&&1==e.isFromRmkt?navigator.serviceWorker.ready.then(t).catch(e=>c.error("Exception while navigator.serviceWorker.ready",e)):new Promise((t,e)=>{(new Q).deleteProfilInAdrenalead().then(e=>{T.clearAll(!0),t(!0)}).catch(e=>{T.clearAll(!0),t(!0)})})).catch(e=>{}):void 0}static whenGetSubscriptionDo(t){return this.whenBrowserReadyDo(e=>e instanceof m?t(e):e.pushManager.getSubscription().then(t).catch(e=>c.error("Exception while registration.pushManager.getSubscription()",e)),!0)}static displayPushFromIframe(e){var t={key:"cp",value:window.btoa(JSON.stringify(e))};c.log("Will display push trough iframe",e),w.reachSdkThroughIframe([t])}static getSubscriptionFromIframe(){return window.nadzPushSubscription?(c.log("window['nadzPushSubscription'] already stored:",window.nadzPushSubscription),Promise.resolve(window.nadzPushSubscription)):new Promise((t,e)=>{w.reachSdkThroughIframe([{key:"getSub",value:"true"}]),window.addEventListener&&window.addEventListener("message",function(e){if(e.data&&e.data.endpoint)return e=new m(e.data.endpoint,e.data.expirationTime,e.data.keys,e.data.optinInfo),window.nadzPushSubscription=e,c.log("Got subscription from iframe",e),t(e)},!1)})}static reachSdkThroughIframe(e){let t=document.getElementsByTagName("body")[0],r=document.createElement("iframe"),s=(t=t||document.documentElement,"");for(const n of e)s+=`${n.key}=${n.value}&`;let i=document.createElement("div");e="/apps/adrenalead/sample.html?"+s;i.style.height="1px",i.style.width="1px",i.style.position="absolute",i.style.top="-42px",i.style.left="-42px",i.style.display="none",t.appendChild(i),r.src=e,r.id="nadz_p_iframe",r.name="nadz_p_iframe",r.height="1px",r.width="1px",r.style.position="absolute",r.style.top="-42px",r.style.left="-42px",i.appendChild(r)}static pushLocalNotif(t){w.isModeIframe()?this.displayPushFromIframe(t):w.whenServiceWorkerReadyDo(e=>{e.showNotification(t.title,t.options)})}static pushLocalNotifFromCampaign(e){this.pushLocalNotif(e.pushContent)}}class O{constructor(e){this.endpointId=(e=null==e?{}:e).endPointId||e.endpointId||e.endpoint_id,this.userId=e.idv||e.userId||e.user_id,this.timestamp=e.timestamp,this.browser=e.browser,this.os=e.os,this.host=e.host,this.countryCode=e.countryCode||e.country_code||e.geoCountryCode,this.countryName=e.countryName||e.country_name||e.geoCountryName,this.cityName=e.cityName||e.city_name||e.geoCityName,this.postalCode=e.postalCode||e.postal_code||e.geoPostalCode,this.ids=e.ids,this.endpoint=e.endpoint,this.auth=e.auth,this.p256dh=e.p256dh,this.isMobile=e.isMobile,null==this.isMobile&&(this.isMobile=e.is_mobile),null==this.isMobile&&(this.isMobile=!1),this.isFromRmkt=e.isFromRmkt,null==this.isFromRmkt&&(this.isFromRmkt=!1)}isValid(){return null!=this.endpointId&&null!=this.timestamp}static ignorableFieldsForReviver(){return["userId","idv"]}static convertShortToLong(e){let t=0;try{t=parseInt(e.gpc)}catch(e){}return{endpointId:e.ei,userId:e.idv,timestamp:e.t,browser:e.br,os:e.os,host:e.h,countryCode:e.gpc,countryName:e.gcounn,cityName:e.gcn,postalCode:t,isMobile:e.ism,ids:e.ids,endpoint:e.ep,auth:e.a,p256dh:e.p}}static createFromINadzInfo(e){e=O.convertShortToLong(e);return new O(e)}}class Y extends j{constructor(){super("NadzExternalCallEpi",T.storageUserProfile(),u.getCurrentConfig().configNotifadzApi),this._keyEndpoint="opti"}externalCallFunc(...e){e=e[0][0][0];if(null==e||2!=e.length)return C.getPromiseRejectForBadParameters();e={a:e[0],p:e[1]};return null==e.a||null==e.p?Promise.resolve(void 0):te.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),e).then(e=>{if("object"==typeof e)return new O(e)}).catch(e=>{})}_refreshCampaigns(){T.storageCampaigns().clearItems();const e=new S;return e.getCampaigns()}_setGeoLocValuesInUserProfil(e){const t=new se;b.isNotEmpty(e.countryCode)&&t.setValue(o.GeoCountryCode,e.countryCode),b.isNotEmpty(e.countryName)&&t.setValue(o.GeoCountryName,e.countryName),null!=e.postalCode&&t.setValue(o.GeoPostalCode,e.postalCode),b.isNotEmpty(e.cityName)&&t.setValue(o.GeoCityName,e.cityName),(new Q).sendProfilToAdrenalead()}saveResultInLSFunc(t){if(null!=t){const e=T.getPushSub();e.optinInfo=t,T.savePushSub(e),this._refreshCampaigns().then(e=>this._setGeoLocValuesInUserProfil(t)).catch(e=>{})}return Promise.resolve()}getResultInLSFunc(){const e=T.getPushSub();if(null!=e)return e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class Z{constructor(){this._extCallService=new E(new Y)}_saveSubscriptionIfNeeded(t){const r=this.getStoredPushSub();if(null==r||r.isDifferentOf(t)){null!=r&&r.isDifferentOf(t)&&T.clearItemsInCheckAgainAndValidatedCampaigns();let e=void 0;return e=t instanceof PushSubscription?m.fromPushSubscription(t):t,T.savePushSub(e),e}return r}_getSubscription(){const t=this;return w.whenGetSubscriptionDo(e=>w.userIsOptin()&&null!=e?t._saveSubscriptionIfNeeded(e):ce.getOptinFromRmktAsPushSub())}getStoredPushSub(){return T.getPushSub()}getOptinInfo(){const e=this._getSubscription();return null==e?Promise.resolve(void 0):e.then(e=>{if(null==e||null==e.keys)return Promise.resolve(void 0);{var t=e.keys.auth,r=e.keys.p256dh;const s=e.optinInfo;return null!=s&&s instanceof O&&s.isValid()?Promise.resolve(e.getOptinInfo()):this._extCallService.getResult(t,r)}}).catch(e=>Promise.resolve(void 0))}saveSubscription(){return this.getOptinInfo()}static getService(){return new Z}static saveSubscription(){return this.getService().saveSubscription()}}class J{constructor(e){this._item=e}rulesAreValidated(){if(null==this._item)return Promise.resolve(!1);let e=Promise.resolve(!1);return e=this._item.allRulesNeedToMatch?this._allRulesAreMatching():this._atLeastOneRuleIsMatching()}rulesAreNotValidated(){return this.rulesAreValidated().then(e=>Promise.resolve(!e)).catch(e=>Promise.resolve(!0))}_ruleMatchPropertyPromises(){const t=[];for(let e=0;e<this._item.rules.length;e++){var r=this._item.rules[e];const s=B.from(r);t.push(s.ruleMatchProperty(r))}return Promise.all(t)}_atLeastOneRuleIsMatching(){return this._ruleMatchPropertyPromises().then(t=>{let r=!1;for(let e=0;e<t.length;e++)if(1==t[e]){r=!0;break}return Promise.resolve(r)}).catch(e=>Promise.resolve(!1))}_allRulesAreMatching(){return this._ruleMatchPropertyPromises().then(t=>{let r=!0;for(let e=0;e<t.length;e++)if(0==t[e]){r=!1;break}return Promise.resolve(r)}).catch(e=>Promise.resolve(!1))}}class $ extends j{constructor(){super("NadzExternalCallUserProfilApi",T.storageUserProfile(),u.getCurrentConfig().configTriggersApi),this._keyEndpoint="userProfil",this.KEY_STORAGE=s.ProfilSended}retrieveGlobalParams(...e){let t=e[0];for(let e=0;e<10&&null!=t;e++){if(!Array.isArray(t))return t;t=t[0]}}retrieveSendParams(...e){e=this.retrieveGlobalParams(e);if(null!=e)return e.params}retrieveSendCondition(...e){e=this.retrieveGlobalParams(e);if(null!=e)return e.condition}profilIsNotOk(e){return null==e||e.isNotOk()}profilEmptyOrWithOnlyOptin(e){return f.arrayIsUndefinedOrEmpty(e.profil)||1==e.profil.length&&e.profil[0].tag==o.Optin}getStoredLastSendedProfil(){return localStorage.getItem(this.KEY_STORAGE)}saveSendedProfil(e){localStorage.setItem(this.KEY_STORAGE,JSON.stringify(e))}canSendProfil(e){var t=this.getStoredLastSendedProfil();return!b.isNotEmpty(t)||JSON.stringify(e)!=t}externalCallFunc(...e){e=this.retrieveSendParams(e);if(null==e)return C.getPromiseRejectForBadParameters();var t=e.userProfil,e=e.httpMethod;return this.profilIsNotOk(t)||null==e?C.getPromiseRejectForBadParameters():this.profilEmptyOrWithOnlyOptin(t)&&"DELETE"!=e?void 0:this.canSendProfil(t)||"DELETE"==e?(this.saveSendedProfil(t),te.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),{p:t},e)):(c.debug("Profil not sended to remote api - values are the same"),Promise.resolve("204"))}conditionnalCallFunc(...e){e=this.retrieveSendCondition(e),e=null!=e&&e.forceSendProfil;return e&&c.info("Forcing send profil"),e}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class Q{constructor(){this._externalCallService=new E(new $,!1)}isArrayOfTimedValue(e){return Array.isArray(e)&&e[0]instanceof p}_getPushSub(e){let t=T.storageUserProfile().getAllItems(),r=t.get(n.PushSubscription);return null!=r||e&&1!=window.nadzTrigModeTest?Promise.resolve(r):Z.saveSubscription().then(e=>(t=T.storageUserProfile().getAllItems(),r=t.get(n.PushSubscription),Promise.resolve(r))).catch(e=>Promise.resolve(void 0))}_prepareProfilTags(e){let t=T.storageUserProfile().getAllItems();const s=[];return e||t.forEach((e,t)=>{let r=void 0;e instanceof p?r=ue.createFromTimedValue(t,e):e instanceof Map&&(e=f.createArrayFromMapValues(e),this.isArrayOfTimedValue(e)&&(r=ue.createFromArrayOfTimedValue(t,e))),null!=r&&s.push(r)}),s}_createUserProfilBeanFromOptinInfo(e){const t={ids:e.ids,auth:e.auth,p256:e.p256dh,profil:[],epi:e.endpointId,idv:e.userId};return e.isFromRmkt&&(t.fIds=e.ids),new ae(t)}_createBeanFromLocalStorage(i){try{return this._getPushSub(i).then(e=>{var t=T.getIds(),r=this._prepareProfilTags(i);if(null==e)return Promise.resolve(void 0);{const s={ids:t,auth:e.keys.auth,p256:e.keys.p256dh,profil:r};return i||null!=(t=e.optinInfo)&&(s.idv=t.userId,s.epi=t.endpointId,t.isFromRmkt&&(s.fIds=t.ids)),Promise.resolve(new ae(s))}}).catch(e=>Promise.resolve(void 0))}catch(e){return c.error("Error while creating profil bean",e),Promise.resolve(void 0)}}_createSendGlobalParams(e,t,r=!1){return{params:{httpMethod:e,userProfil:t},condition:{forceSendProfil:r}}}_callApi(e,t,r){return this._externalCallService.callApi(this._createSendGlobalParams(e,t,r))}_callApiDelete(e,t){return this._callApi("DELETE",e,t)}sendProfilToAdrenalead(t){return this._createBeanFromLocalStorage().then(e=>{null!=e&&(c.debug("sending userProfil",e),this._callApi("POST",e,t))}).catch(e=>{})}deleteProfilInAdrenalead(t){return this._createBeanFromLocalStorage(!0).then(e=>{null!=e&&(c.debug("deleting userProfil",e),this._callApiDelete(e,t))}).catch(e=>{})}deleteProfilRmktInAdrenalead(){var e=T.storageRmktGetOptinInfo();const t=this._createUserProfilBeanFromOptinInfo(e);return t.fIds=t.ids,t.ids=T.getIds(),this._callApiDelete(t,!0)}}class X extends j{constructor(){super("NadzExternalCallTriggersApi",T.storageValidatedCampaigns(),u.getCurrentConfig().configTriggersApi),this._storageSendedTriggersService=T.storageTriggersSended(),this._userProfilService=new Q}_getDateRules(e){let t=e.filter(e=>e.propertyIsTypeDate);return t=null==t?[]:t}_delayFromRule(e){if(null==e)return Promise.resolve(0);var t=e.matchingValue;return e.operatorIsGreaterThan()?Promise.resolve(t):e.propertyIsTypeAudience()&&e.operatorIsIs()?S.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>null!=e?this._delayFromRules(e.rules,!0):0).catch(e=>0):void 0}_delayFromRules(e,t=!1){if(null==e)return Promise.resolve(0);const r=[];return this._getDateRules(e).forEach(e=>{r.push(this._delayFromRule(e))}),Promise.all(r).then(t=>{let r=0;for(let e=0;e<t.length;e++){var s=t[e];s>r&&(r=s)}return r}).then(e=>t?e:P.minutesToMillis(e)).catch(e=>0)}_campaignHasTimeTable(e){return e.hasTimeTable()&&P.stringMatchesFormatHoursMinutes(e.startHour)&&P.stringMatchesFormatHoursMinutes(e.endHour)}_getSendingDate(t){let e=t.getTriggerDelayInMillis(),r=(e<=0&&(e=9e5,c.debug(`Replacing delay by default value ${P.millisToMinutes(e)} min`)),c.debug(`Final delay for trigger ${t.campaignId} is ${P.millisToMinutes(e)} min`),new Date(Date.now()+e));if(this._campaignHasTimeTable(t)){let e=!1;var s;P.hoursAndMinutesAreBeforeGivenOnes(r,t.startHour)?e=!0:P.hoursAndMinutesAreAfterGivenOnes(r,t.endHour)&&(e=!0,r=P.addDays(r,1),c.debug("Added a day to date, new sendingDate = ",r)),e&&(s=P.getHoursFromStringHoursMinutes(t.startHour),t=P.getMinutesFromStringHoursMinutes(t.startHour),-1!=s&&-1!=t&&(r.setHours(s),r.setMinutes(t),c.debug("Changed hours:min, new sendingDate = ",r)))}return r}getStoredTrigger(e){e=e.idc.toString();return this._storageSendedTriggersService.getItem(e)}saveTrigger(e){var t=new p(e);this._storageSendedTriggersService.setItem(e.idc.toString(),t)}triggerIsNotOk(e){return null==e||null==e.tr||b.isEmpty(e.tr.a)||b.isEmpty(e.tr.p)||b.isEmpty(e.tr.epu)||null==e.tr.idc||b.isEmpty(e.tr.ids)}canSendTrigger(e,t){if(this.triggerIsNotOk(t))return!1;if("PUT"==e){var r,e=t.tr,t=this.getStoredTrigger(e);if(null==t)return!0;if(P.getElaspedTimeSinceNow(t.time)<u.getCurrentConfig().timeBetweenSameTrigger)return r="Waiting time between 2 PUT for same trigger NOT OK, checking if some values changed, id = "+(t=t.data).idc,c.debug(r),t.a!=e.a||t.epi!=e.epi||t.epu!=e.epu||t.ids!=e.ids||t.idc!=e.idc||t.p!=e.p}return!0}getUserId(e){let t=void 0;return t=null!=e&&b.isNotEmpty(e.userId)?e.userId:null==(e=T.getIdv())?void 0:e.idv}_fetchOldOptinInfo(){return T.storageRmktGetOptinInfo()}externalCallFunc(...e){e=e[0][0][0];if(null==e||e.length<3||4<e.length)return C.getPromiseRejectForBadParameters();const t=e[0];var r=e[1];const s=e[2],i=e[3],n="DELETE"!=s;if(null==t||null==r||null==s)return C.getPromiseRejectForBadParameters();let a=t.getOptinInfo();if(1==i){e=this._fetchOldOptinInfo();if((null==e?void 0:e.userId)==(null===a||void 0===a?void 0:a.userId))return Promise.resolve("204");a=e}if(null!=a&&n){const y=new W;if(!y.isCampaignOkWithOptin(r,a))return C.getPromiseRejectForBadCiblage()}var e=this.getUserId(a),o=a?a.endpointId:void 0,l=a?a.timestamp:void 0;const u=r?r.ciblage:void 0;var c=!!a&&a.isFromRmkt,h=(null!=u&&c&&u.ids.push(a.ids),T.getIds());let p=h;null!=a&&null!=a.ids&&(p=a.ids);var d=this._getSendingDate(r);let g={tr:{idc:r.campaignId,uid:e,sd:d,epi:o,ids:p,epu:t.endpoint,a:t.keys.auth,p:t.keys.p256dh,t:l,c:u,wait:r.waitingTimeInDaysBetweenPushes}},m=(c&&(g.tr.pIds=h),Promise.resolve());return(m=b.isEmpty(o)?R.getOptinInfo(h).then(e=>{null!=e&&(g.tr.hf=e.href,g.tr.hn=e.hostname,g.tr.lg=e.language,g.tr.pf=e.platform,g.tr.ua=e.userAgent)}).catch(e=>{}):m).then(e=>this.canSendTrigger(s,g)?(1!=i&&this.saveTrigger(g.tr),n&&this._userProfilService.sendProfilToAdrenalead(!0),te.fetchJsonToUrl(this.getApiBaseUrl(),g,s)):Promise.resolve("204")).catch(e=>Promise.resolve("204"))}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}}class ee{constructor(){this._campaignStorageService=new S,this._validatedCampaigns=T.storageValidatedCampaigns(),this._campaignsToCheckAgain=T.storageCheckAgain(),this._extCallService=new E(new X,!1),this._mapOfRequestedCalls=new Map}_campaignIsAlreadyValidated(e){return this._validatedCampaigns.hasItem(e.getId())}_putCampaignInLs(e,t){c.log("Putting campaign in LS : "+t.getRootKey()),t.setItem(e.getId(),e)}_removeCampaignInLs(e,t){c.log("Removing campaign in LS : "+t.getRootKey()),t.removeItem(e.getId())}_putCampaignInLsCheckAgain(e){this._putCampaignInLs(e,this._campaignsToCheckAgain)}_removeCampaignInLsCheckAgain(e){this._removeCampaignInLs(e,this._campaignsToCheckAgain)}_putCampaignInLsValidated(e){this._putCampaignInLs(e,this._validatedCampaigns)}_removeCampaignInLsValidated(e){this._removeCampaignInLs(e,this._validatedCampaigns)}_addBeanToListOfCalls(e){this._mapOfRequestedCalls.set(e.getKey(),e)}_callTriggerApi(r,s,i,e,n){if(null!=e&&1==e){const t=new ne(r,s,i);return c.info("Putting aside the requested call for "+t.getKey()),void this._addBeanToListOfCalls(t)}const a=Z.getService();a.getOptinInfo().then(e=>{var t=a.getStoredPushSub();this._extCallService.callApi(t,r,s,n).then(e=>{i(e)}).catch(e=>{c.error(`Error while calling ${s} trigger API `,e),this._handleCallTriggerApiFailed(r,e)})}).catch(e=>{c.error("Error while getting epi ",e)})}_callTriggerApiWithBean(e){return this._callTriggerApi(e.campaign,e.httpMethod,e.callback)}_handleCallTriggerApiFailed(e,t){t!=C.badCiblageMsg&&this._putCampaignInLsCheckAgain(e)}_insertCampaign(t,e){this._callTriggerApi(t,"POST",e=>{201!=e&&204!=e||(this._putCampaignInLsValidated(t),this._removeCampaignInLsCheckAgain(t))},e)}_updateCampaign(t,e){this._callTriggerApi(t,"PUT",e=>{404==e&&(this._putCampaignInLsCheckAgain(t),this._removeCampaignInLsValidated(t))},e)}_deleteCampaign(t,e,r){this._callTriggerApi(t,"DELETE",e=>{204==e&&this._removeCampaignInLsValidated(t)},e,r)}_handleValidatedCampaign(e,t){1==e.isInstant?w.pushLocalNotifFromCampaign(e):this._campaignIsAlreadyValidated(e)?e.canBeUpdated()&&this._updateCampaign(e,t):this._insertCampaign(e,t)}_handleUnvalidatedCampaign(e,t){this._validatedCampaigns.hasItem(e.getId())&&this._deleteCampaign(e,t)}_checkCampaign(t,r){const e=new J(t);return e.rulesAreValidated().then(e=>{e?this._handleValidatedCampaign(t,r):this._handleUnvalidatedCampaign(t,r)}).catch(e=>{})}sendDeleteForValidatedCampaignsAndClean(){for(const e of this._validatedCampaigns.getAllItems().values())this._deleteCampaign(e,!1,!0);return Promise.resolve()}checkRulesForKey(e,t,r){let s=Promise.resolve(t);null==t&&(s=this._campaignStorageService.getCampaignsForPropertyKey(e));const i=[];return s.then(t=>{null==t&&(t=[]),c.log(`campaigns for key ${e} = `,t);for(let e=0;e<t.length;e++)i.push(this._checkCampaign(t[e],r));return Promise.all(i)}).catch(e=>Promise.all(i))}checkRulesForCheckAgainCampaigns(){let s=f.createArrayFromMapValues(this._campaignsToCheckAgain.getAllItems());return c.log("campaigns in checkAgain = ",s),class{static getUsedKeysFromCampaigns(e){let t=[];if(f.arrayIsUndefinedOrEmpty(e))return Promise.resolve(new Set(t));const r=e.map(e=>e.rules);if(f.arrayIsUndefinedOrEmpty(r))return Promise.resolve(new Set(t));const s=r.reduce((e,t)=>e.concat(t));return t=s.filter(e=>!e.propertyIsTypeAudience()).map(e=>e.getPropertyKey()),S.getNestedAudienceByRules(s).then(e=>this.getUsedKeysFromCampaigns(e).then(e=>{e.forEach(e=>t.push(e));e=new Set(t);return e.size,e}).catch(e=>new Set([]))).catch(e=>new Set([]))}}.getUsedKeysFromCampaigns(s).then(t=>{const r=[];for(let e=0;e<t.size;e++)r.push(this.checkRulesForKey(t[e],s));return Promise.all(r)}).catch(e=>{})}sendRequestedCalls(){this._mapOfRequestedCalls.forEach((e,t)=>{this._callTriggerApiWithBean(e)})}static deleteValidatedCampaignsAndClean(){return(new ee).sendDeleteForValidatedCampaignsAndClean()}}class te{static getRequestContent(e,t){return{method:e,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}}static fetchJsonToUrl(s,i,n){return new Promise((r,t)=>{if(null==s)t("Bad parameters, url can't be null");else{null==n&&(n="POST");var e=this.getRequestContent(n,i);c.info("Fetching at "+s+" with body "+JSON.stringify(e));try{fetch(s,e).then(t=>{t.json().then(e=>r(e)).catch(e=>r(t.status))}).catch(e=>{t(e)})}catch(e){return void t(e)}}})}}(e=a=a||{}).SPECIAL_CHARS="HTML_SPECIALCHARS",e.ENTITIES="HTML_ENTITIES",(e=l=l||{}).NO_QUOTES="ENT_NOQUOTES",e.COMPAT="ENT_COMPAT",e.QUOTES="ENT_QUOTES";class re{static htmlMappingTable(e,t){e=e||a.SPECIAL_CHARS,t=t||l.QUOTES;const r={},s={};if(e==a.SPECIAL_CHARS)r[38]="&amp;",r[60]="&lt;",r[62]="&gt;";else{if(e!=a.ENTITIES)return;r[38]="&amp;",r[60]="&lt;",r[62]="&gt;",r[160]="&nbsp;",r[161]="&iexcl;",r[162]="&cent;",r[163]="&pound;",r[164]="&curren;",r[165]="&yen;",r[166]="&brvbar;",r[167]="&sect;",r[168]="&uml;",r[169]="&copy;",r[170]="&ordf;",r[171]="&laquo;",r[172]="&not;",r[173]="&shy;",r[174]="&reg;",r[175]="&macr;",r[176]="&deg;",r[177]="&plusmn;",r[178]="&sup2;",r[179]="&sup3;",r[180]="&acute;",r[181]="&micro;",r[182]="&para;",r[183]="&middot;",r[184]="&cedil;",r[185]="&sup1;",r[186]="&ordm;",r[187]="&raquo;",r[188]="&frac14;",r[189]="&frac12;",r[190]="&frac34;",r[191]="&iquest;",r[192]="&Agrave;",r[193]="&Aacute;",r[194]="&Acirc;",r[195]="&Atilde;",r[196]="&Auml;",r[197]="&Aring;",r[198]="&AElig;",r[199]="&Ccedil;",r[200]="&Egrave;",r[201]="&Eacute;",r[202]="&Ecirc;",r[203]="&Euml;",r[204]="&Igrave;",r[205]="&Iacute;",r[206]="&Icirc;",r[207]="&Iuml;",r[208]="&ETH;",r[209]="&Ntilde;",r[210]="&Ograve;",r[211]="&Oacute;",r[212]="&Ocirc;",r[213]="&Otilde;",r[214]="&Ouml;",r[215]="&times;",r[216]="&Oslash;",r[217]="&Ugrave;",r[218]="&Uacute;",r[219]="&Ucirc;",r[220]="&Uuml;",r[221]="&Yacute;",r[222]="&THORN;",r[223]="&szlig;",r[224]="&agrave;",r[225]="&aacute;",r[226]="&acirc;",r[227]="&atilde;",r[228]="&auml;",r[229]="&aring;",r[230]="&aelig;",r[231]="&ccedil;",r[232]="&egrave;",r[233]="&eacute;",r[234]="&ecirc;",r[235]="&euml;",r[236]="&igrave;",r[237]="&iacute;",r[238]="&icirc;",r[239]="&iuml;",r[240]="&eth;",r[241]="&ntilde;",r[242]="&ograve;",r[243]="&oacute;",r[244]="&ocirc;",r[245]="&otilde;",r[246]="&ouml;",r[247]="&divide;",r[248]="&oslash;",r[249]="&ugrave;",r[250]="&uacute;",r[251]="&ucirc;",r[252]="&uuml;",r[253]="&yacute;",r[254]="&thorn;",r[255]="&yuml;"}t!=l.NO_QUOTES&&(r[34]="&quot;"),t==l.QUOTES&&(r[39]="&#039;");for(const n in r){var i=String.fromCharCode(n);s[i]=r[n]}return s}static htmlDecode(e,t,r){let s=t.toString();var i=re.htmlMappingTable(e,r);if(null==i)return"";for(const a in i){var n=i[a];s=s.split(n).join(a)}return s}static htmlSpecialCharsDecode(e,t){return re.htmlDecode(a.SPECIAL_CHARS,e,t)}static htmlEntitiesDecode(e,t){return re.htmlDecode(a.ENTITIES,e,t)}}class se{constructor(){this._LOG=!1,this._calledOptin=!1,this._nbOfActionsToExecute=0,this._nbOfActionsExecuted=0,this._cpFetched=!1,this._lsUserProfile=T.storageUserProfile(),this._checkCampaignService=new ee,this._userProfilService=new Q,this._userProfilHasChanged=!1,this._noRootIframeMode=!1}_log(e,t){this._LOG&&c.log(e,t)}_addToMap(e,t){!N.isEmpty(e)&&e instanceof Map||(e=new Map);const r=new p(t,void 0,1);t=r.data;const s=e.get(t);return null!=s&&(r.count+=s.getCount()),e.set(t,r),this._userProfilHasChanged=!0,e}_addToArray(e,t){let r=(e=f.arrayIsUndefinedOrEmpty(e)?[]:e).length-1;return e[r=r<0?0:r]&&e[r].data==t||(t=new p(t),e.push(t),this._userProfilHasChanged=!0),e}_removeFromArray(t,r){if(!f.arrayIsUndefinedOrEmpty(t)){const s=[];for(let e=0;e<t.length;e++)t[e].data==r&&s.push(e);if(f.arrayIsNotEmpty(s))for(let e=0;e<s.length;e++)t.splice(s[e]-e,1);return t}}_removeFromMap(e,t){if(!N.isEmpty(e))return e.delete(t),e}_checkMap(r){for(;r.size>u.ARRAY_MAX_SIZE;){let e,t;for(const i of r.keys()){var s=r.get(i).time;(void 0===e||e>s)&&(e=s,t=i)}r.delete(t)}}_checkArray(e){for(;e.length>u.ARRAY_MAX_SIZE;)e.shift()}_checkRulesForKey(t,r){let e=this._fetchCpPromise;return(e=1!=this._cpFetched&&null!=e?e:Promise.resolve()).then(e=>t==o.DateOptin?this._setDateOptin().then(e=>{this._checkCampaignService.checkRulesForKey(t,void 0,r).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))}).catch(e=>Promise.reject(e)):this._checkCampaignService.checkRulesForKey(t,void 0,r).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))).catch(e=>Promise.reject(e))}_setUserProfilItem(e,t,r){this._lsUserProfile.setItem(e,t),r&&(this._userProfilHasChanged=!0),this._userProfilService.sendProfilToAdrenalead()}_removeUserProfilItem(e){this._lsUserProfile.removeItem(e),this._userProfilHasChanged=!0,this._userProfilService.sendProfilToAdrenalead()}_setValue(e,t,r,s){if(e==o.Optin){if(1==this._calledOptin)return Promise.resolve(!0);this._calledOptin=!0}if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);let i=this._lsUserProfile.getItem(e),n=!0,a=(t=this._decodeValue(t),(null==i||i instanceof p&&i.data!=t)&&(this._userProfilHasChanged=!0),this._log("LS value for "+e+" : ",i),new p(t));return null!=s&&(a.time=s),e==o.Optin&&(n=null!=i&&i==a.data),null==t&&(a=null),this._setUserProfilItem(e,a,!1),null==i&&(i=t),e==o.Optin&&n?Promise.resolve(i):this._checkRulesForKey(e,r).then(()=>(e!=o.Optin&&e!=o.DateOptin&&this._incrementActionExecuted(),Promise.resolve(i))).catch(e=>Promise.resolve(i))}_unsetValue(e,t){return this._log("Removing LS value for "+e),this._removeUserProfilItem(e),this._checkRulesForKey(e,t).then(()=>this._incrementActionExecuted()).catch(()=>this._incrementActionExecuted())}_callbackIncrementAndResolvValue(e){return()=>(this._incrementActionExecuted(),Promise.resolve(e))}_checkRulesForKeyThenIncrementThenResolvValue(e,t,r){return this._checkRulesForKey(e,r).then(this._callbackIncrementAndResolvValue(t)).catch(this._callbackIncrementAndResolvValue(t))}_decodeValue(e){return e="string"==typeof e&&(e=re.htmlSpecialCharsDecode(e))==e?re.htmlEntitiesDecode(e):e}_keyOrValueAreNotOk(e,t){return null==e||"null"==e||null==t||"null"==t}_addValue(e,t,r){if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);var s=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),s=this._addToMap(s,t),this._checkMap(s),this._log("LS values for "+e+" : ",s),this._setUserProfilItem(e,s,!1),this._checkRulesForKeyThenIncrementThenResolvValue(e,s,r)}_removeValue(e,t,r){var s=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),s=this._removeFromMap(s,t),this._checkMap(s),this._log("LS values for "+e+" : ",s),this._setUserProfilItem(e,s,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,s,r)}_incrementValue(e,t,r){null==t&&(t=1);let s=this._lsUserProfile.getItem(e);return(s=null==s?new p(0):s).data+=t,this._log("LS value for "+e+" : ",s),this._setUserProfilItem(e,s,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,s,r)}_setIds(e){null==this._ids&&(T.saveIds(e),this._ids=T.getIds()),this._checkCampaignService.checkRulesForCheckAgainCampaigns()}_saveSubscription(){return Z.saveSubscription()}_setDateOptin(){if(null!=this._dateOptin)return Promise.resolve();var e=T.getDateOptin();return null!=e?(this._dateOptin=e,Promise.resolve()):this._saveSubscription().then(e=>{e=e.timestamp;return null!=e&&0<e&&(this.setValue(y.dateOptin().propertyKey,e),this._dateOptin=e),Promise.resolve()}).catch(e=>Promise.resolve())}_setOptinTrueIfNeeded(){return w.userIsOptin()?this._setValue(o.Optin,!0):Promise.resolve()}_incrementActionExecuted(e){this._nbOfActionsExecuted++,this._userProfilHasChanged&&(this._nbOfActionsExecuted>=this._nbOfActionsToExecute||e)&&this._userProfilService.sendProfilToAdrenalead()}directSetValue(e,t,r,s){this._setValue(e,t,r,s)}setValue(e,t,r,s){return w.whenBrowserReadyDo(this._setValue.bind(this,e,t,r,s))}unsetValue(e,t){return w.whenBrowserReadyDo(this._unsetValue.bind(this,e,t))}addValue(e,t,r){return w.whenBrowserReadyDo(this._addValue.bind(this,e,t,r))}removeValue(e,t,r){return w.whenBrowserReadyDo(this._removeValue.bind(this,e,t,r))}addLastPages(e,t){return this.addValue(y.lastPages().propertyKey,e,t)}incrementValue(e,t,r){return w.whenBrowserReadyDo(this._incrementValue.bind(this,e,t,r))}setIds(e){return null!=e&&(e=e.trim()),this._incrementActionExecuted(),null==this._ids?(T.saveIds(e),this._ids=T.getIds(),w.canRunProgram().then(e=>{e?S.fetchCampaigns().then(e=>Promise.resolve(!0)).catch(e=>Promise.resolve(!1)):Promise.resolve(!0)}).catch(e=>Promise.resolve(!1))):w.whenBrowserReadyDo(this._setIds.bind(this,e))}rmktIsActive(e){null==this._rmktIsActive&&(T.saveRmktIsActive(e),this._rmktIsActive=e)}_deleteOldTriggers(){return ee.deleteValidatedCampaignsAndClean()}_deleteRmktProfil(){return this._userProfilService.deleteProfilRmktInAdrenalead()}optin(){const t=this;return t._deleteOldTriggers().then(e=>t._deleteRmktProfil()).then(e=>t._saveSubscription()).then(e=>this.setValue(o.Optin,!0)).catch(e=>{})}startOfActions(e){this._lsUserProfile.getAllItems(),this._nbOfActionsToExecute=e;const t=this;return w.whenBrowserReadyDo(()=>(console.log("Start of actions"),t._fetchCpPromise=S.getCampaigns(),t._setOptinTrueIfNeeded(),t._fetchCpPromise.then(e=>{t._cpFetched=!0,t._setOptinTrueIfNeeded()}).catch(e=>{})))}incrementNbOfActions(e){null==this._nbOfActionsToExecute&&(this._nbOfActionsToExecute=0),this._nbOfActionsToExecute+=e}endOfActions(){this._checkCampaignService.sendRequestedCalls(),this._incrementActionExecuted(!0)}setNoRootIframeMode(e){this._noRootIframeMode=e}visitTriggers(e,t){return e?this.setValue(n.NadzLastVisit,Date.now(),t):Promise.resolve()}lastPageIsActive(e,t){var r=window.location.href;return e&&b.isNotEmpty(r)?this.setValue(o.UrlLastPage,r,t):Promise.resolve()}setMontantConversion(e,t,r){let s=void 0;try{s=parseFloat(e)}catch(e){}return null!=s?this.setValue(o.MontantConversion,s,t,r):Promise.resolve()}setProduitsDansPanier(e,t){return this.setValue(o.ProduitsDansPanier,e,t)}purchased(e,t){return this.setValue(o.Purchased,e,t)}isAuthenticated(e,t){return this.setValue(o.IsAuthenticated,e,t)}}const ie=new se;class ne{constructor(e,t,r){this.campaign=e,this.httpMethod=t,this.callback=r}getKey(){return this.httpMethod+"_"+this.campaign.campaignId}}class ae{constructor(e){this.ids=e.ids,this.fIds=e.fIds,this.idv=e.idv,this.epi=e.epi,this.auth=e.auth,this.p256=e.p256,this.profil=e.profil}isNotOk(){return!this.isOk()}isOk(){return null!=this.ids&&null!=this.auth&&null!=this.p256&&null!=this.profil}}class oe{constructor(e){this.isMobile=(e=null==e?{}:e).isMobile,null==this.isMobile&&(this.isMobile=e.is_mobile),null==this.isMobile&&(this.isMobile=!1),this.browser=e.browser,this.listCountry=e.listCountry||e.list_country,this.cityName=e.cityName||e.city_name,this.postalCode=e.postalCode||e.postal_code,this.ids=e.ids,this.idsExclus=e.idsExclus||e.ids_exclus}getCitiesAsList(){return this.cityName.split(",")}getPostalCodes(){return this.postalCode.split(",")}}class le{constructor(e,t,r,s){this.body=e,this.icon=t,this.data=r,this.actions=s}toString(){let e="body="+this.body;return null!=this.icon&&(e+=this.icon),null!=this.data&&(e+=this.data),null!=this.actions&&(e+=this.actions.join("|")),e}static fromObject(e){return h.objectsHasSamePropertiesAs(e,le)?new le(e.body,e.icon,e.data,e.actions):null}}class ue{constructor(e){this.tag=(e=null==e?{}:e).tag,this.data=e.data,this.time=e.time}static createFromTimedValue(e,t){if(!b.isEmpty(e)&&null!=t&&!t.isNotOk())return new ue({tag:e,data:t.data,time:t.time})}static createFromArrayOfTimedValue(e,t){if(!b.isEmpty(e)&&!f.arrayIsUndefinedOrEmpty(t))return new ue({tag:e,data:t,time:t[0].time})}}class ce{constructor(){this._externalCallService=new E(new he,!1)}_callApi(e,t){return this._externalCallService.getResult(e,t)}_isAuthorizedToDoRmkt(e,t){var r=T.getRmktIsActive();return!w.userIsOptin()&&null!=e&&null!=e.idv&&1!=e.isFromRandom&&null!=t&&r}getOptinFromRmkt(){var e=T.getIdv(),t=T.getIds();return this._isAuthorizedToDoRmkt(e,t)?this._callApi(e.idv,t):(c.info("Tried to call optinFromRmkt but user is either optin, missing idv or ids or is not authorized"),Promise.resolve(void 0))}static getOptinFromRmkt(){return(new ce).getOptinFromRmkt()}static getOptinFromRmktAsPushSub(){return ce.getOptinFromRmkt().then(e=>{let t=void 0;return null!=e&&(t=m.fromOptinInfo(e)),Promise.resolve(t)}).catch(e=>Promise.resolve(void 0))}}(e=d=d||{}).SAVE_OPTIN_INFO="save",e.GET_OPTIN_INFO="getOptinInfo",e.SAVE_MIGRATION="saveMigration",e.GET_MIGRATION="getMigration";class R{constructor(){}static _getIndexedDB(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB}static getOptinInfo(e){return null==e&&(e=T.getIds()),R.handleIndexedDB(d.GET_OPTIN_INFO,{key:e})}static saveOptinInfo(e){return R.handleIndexedDB(d.SAVE_OPTIN_INFO,e)}static saveMigration(i,n){return new Promise((r,s)=>{R.getMigration(i).then(e=>{let t=0;null!=e&&null!=e.count&&(t=e.count),t++,R.handleIndexedDB(d.SAVE_MIGRATION,{key:i,value:{value:n,time:Date.now(),count:t}}).then(e=>r(e)).catch(e=>s(e))}).catch(e=>s(e))})}static getMigration(e){return R.handleIndexedDB(d.GET_MIGRATION,{key:e})}static handleIndexedDB(h,p){return new Promise((l,e)=>{var t="nadzOpti";const u="nadzOptinInfo",c="nadzMigration";try{var r=R._getIndexedDB();if(r){var s=r.open(t);s.onupgradeneeded=e=>{console.log("IndexedDB nadzOpti - onupgradeneeded");e=e.target.result;try{e.deleteObjectStore(u),e.deleteObjectStore(c)}catch(e){}e.createObjectStore(u,{keyPath:"ids"}).createIndex("ids","ids",{unique:!0}),e.createObjectStore(c,{keyPath:"key"}).createIndex("key","key",{unique:!0})},s.onsuccess=e=>{var t,r,s=e.target.result;function i(e,t){return s.transaction(e,t).objectStore(e)}function n(e){s.close(),l(e)}function a(e){return i(u,e)}function o(e){return i(c,e)}h==d.SAVE_OPTIN_INFO?(a("readwrite").put(p),n(p)):h==d.GET_OPTIN_INFO?(t=a("readonly"),(r=t.get(p.key)).onsuccess=e=>{null!=r.result?n(r.result):n(void 0)},r.onerror=e=>{}):h==d.SAVE_MIGRATION?(o("readwrite").put(p),n(p)):h==d.GET_MIGRATION?(t=o("readonly"),(r=t.get(p.key)).onsuccess=e=>{null!=r.result?n(r.result.value):n(void 0)}):n(void 0)},s.onerror=e=>{}}else l(void 0)}catch(e){l(void 0)}})}}class he extends j{constructor(){super("NadzExternalCallRmkt",T.storageRmkt(),u.getCurrentConfig().configOptinInfoApi),this._keyEndpoint="rmkt-opti"}externalCallFunc(...e){e=e[0][0][0];if(null==e||2!=e.length)return C.getPromiseRejectForBadParameters();e={idv:e[0],ids:e[1]};return null==e.idv||null==e.ids?Promise.resolve(void 0):te.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),e).then(t=>{if("object"==typeof t){let e;return(e=null!=t.result?new O(t.result):O.createFromINadzInfo(t)).isFromRmkt=!0,e}}).catch(e=>{})}saveResultInLSFunc(e){let t=T.getPushSub();return null==t?t=m.fromOptinInfo(e):null!=e?(null!=e.auth&&null!=e.p256dh&&(t.keys=new g(e.auth,e.p256dh)),t.optinInfo=e):t.optinInfo=null,T.savePushSub(t),this._lsService.setItem(o.Optin,e),Promise.resolve()}getResultInLSFunc(){var e;return null==(e=T.getPushSub())?void 0:e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class N{static isMap(e){return null!=e&&e instanceof Map}static isNotMap(e){return!N.isMap(e)}static isEmpty(e){return null==e||e.size<1}static isNotEmpty(e){return!N.isEmpty(e)}}class k{static greaterThan(e,t){return null!=e&&null!=t&&t<e}static greaterThanEquals(e,t){return null!=e&&null!=t&&t<=e}static lesserThan(e,t){return null!=e&&null!=t&&e<t}static lesserThanEquals(e,t){return null!=e&&null!=t&&e<=t}}class b{static isEmpty(e){return null==e||e.length<1}static isNotEmpty(e){return!this.isEmpty(e)}static isEqualsIgnoreCase(e,t){return null!=e&&null!=t&&e.toUpperCase()==t.toUpperCase()}static isNotEqualsIgnoreCase(e,t){return!this.isEqualsIgnoreCase(e,t)}static includesIgnoreCase(e,t){return e.toUpperCase().includes(t.toUpperCase())}static includesNotIgnoreCase(e,t){return!this.includesIgnoreCase(e,t)}static startsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().startsWith(t.toLowerCase()))}static endsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().endsWith(t.toLowerCase()))}}class pe{static _paramsNotOk(e,t){return!(null!=e&&!e.isNotOk()&&null!=t)}static compareTimedValueForSort(e,t){return e.time<t.time?-1:e.time>t.time?1:0}static valueIsOlderThan(e,t){return!this._paramsNotOk(e,t)&&k.greaterThan(e.ageOfValueInMinutes(),t)}static valueIsOlderThanEquals(e,t){return!this._paramsNotOk(e,t)&&k.greaterThanEquals(e.ageOfValueInMinutes(),t)}static valueIsSmallerThan(e,t){return!this._paramsNotOk(e,t)&&k.lesserThan(e.ageOfValueInMinutes(),t)}static valueIsSmallerThanEquals(e,t){return!this._paramsNotOk(e,t)&&k.lesserThanEquals(e.ageOfValueInMinutes(),t)}}window.nadzTrigClean=!0;V=ie;var V,M={startOfActions:function(e){return V.startOfActions(e)},setIds:function(e){return V.setIds(e)},rmktIsActive:function(e){return V.rmktIsActive(e)},unsetValue:function(e,t){return V.unsetValue(e,t)},setValue:function(e,t,r,s){return V.setValue(e,t,r,s)},addValue:function(e,t,r){return V.addValue(e,t,r)},removeValue:function(e,t,r){return V.removeValue(e,t,r)},addLastPage:function(e,t){return V.addLastPages(e,t)},incrementValue:function(e,t,r){return V.incrementValue(e,t,r)},optin:function(){return V.optin()},visitTriggers:function(e,t){return V.visitTriggers(e,t)},lastPageIsActive:function(e,t){return V.lastPageIsActive(e,t)},setMontantConversion:function(e,t,r){return V.setMontantConversion(e,t,r)},setProduitsDansPanier:function(e,t){return V.setProduitsDansPanier(e,t)},setNoRootIframeMode:function(e){return V.setNoRootIframeMode=e},purchased:function(e,t){return V.purchased(e,t)},isAuthenticated:function(e,t){return V.isAuthenticated(e,t)},handleActions:function(t){if(null!=t&&t.shift&&0<t.length){const s=[];V.incrementNbOfActions(t.length);for(let e=0;e<t.length;e++){const i=t[e];var r;null!=i&&(r=i.shift(),i.push(!0),s.push(this[r].apply(this,i)))}Promise.all(s).then(e=>{V.endOfActions()}).catch(e=>{})}}};let D=window[NADZ_TRIGGERS_ARRAY_NAME].length;const de="nadzIdv",ge="setIds",me="rmktIsActive",ye="setNoRootIframeMode";function _e(){return fe("9"+(Date.now()+Math.round(window.performance.now()))+""+Math.floor(100*Math.random())+1,!0)}function fe(e,t){return{idv:e,isFromRandom:t,nadzTrigClean:window.nadzTrigClean}}function Ie(){return new Promise((e,t)=>{null!=window.nadzIds&&0<window.nadzIds.length&&e(window.nadzIds.trim());for(var r=0;r<D;r++)if(window[NADZ_TRIGGERS_ARRAY_NAME][r][0]==ge){const s=window[NADZ_TRIGGERS_ARRAY_NAME][r][1];window.nadzIds=s.trim(),null!=s&&0<s.length&&e(s.trim());break}})}function ve(s,i=!0){return new Promise((t,e)=>{var r=i?"triggers/p_tr":"p";try{fetch("https://notifpush.com"+`/script_parameters/${r}_${s}.json`,{method:"GET"}).then(e=>{if(e.ok)try{e.json().then(e=>{t(i?e._nAdzqTriggers:e.nadz)}).catch(e=>{t(!1)})}catch(e){t(!1)}else t(!1)}).catch(e=>{t(!1)})}catch(e){t(!1)}})}window.addEventListener("nadzOptinEvent",e=>{null!=e&&null!=e.detail&&null!=e.detail.optinInfo&&(null!=(e=e.detail.optinInfo).idv&&Re(e.idv),null!=M&&null!=M.optin&&M.optin(),Se(!0))},!1);const Ae=[ge];function Ce(e){var t=e[0],e=e[1];t==NADZ_TRIGGERS_WELCOME_PUSH_ACTION&&!0===e&&(window[NADZ_TRIGGERS_WELCOME_PUSH_VAR]=!0)}function Te(s){return new Promise((e,t)=>{var r;s.shift?(Ce(r=s.shift(),s[0]),e(M[r].apply(M,s))):console.log("nothing to apply",s)})}function Pe(e){if(null!=e)return JSON.parse(JSON.stringify(e))}function Ee(){return Ie().then(e=>ve(e,!1)).then(t=>{if(function(){for(var e=0;e<D;e++)if(window[NADZ_TRIGGERS_ARRAY_NAME][e][0]==ye)return window.usesNoRootIframe=window[NADZ_TRIGGERS_ARRAY_NAME][e][1],window.usesNoRootIframe}())return"";let r="/",s="serviceworker.js",e={updateViaCache:"none"};for(let e=0;e<t.length;e++){var i=Object.keys(t[e])[0];"setSwPath"===i&&(r=t[e][i]),"setSwName"===i&&(s=t[e][i])}return e.scope=r,navigator.serviceWorker.register(r+s,e)})}function Se(e){if(!(null==window[NADZ_TRIGGERS_ARRAY_NAME]||window[NADZ_TRIGGERS_ARRAY_NAME].length<1))for(var t=0;t<D;t++){var r=window[NADZ_TRIGGERS_ARRAY_NAME][t],s=r[0],r=r[1];if(s==NADZ_TRIGGERS_TEST_ACTION){window[NADZ_TRIGGERS_TEST_ACTION]=r,window[NADZ_TRIGGERS_ARRAY_NAME].splice(t,1),D--;break}}var i=["startOfActions",D-1];1!=e?window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]=Pe(window[NADZ_TRIGGERS_ARRAY_NAME]):window[NADZ_TRIGGERS_ARRAY_NAME]=Pe(window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]),Te(i).then(e=>{for(var t=0;t<D;t++){var r=window[NADZ_TRIGGERS_ARRAY_NAME][t];(r[0]==NADZ_TRIGGERS_WELCOME_PUSH_ACTION?Ce:Te)(r)}window[NADZ_TRIGGERS_ARRAY_NAME]=null}).catch(e=>{})}function we(){const t=()=>{var e;window[NADZ_TRIGGERS_ARRAY_NAME][0][0]==me?(e=window[NADZ_TRIGGERS_ARRAY_NAME].shift(),D--,Te(e).then(e=>Se()).catch(e=>{})):Se()};Ee().then(e=>t()).catch(e=>t())}function Oe(){return new Promise((t,e)=>{new Promise((e,t)=>{e(window.nadzTrigAuthorized=!0)}).then(e=>{var a,o,l;[a,o=!1,l=!0]=["https://gjigle.com/cgp",window.nadzTrigClean,window.nadzTrigAuthorized],new Promise(function(t,e){try{function r(e){e=e.data;"object"==typeof e&&e.i&&t(e.i)}var s,i,n;!o||l?(i=document.getElementsByTagName("body")[0],s=document.createElement("iframe"),i=i||document.documentElement,(n=document.createElement("div")).height="1px",n.width="1px",n.style.position="absolute",n.style.top="-42px",n.style.left="-42px",n.style.display="none",i.appendChild(n),s.src=a,s.id="nadz_iframec",s.name="nadz_iframec",s.height="1px",s.width="1px",s.style.position="absolute",s.style.top="-42px",s.style.left="-42px",n.appendChild(s),window.addEventListener?window.addEventListener("message",r,!1):window.attachEvent&&window.attachEvent("onmessage",r,!1),setTimeout(function(){i.removeChild(n),e()},2500)):t(_e())}catch(e){console.log("Error : ",e)}}).then(e=>{t(e)}).catch(e=>t(void 0)).catch(e=>{})})})}function Re(e){let t=e;null==e.idv&&null==e.isFromRandom&&(t=fe(e,!1)),localStorage&&localStorage.setItem(de,JSON.stringify(t)),window[de]=t}function Ne(){var e=localStorage?(e=localStorage.getItem(de),e=JSON.parse(e),window[de]=e):{};return null!=e&&null!=e.idv&&0<e.idv.length&&(0==e.isFromRandom||!window.nadzTrigAuthorized)&&e.nadzTrigClean==window.nadzTrigClean}return new Promise((i,e)=>{const n=[];Ie().then(e=>ve(e)).then(e=>{0==e&&i(!1),e.forEach(e=>{var t=e[0];Ae.includes(t)||n.push(e)});const r=e.map(e=>e[0]);window[NADZ_TRIGGERS_ARRAY_NAME].forEach(e=>{var t=e[0];r.includes(t)&&"handleActions"!=t||n.push(e)});let t=n.find(e=>e[0]==me);e=n.find(e=>e[0]==ge);window[NADZ_TRIGGERS_ARRAY_NAME]=[],null==t&&(t=[me,!1]),window[NADZ_TRIGGERS_ARRAY_NAME].push(t),null!=e&&window[NADZ_TRIGGERS_ARRAY_NAME].push(e);const s=[];s.push(me),s.push(ge),n.forEach(e=>{s.includes(e[0])||window[NADZ_TRIGGERS_ARRAY_NAME].push(e)}),D=window[NADZ_TRIGGERS_ARRAY_NAME].length,i(!0)}).catch(e=>i(!1))}).then(e=>{0==e?console.log("Triggers are probably not remotly activated"):"granted"===Notification.permission||Ne()?we():Oe().then(e=>{Re(e=null==e?_e():e),we()}).catch(e=>{})}).catch(e=>{}),{getNadzTriggerActions:function(){return M}}}());