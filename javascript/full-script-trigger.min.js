var NADZ_TRIGGERS_VERSION="2.0.11",NADZ_TRIGGERS_ARRAY_NAME="_nAdzqTriggers",NADZ_TRIGGERS_ARRAY_BACKUP_NAME="_nAdzqTriggersBackup",NADZ_TRIGGERS_WINDOW="NADZ_TRIGGERS",NADZ_TRIGGERS_WELCOME_PUSH_VAR="_nAdzqTriggers_welcomePush",NADZ_TRIGGERS_WELCOME_PUSH_ACTION="welcomePush",NADZ_TRIGGERS_TEST_ACTION="nadzTrigModeTest";void 0!=navigator&&"serviceWorker"in navigator&&void 0!=window&&"Notification"in window&&(window[NADZ_TRIGGERS_ARRAY_NAME]=window[NADZ_TRIGGERS_ARRAY_NAME]||[],window[NADZ_TRIGGERS_WINDOW]=window[NADZ_TRIGGERS_WINDOW]||function(){class e{constructor(e,t,r,i,s){this.base_url_dev=e,this.base_url_prod=t,this.baseApi=r,this.timeBetweenCall=i,this._initMapEndpoints(s)}_initMapEndpoints(e){void 0==e&&(e=new Map),this.endpointsApi=e}getApiBaseUrl(e){let t=this.base_url_dev;return e&&(t=this.base_url_prod),t+="/"+this.baseApi}getEndpointUrl(e,t){return this.getApiBaseUrl(e)+"/"+this.getEndpointConfig(t).endpoint}getEndpointWaitingTime(e){return this.getEndpointConfig(e).waitingTime}getEndpointConfig(e){return this.endpointsApi.get(e)}static fromObject(t){return new e(t.base_url_dev,t.base_url_prod,t.baseApi,t.timeBetweenCall,t.endpointsApi)}}var t;!function(e){e.DEV="DEV",e.PROD="PROD"}(t||(t={}));const r=50,i=9e5,s={base_url_dev:"http://127.0.0.1:3000",base_url_prod:"https://secure-apis.notifadz.com",baseApi:"notifadz-v2",timeBetweenCall:3e4,endpointsApi:new Map([["opti",{endpoint:"oi/opti",waitingTime:2e4}],["cp",{endpoint:"tr/cp-rules",waitingTime:18e5}],["rmkt-opti",{endpoint:"rmkt/opti",waitingTime:18e5}]])},n={base_url_dev:"https://secure-apis.notifadz.com",base_url_prod:"https://secure-apis.notifadz.com",baseApi:"api/v1",timeBetweenCall:3e4,endpointsApi:new Map([["rmkt-opti",{endpoint:"oi/rmkt",waitingTime:18e5}]])},a={base_url_dev:"https://secure-trig.notifadz.com",base_url_prod:"https://secure-trig.notifadz.com",baseApi:"triggers",timeBetweenCall:0,endpointsApi:new Map([["triggers",{endpoint:"",waitingTime:0}],["userProfil",{endpoint:"userProfil",waitingTime:12e4}]])};class o{constructor(t,i,o){this.timeBetweenSameTrigger=6e4,this.env=t,this.activateEncoding=i,this.activateLogging=o,this.arrayMaxSize=r,this.configNotifadzApi=e.fromObject(s),this.configOptinInfoApi=e.fromObject(n),this.configTriggersApi=e.fromObject(a)}envIsDev(){return o.envIsDev(this.env)}envIsProd(){return o.envIsProd(this.env)}getApiBaseUrl(e){return e.getApiBaseUrl(this.envIsProd())}getApiEpUrl(e,t){return e.getEndpointUrl(this.envIsProd(),t)}static envMatch(e,t){return e==t}static envIsDev(e){return void 0==e&&(e=this.ENV),this.envMatch(e,t.DEV)}static envIsProd(e){return void 0==e&&(e=this.ENV),this.envMatch(e,t.PROD)}static getConfigDev(){return new o(t.DEV,!1,!0)}static getConfigProd(){return new o(t.PROD,!1,!1)}static getCurrentConfig(){return this.envIsDev()?this.getConfigDev():this.envIsProd()?this.getConfigProd():null}static get ACTIVATE_ENCODING(){return this.getCurrentConfig().activateEncoding}static get ACTIVATE_LOG(){return this.getCurrentConfig().activateLogging}static get ARRAY_MAX_SIZE(){return this.getCurrentConfig().arrayMaxSize}}o.ENV=t.PROD;class l{static log(e,t){o.ACTIVATE_LOG&&(void 0==t?console.log(e):console.log(e,t))}static debug(e,t){o.ACTIVATE_LOG&&(void 0==t?console.debug(e):console.debug(e,t))}static info(e,t){o.ACTIVATE_LOG&&(void 0==t?console.info(e):console.info(e,t))}static warn(e,t){o.ACTIVATE_LOG&&(void 0==t?console.warn(e):console.warn(e,t))}static error(e,t){o.ACTIVATE_LOG&&(void 0==t?console.error(e):console.error(e,t))}static warnNotYetImplemented(e){this.warn(e+" is not yet implemented")}}class c{static checkObjectStructure(e,t,r){if(void 0==e||void 0==t)return!1;for(let i=0;i<t.length;i++){const s=t[i];if(!e.hasOwnProperty(s)&&(f.arrayIsUndefinedOrEmpty(r)||!r.includes(s)))return!1}return!0}static objectsHasSameProperties(e,t){const r=Object.getOwnPropertyNames(t);return this.checkObjectStructure(e,r)}static objectsHasSamePropertiesAs(e,t,r){const i=Object.getOwnPropertyNames(new t);return this.checkObjectStructure(e,i,r)}}class u{constructor(e,t,r){this.data=e,this.count=r,void 0==t&&(t=Date.now()),this.time=t}ageOfValueInMinutes(){return M.getElaspedTimeSinceNowInMinutes(this.time)}toString(){return this.data,this.time,",count="+this.count}isOk(){return void 0!=this.data&&void 0!=this.time&&this.time>0}isNotOk(){return!this.isOk()}getCount(){return void 0!=this.count&&0!=this.count||(this.count=1),this.count}static fromObject(e){return c.objectsHasSamePropertiesAs(e,u),u.ignorableFieldsForReviver()?new u(e.data,e.time,e.count):null}static ignorableFieldsForReviver(){return["count"]}}class h{constructor(e,t){this.auth=e,this.p256dh=t}isValid(){return void 0!=this.auth&&void 0!=this.p256dh}static fromObject(e){return c.objectsHasSamePropertiesAs(e,h)?new h(e.auth,e.p256dh):null}static objectsHasSamePropertiesAs(e){return void 0!=e.auth&&void 0!=e.p256dh&&2==Object.getOwnPropertyNames(e).length}}class d{constructor(e,t,r,i){this.endpoint=e||null,this.expirationTime=t||null,this.keys=r||null,this.optinInfo=i||null}isValid(){return void 0!=this.endpoint&&void 0!=this.keys&&this.keys.isValid()&&void 0!=this.optinInfo&&this.optinInfo.isValid()}isEqualTo(e){if(void 0==e)return!0;let t=void 0;return t=e instanceof PushSubscription?e.toJSON():e,this.endpoint==t.endpoint&&this.keys.auth==t.keys.auth&&this.keys.p256dh==t.keys.p256dh}isDifferentOf(e){return!this.isEqualTo(e)}getOptinInfo(){return this.optinInfo}hasOptinInfo(){return void 0!=this.getOptinInfo()}static fromObject(e){return c.objectsHasSamePropertiesAs(e,d)?new d(e.endpoint,e.expirationTime,e.keys,e.optinInfo):null}static fromPushSubscription(e){if(void 0!=e){const t=e.toJSON(),r=h.fromObject(t.keys);return new d(e.endpoint,e.expirationTime,r,null)}return null}static fromOptinInfo(e){if(void 0!=e){const t=new h(e.auth,e.p256dh);return new d(e.endpoint,null,t,e)}return null}static optinInfoIsNotOk(e){return void 0==e||!e.isValid()}}var p,g,m;!function(e){e.Optin="nadzOptin",e.DateOptin="nadzDateOptin",e.LastPages="nadzLastPages",e.LastProducts="nadzLastProducts",e.MontantConversion="nadzMontantConversion",e.ProduitsDansPanier="nadzProduitsDansPanier",e.UrlLastPage="nadzUrlLastPage",e.Purchased="nadzPurchased",e.IsAuthenticated="nadzIsAuthenticated",e.GeoCountryCode="nadzGeoCountryCode",e.GeoCountryName="nadzGeoCountryName",e.GeoPostalCode="nadzGeoPostalCode",e.GeoCityName="nadzGeoCityName"}(p||(p={})),function(e){e.String="String",e.Number="Number",e.Boolean="Boolean",e.Date="Date",e.Array="Array",e.ArrayValueCount="ArrayValueCount",e.ArrayValueDate="ArrayValueDate",e.Audience="Audience"}(g||(g={}));class y{constructor(e,t,r,i){this.id=e,this.propertyType=t,this.propertyKey=r,this.isGeneric=0|i}_isType(e){return this.propertyType==e}isPropertyGeneric(){return void 0!=this.isGeneric&&1==this.isGeneric}isTypeString(){return this._isType(g.String)}isTypeNumber(){return this._isType(g.Number)}isTypeBoolean(){return this._isType(g.Boolean)}isTypeDate(){return this._isType(g.Date)}isTypeArray(){return this._isType(g.Array)}isTypeArrayValueCount(){return this._isType(g.ArrayValueCount)}isTypeArrayValueDate(){return this._isType(g.ArrayValueDate)}isTypeAudience(){return this._isType(g.Audience)}toString(){return this.propertyType+"_"+this.propertyKey}static fromObject(e){return c.objectsHasSamePropertiesAs(e,y)?new y(e.id,e.propertyType,e.propertyKey,e.isGeneric):null}static ofTypeString(e){return new y(null,g.String,e)}static ofTypeNumber(e){return new y(null,g.Number,e)}static ofTypeBoolean(e){return new y(null,g.Boolean,e)}static ofTypeDate(e){return new y(null,g.Date,e)}static ofTypeArray(e){return new y(null,g.Array,e)}static dateOptin(){return this.ofTypeDate(p.DateOptin)}static lastPages(){return this.ofTypeArray(p.LastPages)}static lastProducts(){return this.ofTypeArray(p.LastProducts)}}!function(e){e.Between="Between",e.Contains="Contains",e.ContainsNot="ContainsNot",e.StartsWith="StartsWith",e.EndsWith="EndsWith",e.Equals="Equals",e.Exist="Exist",e.GreaterThan="GreaterThan",e.GreaterThanEquals="GreaterThanEquals",e.Is="Is",e.IsNot="IsNot",e.LesserThan="LesserThan",e.LesserThanEquals="LesserThanEquals",e.NotEquals="NotEquals",e.NotExist="NotExist",e.Greatest="Greatest",e.Smallest="Smallest",e.Oldest="Oldest",e.Youngest="Youngest"}(m||(m={}));class _{constructor(e,t,r,i){this.property=e,this.operator=t,this.matchingValue=r,this.subKey=i,this._initMatchingValue(r),this._checkMatchingValue()}_initMatchingValue(e){void 0!=e&&(this.propertyIsBoolean()?this.matchingValue="boolean"==typeof e?e:"true"==e:this.propertyIsTypeArray()&&!Array.isArray(e)&&"string"==typeof e?this.matchingValue=e.split(",").map(e=>e.trim()):this.propertyIsTypeNumber()||this.propertyIsTypeDate()||this.propertyIsTypeArrayValueCount()?this.matchingValue=Number(e):this.matchingValue=e)}_allowedMismatchTypes(){const e=new Map;return e.set(g.Date,"Number"),e.set(g.Audience,"String"),e.set(g.ArrayValueCount,"Number"),e}_getMatchingValueConstructorName(){return this.matchingValue.constructor.name}_checkMatchingValue(){if(void 0!=this.property&&void 0!=this.matchingValue){if(this._allowedMismatchTypes().get(this.getPropertyType())==this._getMatchingValueConstructorName())return;this.property.propertyType!=this.matchingValue.constructor.name&&l.error(`Type mismatch : property type = ${this.property}, matchingValue  type = ${this.matchingValue.constructor.name}`)}}_operatorIs(e){return this.operator.toUpperCase()==e.toUpperCase()}getPropertyKey(){return this.property.propertyKey}getPropertyType(){return this.property.propertyType}propertyIsTypeString(){return this.property.isTypeString()}propertyIsTypeNumber(){return this.property.isTypeNumber()}propertyIsBoolean(){return this.property.isTypeBoolean()}propertyIsTypeDate(){return this.property.isTypeDate()}propertyIsTypeArray(){return this.property.isTypeArray()}propertyIsTypeArrayValueCount(){return this.property.isTypeArrayValueCount()}propertyIsTypeArrayValueDate(){return this.property.isTypeArrayValueDate()}propertyIsTypeAudience(){return this.property.isTypeAudience()}operatorIsBetween(){return this._operatorIs(m.Between)}operatorIsContains(){return this._operatorIs(m.Contains)}operatorIsContainsNot(){return this._operatorIs(m.ContainsNot)}operatorIsEndsWith(){return this._operatorIs(m.EndsWith)}operatorIsEquals(){return this._operatorIs(m.Equals)}operatorIsExists(){return this._operatorIs(m.Exist)}operatorIsGreaterThan(){return this._operatorIs(m.GreaterThan)}operatorIsGreaterThanEquals(){return this._operatorIs(m.GreaterThanEquals)}operatorIsIs(){return this._operatorIs(m.Is)}operatorIsIsNot(){return this._operatorIs(m.IsNot)}operatorIsLesserThan(){return this._operatorIs(m.LesserThan)}operatorIsLesserThanEquals(){return this._operatorIs(m.LesserThanEquals)}operatorIsNotEquals(){return this._operatorIs(m.NotEquals)}operatorIsNotExist(){return this._operatorIs(m.NotExist)}operatorIsStartsWith(){return this._operatorIs(m.StartsWith)}operatorIsGreatest(){return this._operatorIs(m.Greatest)}operatorIsSmallest(){return this._operatorIs(m.Smallest)}operatorIsOldest(){return this._operatorIs(m.Oldest)}operatorIsYoungest(){return this._operatorIs(m.Youngest)}isUsingPropertyKey(e){return this.getPropertyKey()==e}isUsingPropertyKeyOfService(e){return this.isUsingPropertyKey(e.keyOfProperty)}hasSameOperator(e){return this.operator==e}toString(){return this.property+" "+this.operator+" "+this.matchingValue}static fromObject(e){return c.objectsHasSamePropertiesAs(e,_,_.ignorableFieldsForReviver())?new _(e.property,e.operator,e.matchingValue,e.subKey):null}static ignorableFieldsForReviver(){return["subKey"]}static lastProducts(e,t){return new _(y.lastProducts(),e,t)}static lastProductsContains(e){return this.lastProducts(m.Contains,e)}static lastProductsExists(e){return this.lastProducts(m.Exist,e)}static lastPages(e,t){return new _(y.lastPages(),e,t)}static lastPageStartWith(e){return this.lastPages(m.StartsWith,e)}static lastPageEndWith(e){return this.lastPages(m.EndsWith,e)}static lastPageEquals(e){return this.lastPages(m.Equals,e)}static lastPageContains(e){return this.lastPages(m.Contains,e)}}class f{static createArrayFromMap(e){if(ce.isEmpty(e))return[];const t=[];for(const r of e)t.push(r);return t}static createArrayFromMapValues(e){if(ce.isEmpty(e))return[];const t=[];for(const r of e)t.push(r[1]);return t}static deepCopyArray(e){return JSON.parse(JSON.stringify(e))}static arrayIsUndefinedOrEmpty(e){return e instanceof Map?void 0==e||0==e.size:void 0==e||void 0==e.length||0==e.length}static arrayIsNotEmpty(e){return!this.arrayIsUndefinedOrEmpty(e)}static sameArrays(e,t){return!this.arrayIsUndefinedOrEmpty(e)&&!this.arrayIsUndefinedOrEmpty(t)&&JSON.stringify(e)===JSON.stringify(t)}static notSameArrays(e,t){return!this.sameArrays(e,t)}static _arrayIsNotOk(e,t){return this.arrayIsUndefinedOrEmpty(e)||this.arrayIsUndefinedOrEmpty(t)||e.length<t.length}static arrayStartsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;const r=e.slice(0,t.length);return this.sameArrays(r,t)}static arrayEndsWithExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;let r=this.deepCopyArray(e),i=this.deepCopyArray(t);return this.arrayStartsWithExpectedArray(r.reverse(),i.reverse())}static arrayContainsExpectedArray(e,t){if(this._arrayIsNotOk(e,t))return!1;const r=this.lowerCaseOfStringValues(e);return t.forEach(e=>{let t=e;if("string"==typeof e&&(t=e.toLowerCase()),!r.includes(t))return!1}),!0}static lowerCaseOfStringValues(e){return e.map(e=>"string"==typeof e?e.toLowerCase():e)}static arrayContainsNotExpectedArray(e,t){return!this.arrayContainsExpectedArray(e,t)}static isNotEmptyEvenFirstItem(e){return this.arrayIsNotEmpty(e)&&he.isNotEmpty(e[0])}static containsStringIgnoreCase(e,t){return e.filter(e=>he.isNotEmpty(e)).map(e=>e.toUpperCase()).includes(t.toUpperCase())}static containsNotStringIgnoreCase(e,t){return!this.containsStringIgnoreCase(e,t)}}class v{static isTheGreatest(e,t){if(f.arrayIsUndefinedOrEmpty(e)||null==t||t.count<1)return!1;let r=0;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.count>r&&(r=i.count)}return t.count>=r}static isTheSmallest(e,t){if(f.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.count;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.count<r&&(r=i.count)}return t.count<=r}static isTheOldest(e,t){if(f.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.time;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.time<r&&(r=i.time)}return t.time<=r}static isTheYoungest(e,t){if(f.arrayIsUndefinedOrEmpty(e)||null==t)return!1;let r=t.time;for(let t=0;t<e.length;t++){const i=e[t];void 0!=i&&i.time>r&&(r=i.time)}return t.time>=r}}class I{get keyOfProperty(){return this._keyOfProperty}get valueOfProperty(){return this._valueOfProperty}constructor(e){this._keyOfProperty=e,this._valueOfProperty=this._fetchValueOfProperty()}_fetchValueOfProperty(){if(this._keyOfProperty==p.DateOptin){const e=b.getPushSub();if(void 0!=e&&void 0!=e.optinInfo)return new u(e.optinInfo.timestamp,e.optinInfo.timestamp)}const e=b.storageUserProfile().getItem(this._keyOfProperty);let t=void 0;return void 0!=e&&ce.isNotMap(e)&&(t=u.fromObject(e)),void 0!=t&&this._keyOfProperty==p.DateOptin&&(t.data=t.time),null==t&&(t=e),t}_getCurrentValueAsArray(){return f.createArrayFromMapValues(this._valueOfProperty)}_getCurrentSubKeyValue(e){return this._getCurrentValueAsArray().find(t=>t.data==e)}_sortArrayOfTimedValues(e){return e.sort((e,t)=>de.compareTimedValueForSort(e,t))}_getCurrentValueAsArrayOfData(e=!0){let t=this._getCurrentValueAsArray();return e&&(t=this._sortArrayOfTimedValues(t)),Array.isArray(t)?t.map(e=>e.data):[]}_getCurrentValueAsTimedValue(){return this._valueOfProperty}_getCurrentValueData(){const e=this._getCurrentValueAsTimedValue();if(void 0!=e)return e.data}_getCurrentValueTime(){const e=this._getCurrentValueAsTimedValue();if(void 0!=e)return e.time}_checkRuleForOperator(e,t){return e.operator.toUpperCase()==t.toUpperCase()&&e.isUsingPropertyKey(this._keyOfProperty)}_logCheck(e,t,r){}_checkStartsWith(e){const t=m.StartsWith;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.arrayStartsWithExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.startsWithIgnoreCase(r,e.matchingValue)}return l.warn("Check starts with not implemented for the type ",e.getPropertyType()),!1}_checkEndsWith(e){const t=m.EndsWith;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.arrayEndsWithExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.endsWithIgnoreCase(r,e.matchingValue)}return l.warn("Check ends with not implemented for the type ",e.getPropertyType()),!1}_checkEquals(e){const t=m.Equals;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.sameArrays(r,e.matchingValue)}if(e.propertyIsBoolean()||e.propertyIsTypeNumber()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),r==e.matchingValue}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.isEqualsIgnoreCase(r,e.matchingValue)}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count==e.matchingValue}return l.warn("Check equals not implemented for the type ",e.getPropertyType()),!1}_checkNotEquals(e){const t=m.NotEquals;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.notSameArrays(r,e.matchingValue)}if(e.propertyIsBoolean()||e.propertyIsTypeNumber()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),r!=e.matchingValue}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.isNotEqualsIgnoreCase(r,e.matchingValue)}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count!=e.matchingValue}return l.warn("Check equals not implemented for the type ",e.getPropertyType()),!1}_checkContains(e){const t=m.Contains;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.arrayContainsExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.includesIgnoreCase(r,e.matchingValue)}return l.warn("Check contains not implemented for the type ",e.getPropertyType()),!1}_checkContainsNot(e){const t=m.ContainsNot;if(!this._checkRuleForOperator(e,t))return!1;if(e.propertyIsTypeArray()){const r=this._getCurrentValueAsArrayOfData();return this._logCheck(t,r,e),f.arrayContainsNotExpectedArray(r,e.matchingValue)}if(e.propertyIsTypeString()){const r=this._getCurrentValueData();return this._logCheck(t,r,e),he.includesNotIgnoreCase(r,e.matchingValue)}return l.warn("Check containsNot not implemented for the type ",e.getPropertyType()),!1}_checkExist(e){const t=m.Exist;if(!this._checkRuleForOperator(e,t))return l.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),void 0!=r&&(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>void 0!=e),f.arrayIsNotEmpty(r)):e.propertyIsTypeString()?he.isNotEmpty(r.data)&&"null"!=r.data:void 0!=r.data)}_checkNotExist(e){const t=m.NotExist;if(!this._checkRuleForOperator(e,t))return l.info("Rule and operator are different"),!1;let r=this._getCurrentValueAsTimedValue();return this._logCheck(t,r,e),void 0==r||(e.propertyIsTypeArray()?(r=this._getCurrentValueAsArrayOfData().filter(e=>void 0!=e),f.arrayIsUndefinedOrEmpty(r)):e.propertyIsTypeString()?he.isEmpty(r.data):void 0==r.data)}_checkGreaterThan(e){const t=m.GreaterThan;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.greaterThan(r.data,e.matchingValue);if(e.propertyIsTypeDate())return de.valueIsOlderThan(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return f.arrayIsNotEmpty(t)&&t.length>e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count>e.matchingValue}return l.warn("Check greaterThan not implemented for the type ",e.getPropertyType()),!1}_checkGreaterThanEquals(e){const t=m.GreaterThanEquals;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.greaterThanEquals(r.data,e.matchingValue);if(e.propertyIsTypeDate())return de.valueIsOlderThanEquals(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return f.arrayIsNotEmpty(t)&&t.length>=e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count>=e.matchingValue}return l.warn("Check greaterThanEquals not implemented for the type ",e.getPropertyType()),!1}_checkLesserThan(e){const t=m.LesserThan;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.lesserThan(r.data,e.matchingValue);if(e.propertyIsTypeDate())return de.valueIsSmallerThan(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return f.arrayIsNotEmpty(t)&&t.length<e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count<e.matchingValue}return l.warn("Check LesserThan not implemented for the type ",e.getPropertyType()),!1}_checkLesserThanEquals(e){const t=m.LesserThanEquals;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsTimedValue();if(this._logCheck(t,r,e),e.propertyIsTypeNumber())return void 0!=r&&ue.lesserThanEquals(r.data,e.matchingValue);if(e.propertyIsTypeDate())return de.valueIsSmallerThanEquals(r,e.matchingValue);if(e.propertyIsTypeArray()){const t=this._getCurrentValueAsArray();return f.arrayIsNotEmpty(t)&&t.length<=e.matchingValue}if(e.propertyIsTypeArrayValueCount()){const t=this._getCurrentSubKeyValue(e.subKey);return void 0!=t&&t.count<=e.matchingValue}return l.warn("Check LesserThanEquals not implemented for the type ",e.getPropertyType()),!1}_checkGreatest(e){const t=m.Greatest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?v.isTheGreatest(r,i):(l.warn("Check _checkGreatest not implemented for the type ",e.getPropertyType()),!1)}_checkSmallest(e){const t=m.Smallest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueCount()?v.isTheSmallest(r,i):(l.warn("Check _checkSmallest not implemented for the type ",e.getPropertyType()),!1)}_checkOldest(e){const t=m.Oldest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?v.isTheOldest(r,i):(l.warn("Check _checkOldest not implemented for the type ",e.getPropertyType()),!1)}_checkYoungest(e){const t=m.Youngest;if(!this._checkRuleForOperator(e,t))return!1;const r=this._getCurrentValueAsArray(),i=this._getCurrentSubKeyValue(e.subKey);return this._logCheck(t,r,e),e.propertyIsTypeArrayValueDate()?v.isTheYoungest(r,i):(l.warn("Check _checkYoungest not implemented for the type ",e.getPropertyType()),!1)}_checkIs(e){const t=m.Is,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?U.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(void 0!=e){return new W(e).rulesAreValidated()}return Promise.resolve(!1)}).catch(e=>Promise.resolve(!1)):(l.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(l.info("Rule and operator are different"),Promise.resolve(!1))}_checkIsNot(e){const t=m.IsNot,r=this._valueOfProperty;return this._checkRuleForOperator(e,t)?(this._logCheck(t,r,e),e.propertyIsTypeAudience()?U.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>{if(void 0!=e){return new W(e).rulesAreNotValidated()}return Promise.resolve(!1)}).catch(e=>Promise.resolve(!1)):(l.warn("Check contains not implemented for the type ",e.getPropertyType()),Promise.resolve(!1))):(l.info("Rule and operator are different"),Promise.resolve(!1))}_ruleToString(e){let t=this._valueOfProperty;return t instanceof Array&&t.length>1&&(t="[",t+=this._valueOfProperty.join("|"),t+="]"),"prop key = "+this._keyOfProperty+", value = "+t+", rule = "+e}ruleMatchProperty(e){if(this._keyOfProperty!=e.getPropertyKey())return Promise.resolve(!1);let t=Promise.resolve(!1);if(e.operatorIsStartsWith())t=Promise.resolve(this._checkStartsWith(e));else if(e.operatorIsEndsWith())t=Promise.resolve(this._checkEndsWith(e));else if(e.operatorIsEquals())t=Promise.resolve(this._checkEquals(e));else if(e.operatorIsNotEquals())t=Promise.resolve(this._checkNotEquals(e));else if(e.operatorIsContains())t=Promise.resolve(this._checkContains(e));else if(e.operatorIsContainsNot())t=Promise.resolve(this._checkContainsNot(e));else if(e.operatorIsExists()){const r=this._checkExist(e);t=Promise.resolve(r)}else e.operatorIsNotExist()?t=Promise.resolve(this._checkNotExist(e)):e.operatorIsGreaterThan()?t=Promise.resolve(this._checkGreaterThan(e)):e.operatorIsGreaterThanEquals()?t=Promise.resolve(this._checkGreaterThanEquals(e)):e.operatorIsIs()?t=this._checkIs(e):e.operatorIsIsNot()?t=this._checkIsNot(e):e.operatorIsLesserThan()?t=Promise.resolve(this._checkLesserThan(e)):e.operatorIsLesserThanEquals()?t=Promise.resolve(this._checkLesserThanEquals(e)):e.operatorIsGreatest()?t=Promise.resolve(this._checkGreatest(e)):e.operatorIsSmallest()?t=Promise.resolve(this._checkSmallest(e)):e.operatorIsOldest()?t=Promise.resolve(this._checkOldest(e)):e.operatorIsYoungest()&&(t=Promise.resolve(this._checkYoungest(e)));return t}static from(e){return new I(e.getPropertyKey())}}class A{constructor(e,t,r,i,s,n,a,o,l,c,u){this.campaignId=e,this.name=t,this.rules=r,this._initAllRulesNeedToMatch(i),this._initTriggerDelay(s),this._initIsInstant(n),this.waitingTimeInDaysBetweenPushes=a||1,this.pushContent=o,this.ciblage=l,this.startHour=c,this.endHour=u}_initAllRulesNeedToMatch(e){void 0==e&&(e=!0),this.allRulesNeedToMatch=e}_initTriggerDelay(e){void 0==e&&(e=0),this.triggerDelayInMinutes=e}_initIsInstant(e){void 0==e&&(e=!0),this.isInstant=e}_getLogPrefix(e){return this.constructor.name+" - "+e}getId(){return this.campaignId.toString()}getTriggerDelayInMillis(){return M.minutesToMillis(this.triggerDelayInMinutes)}toString(){return`name=${this.name}, triggerDelayInMinutes=${this.triggerDelayInMinutes}, isInstant=${this.isInstant}, \n                waitingTimeInDaysBetweenPushes=${this.waitingTimeInDaysBetweenPushes}, rules=${this.rules}, pushContent=${this.pushContent}`}isUsingPropertyKey(e){return P.atLeastOneRuleUsingPropertyKey(this.rules,e)}canBeUpdated(){return void 0!=this.waitingTimeInDaysBetweenPushes&&this.waitingTimeInDaysBetweenPushes>=0}hasTimeTable(){return he.isNotEmpty(this.startHour)&&he.isNotEmpty(this.endHour)}static ignorableFieldsForReviver(){return["ciblage","pushContent"]}static fromObject(e){return c.objectsHasSamePropertiesAs(e,A,A.ignorableFieldsForReviver())?new A(e.campaignId,e.name,e.rules,e.allRulesNeedToMatch,e.triggerDelayInMinutes,e.isInstant,e.waitingTimeInDaysBetweenPushes,e.pushContent,e.ciblage,e.startHour,e.endHour):null}}class C{constructor(e,t){this.title=e,this.options=t}toString(){return`title=${this.title}, options=${this.options}`}static fromObject(e){return c.objectsHasSamePropertiesAs(e,C)?new C(e.title,e.options):null}static newPushContent(e,t,r,i,s){const n=new re(t,r,i,s);return new C(e,n)}}const T={HOME:"home",PRODUITS:"produits",PRODUIT_A:"produitA",PRODUIT_B:"produitB",PANIER:"panier"};class P{static lastProductsContains_A(){let e=[T.PRODUIT_A];return _.lastProductsContains(e)}static lastProductsContains_B(){let e=[T.PRODUIT_B];return _.lastProductsContains(e)}static lastProductsExists(){return _.lastProductsExists(null)}static testLastPagesStartWith_home_produits_produitA(){let e=[T.HOME,T.PRODUITS,T.PRODUIT_A];return _.lastPageStartWith(e)}static testLastPagesEndWith_home_produits_panier(){let e=[T.HOME,T.PRODUITS,T.PANIER];return _.lastPageEndWith(e)}static testLastPagesEquals(){let e=[T.HOME,T.PRODUITS,T.PRODUIT_B,T.PRODUITS,T.PANIER];return _.lastPageEquals(e)}static testLastPagesContains_A_B(){let e=[T.PRODUIT_A,T.PRODUIT_B];return _.lastPageContains(e)}static getRulesUsingPropertyKey(e,t){let r=[];return e.forEach(e=>{e.isUsingPropertyKey(t)&&r.push(e)}),r}static atLeastOneRuleUsingPropertyKey(e,t){let r=[];for(let i=0;i<e.length;i++){const s=e[i];if(s.isUsingPropertyKey(t))return Promise.resolve(!0);if(s.propertyIsTypeAudience()){const e=U.getNestedAudienceByIdString(s.getPropertyKey());r.push(e)}}return Promise.all(r).then(e=>{let r=[];return e.forEach(e=>{const i=this.atLeastOneRuleUsingPropertyKey(e.rules,t);r.push(i)}),r}).then(e=>Promise.all(e).then(e=>{for(let t=0;t<e.length;t++)if(1==e[t])return!0;return!1}).catch(e=>!1)).catch(e=>!1)}static operatorExist(e){return Object.keys(m).map(e=>e.toLowerCase()).includes(e.toLowerCase())}static getRulesUsingAudience(e){return e.filter(e=>e.propertyIsTypeAudience())}static getNestedAudiencesIds(e){return this.getRulesUsingAudience(e).map(e=>e.getPropertyKey()).map(e=>parseInt(e))}}class E{constructor(e){void 0==e&&(e={}),this.id=e.id,this.campaignId=e.campaignId,this.name=e.name,this.rules=e.rules,this._initAllRulesNeedToMatch(e.allRulesNeedToMatch),this._initIsInstant(e.isInstant),this.pushContent=e.pushContent}_initAllRulesNeedToMatch(e){void 0==e&&(e=!0),this.allRulesNeedToMatch=e}_initIsInstant(e){void 0==e&&(e=!0),this.isInstant=e}getId(){return this.id.toString()}toString(){return`id=${this.id}, campaignId=${this.campaignId}, name=${this.name}, isInstant=${this.isInstant}, \n                rules=${this.rules}, pushContent=${this.pushContent}`}isUsingPropertyKey(e){return P.atLeastOneRuleUsingPropertyKey(this.rules,e)}static ignorableFieldsForReviver(){return["pushContent"]}}class S{constructor(e){void 0==e&&(e={}),this.campaigns=e.campaigns,this.nestedAudiences=e.nestedAudiences}}class O{static get badParametersMsg(){return"Bad parameters"}static get badCiblageMsg(){return"Bad ciblage"}static getPromiseRejectForBadParameters(e=this.badParametersMsg){return new Promise((t,r)=>{r(e)})}static getPromiseRejectForBadCiblage(e=this.badCiblageMsg){return new Promise((t,r)=>{r(e)})}static utf8_to_b64(e){if(e)return window.btoa(unescape(encodeURIComponent(e)))}static b64_to_utf8(e){if(e)return decodeURIComponent(escape(window.atob(e)))}static replacer(e,t){const r=this[e];return r instanceof Map?{dataType:"Map",value:f.createArrayFromMap(r)}:t}static reviver(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.value);if(c.objectsHasSamePropertiesAs(t,u,u.ignorableFieldsForReviver()))return u.fromObject(t);if(c.objectsHasSamePropertiesAs(t,A,A.ignorableFieldsForReviver()))return A.fromObject(t);if(c.objectsHasSamePropertiesAs(t,E,E.ignorableFieldsForReviver()))return new E(t);if(c.objectsHasSamePropertiesAs(t,y))return y.fromObject(t);if(c.objectsHasSamePropertiesAs(t,C))return C.fromObject(t);if(c.objectsHasSamePropertiesAs(t,re))return re.fromObject(t);if(c.objectsHasSamePropertiesAs(t,_,_.ignorableFieldsForReviver()))return _.fromObject(t);if(c.objectsHasSamePropertiesAs(t,d))return d.fromObject(t);if("keys"==e&&h.objectsHasSamePropertiesAs(t))return h.fromObject(t);if(c.objectsHasSamePropertiesAs(t,B,B.ignorableFieldsForReviver()))return new B(t);if(c.objectsHasSamePropertiesAs(t,te))return new te(t);if(c.objectsHasSamePropertiesAs(t,S))return new S(t)}return t}static checkRecusivite(e,t,r){let i=window[e]||{count:1,timeFirstCall:Date.now()};i.count++,window[e]=i;let s=M.getElaspedTimeSinceNowInSeconds(i.timeFirstCall);return s<1&&(s=1),!(i.count/s>t&&s>r)}static deleteGlobalVarRecursivite(e){window[e]=void 0}}var w,R,N,k;!function(e){e.UserProfile="nadzUserProfile",e.Campaigns="nadzCampaigns",e.ValidatedCampaigns="nadzValidatedCampaigns",e.CampaignsToCheckAgain="nadzCheckAgain",e.TriggersSended="nadzTriggersSended",e.ProfilSended="nadzProfilSended",e.Idv="nadzIdv",e.Rmkt="nadzRmkt"}(w||(w={})),function(e){e.Ids="nadzIds",e.PushSubscription="nadzPushSubscription",e.NadzLastVisit="nadzLastVisit",e.RmktIsActive="nadzRmktIsActive"}(R||(R={}));class b{constructor(e){this._rootKey=e}getRootKey(){return b.ENCODE?this.encode(this._rootKey):this._rootKey}_getRootItem(){if(void 0==this._rootItem){let e=localStorage.getItem(this.getRootKey());void 0!=e&&b.ENCODE&&(e=this.decode(e)),this._rootItem=void 0==e?new Map:JSON.parse(e,O.reviver)}return this._rootItem}_setRootItem(e){this._saveRootItemInStorage(e),this._rootItem=e}_saveRootItemInStorage(e){void 0==e&&(e=this._rootItem);let t=JSON.stringify(e,O.replacer);b.ENCODE&&(t=this.encode(t)),localStorage.setItem(this.getRootKey(),t)}_setItem(e,t){this._getRootItem().set(e,t)}_deleteItem(e){this._getRootItem().delete(e)}encode(e){return O.utf8_to_b64(e)}decode(e){return O.b64_to_utf8(e)}getItem(e){let t=this._getRootItem();return t.has(e)?t.get(e):null}hasItem(e){return void 0!=this.getItem(e)}getAllItems(){return this._getRootItem()}setItems(e){this._saveRootItemInStorage(e)}setItem(e,t){this._setItem(e,t),this._saveRootItemInStorage()}removeItem(e){this._deleteItem(e),this._saveRootItemInStorage()}clearItems(){this._setRootItem(new Map)}static storageUserProfile(){return void 0==b.instanceUserProfile&&(b.instanceUserProfile=new b(w.UserProfile)),b.instanceUserProfile}static storageRmkt(){return new b(w.Rmkt)}static storageRmktGetOptinInfo(){return b.storageRmkt().getItem(p.Optin)}static storageCampaigns(){return void 0==b._iCampaigns&&(b._iCampaigns=new b(w.Campaigns)),b._iCampaigns}static storageValidatedCampaigns(){return new b(w.ValidatedCampaigns)}static storageCheckAgain(){return new b(w.CampaignsToCheckAgain)}static storageTriggersSended(){return new b(w.TriggersSended)}static saveCommonKey(e,t){this.storageUserProfile().setItem(e,t)}static saveIds(e){this.saveCommonKey(R.Ids,e)}static getIds(){let e=this.storageUserProfile().getItem(R.Ids);return he.isEmpty(e)&&(e=window[R.Ids],he.isNotEmpty(e)&&this.saveIds(e)),e}static getIdv(){let e=localStorage.getItem(w.Idv),t=JSON.parse(e);if(void 0==t){const e=window[w.Idv];void 0!=e&&(this.saveIdv(e),t=e)}return t}static saveIdv(e){void 0!=e&&localStorage.setItem(w.Idv,JSON.stringify(e))}static saveRmktIsActive(e=!0){this.saveCommonKey(R.RmktIsActive,e)}static getRmktIsActive(){return this.storageUserProfile().getItem(R.RmktIsActive)}static getDateOptin(){return this.storageUserProfile().getItem(p.DateOptin)}static getPushSub(){return this.storageUserProfile().getItem(R.PushSubscription)}static savePushSub(e){l.log("Saving subscription",e),this.saveCommonKey(R.PushSubscription,e)}static clearAll(e=!1){l.log("Clearing all local storage");const t=[w.Rmkt];Object.keys(w).forEach(r=>{t.includes(w[r])||e&&r==w.Campaigns||localStorage.removeItem(w[r])})}static clearItems(e){l.log("Clearing items in "+e.getRootKey()),e.clearItems()}static clearItemsInCheckAgainAndValidatedCampaigns(){this.clearItems(this.storageValidatedCampaigns()),this.clearItems(this.storageCheckAgain())}}b.ENCODE=o.ACTIVATE_ENCODING;class V{static getUsedKeysFromCampaigns(e){let t=[];if(f.arrayIsUndefinedOrEmpty(e))return Promise.resolve(new Set(t));const r=e.map(e=>e.rules);if(f.arrayIsUndefinedOrEmpty(r))return Promise.resolve(new Set(t));const i=r.reduce((e,t)=>e.concat(t));return t=i.filter(e=>!e.propertyIsTypeAudience()).map(e=>e.getPropertyKey()),U.getNestedAudienceByRules(i).then(e=>this.getUsedKeysFromCampaigns(e).then(e=>{e.forEach(e=>t.push(e));const r=new Set(t);return r.size,r}).catch(e=>new Set([]))).catch(e=>new Set([]))}}class M{static getElapsedTime(e,t){return void 0==e&&(e=0),void 0==t&&(t=0),e-t}static getElapsedTimeBetweenDates(e,t){return this.getElapsedTime(e.getTime(),t.getTime())}static getElaspedTimeSinceNow(e){return this.getElapsedTime(Date.now(),e)}static getElaspedTimeSinceNowInSeconds(e){const t=this.getElaspedTimeSinceNow(e);return this.millisToSeconds(t)}static getElaspedTimeSinceNowInMinutes(e){const t=this.getElaspedTimeSinceNow(e);return this.millisToMinutes(t)}static getElaspedTimeSinceNowForDate(e){return this.getElapsedTimeBetweenDates(new Date,e)}static getTimeInSeconds(e){return void 0==e&&(e=0),e/1e3}static getTimeInMinutes(e){return this.getTimeInSeconds(e)/60}static getTimeInHours(e){return this.getTimeInMinutes(e)/60}static getTimeInDays(e){return this.getTimeInHours(e)/24}static millisToSeconds(e){return void 0==e&&(e=0),e/1e3}static secondsToMinutes(e){return void 0==e&&(e=0),e/60}static millisToMinutes(e){return void 0==e&&(e=0),this.secondsToMinutes(this.millisToSeconds(e))}static secondsToMillis(e){return void 0==e&&(e=0),1e3*e}static minutesToMillis(e){return void 0==e&&(e=0),this.secondsToMillis(60*e)}static hoursToMillis(e){return void 0==e&&(e=0),this.minutesToMillis(60*e)}static daysToMillis(e){return void 0==e&&(e=0),this.hoursToMillis(24*e)}static addDays(e,t){return e.setDate(e.getDate()+t),e}static addHours(e,t){return e.setHours(e.getHours()+t),e}static stringMatchesFormatHoursMinutes(e){return void 0!=e&&void 0!=e.match(/^[0-9]{2}:[0-9]{2}$/gm)}static getHoursFromStringHoursMinutes(e){try{return parseInt(e.substring(0,2))}catch(e){return-1}}static getMinutesFromStringHoursMinutes(e){try{return parseInt(e.substring(3,5))}catch(e){return-1}}static getSumOfMinutesFromStringHoursMinutes(e){const t=this.getHoursFromStringHoursMinutes(e),r=this.getMinutesFromStringHoursMinutes(e);return-1==t||-1==r?-1:60*t+r}static getMinutesFromHoursMinutesOfDate(e){try{return 60*e.getHours()+e.getMinutes()}catch(e){return-1}}static hoursAndMinutesAreAfterGivenOnes(e,t){return this.getMinutesFromHoursMinutesOfDate(e)>this.getSumOfMinutesFromStringHoursMinutes(t)}static hoursAndMinutesAreBeforeGivenOnes(e,t){return this.getMinutesFromHoursMinutesOfDate(e)<this.getSumOfMinutesFromStringHoursMinutes(t)}static hoursAndMinutesAreBetweenGivenOnes(e,t,r){return this.hoursAndMinutesAreAfterGivenOnes(e,t)&&this.hoursAndMinutesAreBeforeGivenOnes(e,r)}}class D{constructor(e,t=!1){this._LOG=!1,this._lsService=e.getLocalStorageService(),this._waitingTimeBetweenCalls=e.getWaitingTime(),this._lastCallKeySuffix=e.getLastCallKeySuffix(),this._externalCall=e,this._delayFirstCall=t}_log(e,t){this._LOG&&l.log(e,t)}_info(e,t){this._LOG&&l.info(e,t)}_isFirstCall(){return 0==this._getLastCall()}_getLastCall(){let e=this._lsService.getItem(this._getLastCallFullKey());return void 0==e&&(e=0),e}_getLastCallFullKey(){return D.LAST_CALL_KEY+this._lastCallKeySuffix}_setLastCall(e){this._lsService.setItem(this._getLastCallFullKey(),e)}_updateLastCallToNow(){const e=this._lsService.getRootKey();this._log("Updating lastCall to now for "+e),this._setLastCall(Date.now())}_getElapsedTimeSinceLastCall(){return this._noWaitingTime()?(this._info("No waiting time"),1):M.getElaspedTimeSinceNow(this._getLastCall())}_waitingTimeIsExceeded(){if(this._isFirstCall()&&this._delayFirstCall)return this._log("Delaying first call"),this._updateLastCallToNow(),!1;const e=this._getElapsedTimeSinceLastCall();return this._log("Elapsed waiting time (in seconds) = ",M.getTimeInSeconds(e)),e>this._waitingTimeBetweenCalls}_noWaitingTime(){return 0==this._waitingTimeBetweenCalls}_callExternalApi(...e){return this._log("Fetching remotly : "+this._externalCall.constructor.name),this._noWaitingTime()||this._updateLastCallToNow(),this._externalCall.externalCallFunc(e)}_externalCondition(...e){return void 0!=this._externalCall.conditionnalCallFunc&&this._externalCall.conditionnalCallFunc(e)}_callExternalApiIfNeededAndSaveInLs(...e){const t=this;return new Promise((r,i)=>{if(t._waitingTimeIsExceeded()||t._externalCondition(e)){const i=t._callExternalApi(e);if(void 0!=i)return i.then(e=>{t._externalCall.saveResultInLSFunc(e).then(t=>r(e)).catch(t=>r(e))}).catch(e=>{l.error("Exception while calling external api : ",e)})}r("Not yet the time to call")})}getResult(...e){return this._callExternalApiIfNeededAndSaveInLs(e).then(()=>this._externalCall.getResultInLSFunc()).catch(e=>void 0)}callApi(...e){return this._callExternalApiIfNeededAndSaveInLs(e)}}D.LAST_CALL_KEY="lastCall";class F{constructor(e,t,r){this._lastCallKeySuffix=e,this._lsService=t,this._configApi=r,this._config=o.getCurrentConfig()}getApiBaseUrl(){return this._config.getApiBaseUrl(this._configApi)}getApiUrl(e){return this._config.getApiEpUrl(this._configApi,e)}getEndpointWaitingTime(e){return this._configApi.getEndpointWaitingTime(e)}getLastCallKeySuffix(){return this._lastCallKeySuffix}getLocalStorageService(){return this._lsService}getWaitingTime(){return this._configApi.timeBetweenCall}externalCallFunc(...e){throw new Error("Method not implemented.")}conditionnalCallFunc(...e){return!1}saveResultInLSFunc(e){throw new Error("Method not implemented.")}getResultInLSFunc(){throw new Error("Method not implemented.")}}class G{constructor(){}_getOptinInfo(){return void 0==this.optinInfo?H.getService().getOptinInfo().then(e=>(this.optinInfo=e,Promise.resolve(this.optinInfo))).catch(e=>void 0):Promise.resolve(this.optinInfo)}isCampaignOk(e){return this._getOptinInfo().then(t=>Promise.resolve(this.isCampaignOkWithOptin(e,t))).catch(e=>Promise.resolve(!1))}isCampaignOkWithOptin(e,t){if(void 0==t)return!0;const r=e.ciblage;let i=!0;if([133013,133014,122361,124049].includes(e.campaignId))return!0;if(void 0==r)return!0;const s=b.getIds();return f.isNotEmptyEvenFirstItem(r.ids)?i=void 0!=r.ids.find(e=>e==s):f.isNotEmptyEvenFirstItem(r.idsExclus)&&(i=void 0==r.idsExclus.find(e=>e==s)),0==i||void 0==t?i:(void 0==r.isMobile||r.isMobile==t.isMobile)&&((!he.isNotEmpty(r.browser)||!he.isNotEqualsIgnoreCase(r.browser,t.browser))&&((!he.isNotEmpty(r.postalCode)||!he.includesNotIgnoreCase(r.postalCode,t.postalCode.toString()))&&((!he.isNotEmpty(r.cityName)||!he.includesNotIgnoreCase(r.cityName,t.cityName.toString()))&&((!f.isNotEmptyEvenFirstItem(r.listCountry)||!f.containsNotStringIgnoreCase(r.listCountry,t.countryCode))&&i))))}filterCampaignsByCiblage(e){return this._getOptinInfo().then(t=>{const r=e.filter(e=>void 0!=e).filter(e=>this.isCampaignOkWithOptin(e,t));return Promise.resolve(r)}).catch(e=>Promise.resolve([]))}}class L extends F{constructor(){super("NadzExternalCallCampaigns",b.storageCampaigns(),o.getCurrentConfig().configNotifadzApi),this._keyRules="rules",this._keyEndpoint="cp",this._checkCiblageService=new G}externalCallFunc(...e){const t=b.getIds();if(he.isEmpty(t))return Promise.resolve(void 0);const r={ids:t};return Z.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{const t=JSON.stringify(e);return JSON.parse(t,O.reviver)}).catch(e=>void 0)}_filterCampaignsByCiblage(e){return this._checkCiblageService.filterCampaignsByCiblage(e)}saveResultInLSFunc(e){if(void 0==e||void 0==e.campaigns)return Promise.resolve();try{return this._filterCampaignsByCiblage(e.campaigns).then(t=>{const r=new S;r.campaigns=t,r.nestedAudiences=e.nestedAudiences,this._lsService.setItem(this._keyRules,r)}).catch(e=>void 0)}catch(e){return l.error("Exception while saveResultInLSFunc of CallCampaigns",e),Promise.resolve()}}getResultInLSFunc(){return this._lsService.getAllItems().get(this._keyRules)}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class U{constructor(){this._mapCpUsingKeys=new Map;let e=new L;this._externalCallService=new D(e)}getCampaignById(e){return this.getCampaigns().then(t=>{for(let r=0;r<t.length;r++){const i=t[r];if(i.campaignId==e)return Promise.resolve(i)}return Promise.resolve(null)}).catch(e=>Promise.resolve(null))}getCampaignsForPropertyKey(e){const t=this._mapCpUsingKeys.get(e);return void 0!=t&&t.length>0?Promise.resolve(t):this.getCampaigns().then(t=>{const r=[];if(void 0!=t){const i=[];for(let s=0;s<t.length;s++){const n=t[s],a=n.isUsingPropertyKey(e).then(e=>{e&&r.push(n)}).catch(e=>{});i.push(a)}return Promise.all(i).then(()=>(void 0!=r&&r.length>0&&this._mapCpUsingKeys.set(e,r),r)).catch(e=>[])}return Promise.resolve([])}).catch(e=>Promise.resolve([]))}_callAndGetResult(e){return this._externalCallService.getResult().then(t=>{if(void 0==t)return Promise.resolve([]);{const r=e?t.campaigns:t.nestedAudiences;return Promise.resolve(r)}}).catch(e=>Promise.resolve([]))}getCampaigns(){return f.arrayIsNotEmpty(this._campaigns)?Promise.resolve(this._campaigns):this._callAndGetResult(!0).then(e=>(this._campaigns=e,e)).catch(e=>[])}getAudiences(){return f.arrayIsNotEmpty(this._audiences)?Promise.resolve(this._audiences):this._callAndGetResult(!1).then(e=>(this._audiences=e,e)).catch(e=>[])}getAudienceById(e){return this.getAudiences().then(t=>void 0==t?Promise.resolve(void 0):Promise.resolve(t.find(t=>t.id==e))).catch(e=>Promise.resolve(void 0))}getAudienceByIdList(e){return this.getAudiences().then(t=>void 0==t?Promise.resolve(void 0):Promise.resolve(t.filter(t=>e.includes(t.id)))).catch(e=>Promise.resolve(void 0))}static getCampaigns(){return(new U).getCampaigns()}static callApiAndFetch(e){return(new U)._externalCallService.callApi().then(t=>{if(void 0==t)return Promise.resolve([]);{const r=e?t.campaigns:t.nestedAudiences;return Promise.resolve(r)}}).catch(e=>Promise.resolve([]))}static fetchCampaigns(){return U.callApiAndFetch(!0)}static fetchNestedAudiences(){return U.callApiAndFetch(!1)}static getNestedAudiences(){return(new U).getAudiences()}static getNestedAudienceById(e){return(new U).getAudienceById(e)}static getNestedAudienceByIdList(e){return(new U).getAudienceByIdList(e)}static getNestedAudienceByIdString(e){const t=parseInt(e);return this.getNestedAudienceById(t)}static getNestedAudienceByIdStringList(e){return(new U).getAudienceByIdList(e.map(e=>parseInt(e)))}static getNestedAudienceByRules(e){const t=P.getNestedAudiencesIds(e);return this.getNestedAudienceByIdList(t)}}class x{static userIsOptin(){return"granted"===Notification.permission}static canRunProgram(){return this.userIsOptin()?Promise.resolve(!0):this.getRmktOptinInfo().then(e=>void 0!=e).catch(e=>!1)}static getRmktOptinInfo(){return se.getOptinFromRmkt().then(e=>e).catch(e=>{l.error("Error while getRmktOptinInfo",e)})}static whenServiceWorkerReadyDo(e){const t="nadzTrig_whenServiceWorkerReadyDo";if(!O.checkRecusivite(t,150,1.5))return O.deleteGlobalVarRecursivite(t),Promise.resolve(!1);const r=Notification.permission;return"granted"===r?navigator.serviceWorker.ready.then(e).catch(e=>l.error("Exception while navigator.serviceWorker.ready",e)):"denied"===r||"default"===r?this.getRmktOptinInfo().then(t=>void 0!=t&&1==t.isFromRmkt?navigator.serviceWorker.ready.then(e).catch(e=>l.error("Exception while navigator.serviceWorker.ready",e)):new Promise((e,t)=>{(new j).deleteProfilInAdrenalead().then(t=>{b.clearAll(!0),e(!0)}).catch(t=>{b.clearAll(!0),e(!0)})})).catch(e=>{}):void 0}static whenGetSubscriptionDo(e){return this.whenServiceWorkerReadyDo(t=>t.pushManager.getSubscription().then(e).catch(e=>l.error("Exception while registration.pushManager.getSubscription()",e)))}static pushLocalNotif(e){this.whenServiceWorkerReadyDo(t=>{t.showNotification(e.title,e.options)})}static pushLocalNotifFromCampaign(e){this.pushLocalNotif(e.pushContent)}}class B{constructor(e){void 0==e&&(e={}),this.endpointId=e.endPointId||e.endpointId||e.endpoint_id,this.userId=e.idv||e.userId||e.user_id,this.timestamp=e.timestamp,this.browser=e.browser,this.os=e.os,this.countryCode=e.countryCode||e.country_code||e.geoCountryCode,this.countryName=e.countryName||e.country_name||e.geoCountryName,this.cityName=e.cityName||e.city_name||e.geoCityName,this.postalCode=e.postalCode||e.postal_code||e.geoPostalCode,this.ids=e.ids,this.endpoint=e.endpoint,this.auth=e.auth,this.p256dh=e.p256dh,this.isMobile=e.isMobile,void 0==this.isMobile&&(this.isMobile=e.is_mobile),void 0==this.isMobile&&(this.isMobile=!1),this.isFromRmkt=e.isFromRmkt,void 0==this.isFromRmkt&&(this.isFromRmkt=!1)}isValid(){return void 0!=this.endpointId&&void 0!=this.timestamp}static ignorableFieldsForReviver(){return["userId","idv"]}static convertShortToLong(e){let t=0;try{t=parseInt(e.gpc)}catch(e){}return{endpointId:e.ei,userId:e.idv,timestamp:e.t,browser:e.br,os:e.os,countryCode:e.gpc,countryName:e.gcounn,cityName:e.gcn,postalCode:t,isMobile:e.ism,ids:e.ids,endpoint:e.ep,auth:e.a,p256dh:e.p}}static createFromINadzInfo(e){const t=B.convertShortToLong(e);return new B(t)}}class K extends F{constructor(){super("NadzExternalCallEpi",b.storageUserProfile(),o.getCurrentConfig().configNotifadzApi),this._keyEndpoint="opti"}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||2!=t.length)return O.getPromiseRejectForBadParameters();let r={a:t[0],p:t[1]};return Z.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{if("object"==typeof e)return new B(e)}).catch(e=>void 0)}_refreshCampaigns(){return b.storageCampaigns().clearItems(),(new U).getCampaigns()}_setGeoLocValuesInUserProfil(e){const t=new $;he.isNotEmpty(e.countryCode)&&t.setValue(p.GeoCountryCode,e.countryCode),he.isNotEmpty(e.countryName)&&t.setValue(p.GeoCountryName,e.countryName),void 0!=e.postalCode&&t.setValue(p.GeoPostalCode,e.postalCode),he.isNotEmpty(e.cityName)&&t.setValue(p.GeoCityName,e.cityName),(new j).sendProfilToAdrenalead()}saveResultInLSFunc(e){if(void 0!=e){const t=b.getPushSub();t.optinInfo=e,b.savePushSub(t),this._refreshCampaigns().then(t=>this._setGeoLocValuesInUserProfil(e)).catch(e=>{})}return Promise.resolve()}getResultInLSFunc(){const e=b.getPushSub();if(void 0!=e)return e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class H{constructor(){this._extCallService=new D(new K)}_saveSubscriptionIfNeeded(e){const t=this.getStoredPushSub();if(void 0==t||t.isDifferentOf(e)){void 0!=t&&t.isDifferentOf(e)&&b.clearItemsInCheckAgainAndValidatedCampaigns();let r=void 0;return r=e instanceof PushSubscription?d.fromPushSubscription(e):e,b.savePushSub(r),r}return t}_getSubscription(){const e=this;return x.whenGetSubscriptionDo(t=>x.userIsOptin()&&null!=t?e._saveSubscriptionIfNeeded(t):se.getOptinFromRmktAsPushSub())}getStoredPushSub(){return b.getPushSub()}getOptinInfo(){const e=this._getSubscription();return void 0==e?Promise.resolve(void 0):e.then(e=>{if(void 0!=e&&void 0!=e.keys){const t=e.keys.auth,r=e.keys.p256dh,i=e.optinInfo;return void 0!=i&&i instanceof B&&i.isValid()?Promise.resolve(e.getOptinInfo()):this._extCallService.getResult(t,r)}return Promise.resolve(void 0)}).catch(e=>Promise.resolve(void 0))}saveSubscription(){return this.getOptinInfo()}static getService(){return new H}static saveSubscription(){return this.getService().saveSubscription()}}class W{constructor(e){this._item=e}rulesAreValidated(){if(void 0==this._item)return Promise.resolve(!1);let e=Promise.resolve(!1);return e=this._item.allRulesNeedToMatch?this._allRulesAreMatching():this._atLeastOneRuleIsMatching()}rulesAreNotValidated(){return this.rulesAreValidated().then(e=>Promise.resolve(!e)).catch(e=>Promise.resolve(!0))}_ruleMatchPropertyPromises(){const e=[];for(let t=0;t<this._item.rules.length;t++){const r=this._item.rules[t],i=I.from(r);e.push(i.ruleMatchProperty(r))}return Promise.all(e)}_atLeastOneRuleIsMatching(){return this._ruleMatchPropertyPromises().then(e=>{let t=!1;for(let r=0;r<e.length;r++){if(1==e[r]){t=!0;break}}return Promise.resolve(t)}).catch(e=>Promise.resolve(!1))}_allRulesAreMatching(){return this._ruleMatchPropertyPromises().then(e=>{let t=!0;for(let r=0;r<e.length;r++){if(0==e[r]){t=!1;break}}return Promise.resolve(t)}).catch(e=>Promise.resolve(!1))}}class z extends F{constructor(){super("NadzExternalCallUserProfilApi",b.storageUserProfile(),o.getCurrentConfig().configTriggersApi),this._keyEndpoint="userProfil",this.KEY_STORAGE=w.ProfilSended}retrieveGlobalParams(...e){let t=e[0];for(let e=0;e<10&&void 0!=t;e++){if(!Array.isArray(t))return t;t=t[0]}}retrieveSendParams(...e){const t=this.retrieveGlobalParams(e);if(void 0!=t)return t.params}retrieveSendCondition(...e){const t=this.retrieveGlobalParams(e);if(void 0!=t)return t.condition}profilIsNotOk(e){return void 0==e||e.isNotOk()}profilEmptyOrWithOnlyOptin(e){return f.arrayIsUndefinedOrEmpty(e.profil)||1==e.profil.length&&e.profil[0].tag==p.Optin}getStoredLastSendedProfil(){return localStorage.getItem(this.KEY_STORAGE)}saveSendedProfil(e){localStorage.setItem(this.KEY_STORAGE,JSON.stringify(e))}canSendProfil(e){const t=this.getStoredLastSendedProfil();if(he.isNotEmpty(t)){return JSON.stringify(e)!=t}return!0}externalCallFunc(...e){const t=this.retrieveSendParams(e);if(void 0==t)return O.getPromiseRejectForBadParameters();const r=t.userProfil,i=t.httpMethod;return this.profilIsNotOk(r)||void 0==i?O.getPromiseRejectForBadParameters():this.profilEmptyOrWithOnlyOptin(r)&&"DELETE"!=i?void 0:this.canSendProfil(r)||"DELETE"==i?(this.saveSendedProfil(r),Z.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),{p:r},i)):(l.debug("Profil not sended to remote api - values are the same"),Promise.resolve("204"))}conditionnalCallFunc(...e){const t=this.retrieveSendCondition(e),r=void 0!=t&&t.forceSendProfil;return r&&l.info("Forcing send profil"),r}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class j{constructor(){this._externalCallService=new D(new z,!1)}isArrayOfTimedValue(e){return Array.isArray(e)&&e[0]instanceof u}_getPushSub(e){let t=b.storageUserProfile().getAllItems(),r=t.get(R.PushSubscription);return void 0!=r||e&&1!=window.nadzTrigModeTest?Promise.resolve(r):H.saveSubscription().then(e=>(t=b.storageUserProfile().getAllItems(),r=t.get(R.PushSubscription),Promise.resolve(r))).catch(e=>Promise.resolve(void 0))}_prepareProfilTags(e){let t=b.storageUserProfile().getAllItems();const r=[];return e||t.forEach((e,t)=>{let i=void 0;if(e instanceof u)i=ie.createFromTimedValue(t,e);else if(e instanceof Map){const r=f.createArrayFromMapValues(e);this.isArrayOfTimedValue(r)&&(i=ie.createFromArrayOfTimedValue(t,r))}void 0!=i&&r.push(i)}),r}_createUserProfilBeanFromOptinInfo(e){const t={ids:e.ids,auth:e.auth,p256:e.p256dh,profil:[],epi:e.endpointId,idv:e.userId};return e.isFromRmkt&&(t.fIds=e.ids),new ee(t)}_createBeanFromLocalStorage(e){try{return this._getPushSub(e).then(t=>{const r=b.getIds(),i=this._prepareProfilTags(e);if(void 0!=t){const s={ids:r,auth:t.keys.auth,p256:t.keys.p256dh,profil:i};if(!e){const e=t.optinInfo;void 0!=e&&(s.idv=e.userId,s.epi=e.endpointId,e.isFromRmkt&&(s.fIds=e.ids))}return Promise.resolve(new ee(s))}return Promise.resolve(void 0)}).catch(e=>Promise.resolve(void 0))}catch(e){return l.error("Error while creating profil bean",e),Promise.resolve(void 0)}}_createSendGlobalParams(e,t,r=!1){return{params:{httpMethod:e,userProfil:t},condition:{forceSendProfil:r}}}_callApi(e,t,r){return this._externalCallService.callApi(this._createSendGlobalParams(e,t,r))}_callApiDelete(e,t){return this._callApi("DELETE",e,t)}sendProfilToAdrenalead(e){return this._createBeanFromLocalStorage().then(t=>{void 0!=t&&(l.debug("sending userProfil",t),this._callApi("POST",t,e))}).catch(e=>{})}deleteProfilInAdrenalead(e){return this._createBeanFromLocalStorage(!0).then(t=>{void 0!=t&&(l.debug("deleting userProfil",t),this._callApiDelete(t,e))}).catch(e=>{})}deleteProfilRmktInAdrenalead(){const e=b.storageRmktGetOptinInfo(),t=this._createUserProfilBeanFromOptinInfo(e);return t.fIds=t.ids,t.ids=b.getIds(),this._callApiDelete(t,!0)}}class q extends F{constructor(){super("NadzExternalCallTriggersApi",b.storageValidatedCampaigns(),o.getCurrentConfig().configTriggersApi),this._storageSendedTriggersService=b.storageTriggersSended(),this._userProfilService=new j}_getDateRules(e){let t=e.filter(e=>e.propertyIsTypeDate);return void 0==t&&(t=[]),t}_delayFromRule(e){if(void 0==e)return Promise.resolve(0);const t=e.matchingValue;return e.operatorIsGreaterThan()?Promise.resolve(t):e.propertyIsTypeAudience()&&e.operatorIsIs()?U.getNestedAudienceByIdString(e.getPropertyKey()).then(e=>void 0!=e?this._delayFromRules(e.rules,!0):0).catch(e=>0):void 0}_delayFromRules(e,t=!1){if(void 0==e)return Promise.resolve(0);const r=[];return this._getDateRules(e).forEach(e=>{r.push(this._delayFromRule(e))}),Promise.all(r).then(e=>{let t=0;for(let r=0;r<e.length;r++){const i=e[r];i>t&&(t=i)}return t}).then(e=>t?e:M.minutesToMillis(e)).catch(e=>0)}_campaignHasTimeTable(e){return e.hasTimeTable()&&M.stringMatchesFormatHoursMinutes(e.startHour)&&M.stringMatchesFormatHoursMinutes(e.endHour)}_getSendingDate(e){let t=e.getTriggerDelayInMillis();t<=0&&(t=i,l.debug(`Replacing delay by default value ${M.millisToMinutes(t)} min`)),l.debug(`Final delay for trigger ${e.campaignId} is ${M.millisToMinutes(t)} min`);let r=new Date(Date.now()+t);if(this._campaignHasTimeTable(e)){let t=!1;if(M.hoursAndMinutesAreBeforeGivenOnes(r,e.startHour)?t=!0:M.hoursAndMinutesAreAfterGivenOnes(r,e.endHour)&&(t=!0,r=M.addDays(r,1),l.debug("Added a day to date, new sendingDate = ",r)),t){const t=M.getHoursFromStringHoursMinutes(e.startHour),i=M.getMinutesFromStringHoursMinutes(e.startHour);-1!=t&&-1!=i&&(r.setHours(t),r.setMinutes(i),l.debug("Changed hours:min, new sendingDate = ",r))}}return r}getStoredTrigger(e){const t=e.idc.toString();return this._storageSendedTriggersService.getItem(t)}saveTrigger(e){const t=new u(e);this._storageSendedTriggersService.setItem(e.idc.toString(),t)}triggerIsNotOk(e){return void 0==e||void 0==e.tr||he.isEmpty(e.tr.a)||he.isEmpty(e.tr.p)||he.isEmpty(e.tr.epu)||void 0==e.tr.idc||he.isEmpty(e.tr.ids)}canSendTrigger(e,t){if(this.triggerIsNotOk(t))return!1;if("PUT"==e){const e=t.tr,r=this.getStoredTrigger(e);if(void 0==r)return!0;if(M.getElaspedTimeSinceNow(r.time)<o.getCurrentConfig().timeBetweenSameTrigger){const t=r.data;let i="Waiting time between 2 PUT for same trigger NOT OK, checking if some values changed, id = "+t.idc;return l.debug(i),t.a!=e.a||t.epi!=e.epi||t.epu!=e.epu||t.ids!=e.ids||t.idc!=e.idc||t.p!=e.p}}return!0}getUserId(e){var t;let r=void 0;return r=void 0!=e&&he.isNotEmpty(e.userId)?e.userId:null===(t=b.getIdv())||void 0===t?void 0:t.idv}_fetchOldOptinInfo(){return b.storageRmktGetOptinInfo()}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||t.length<3||t.length>4)return O.getPromiseRejectForBadParameters();const r=t[0],i=t[1],s=t[2],n=t[3],a="DELETE"!=s;if(void 0==r||void 0==i||void 0==s)return O.getPromiseRejectForBadParameters();let o=r.getOptinInfo();if(1==n){const e=this._fetchOldOptinInfo();if((null===e||void 0===e?void 0:e.userId)==(null===o||void 0===o?void 0:o.userId))return Promise.resolve("204");o=e}if(void 0!=o&&a){if(!(new G).isCampaignOkWithOptin(i,o))return O.getPromiseRejectForBadCiblage()}const l=this.getUserId(o),c=o?o.endpointId:void 0,u=o?o.timestamp:void 0,h=i?i.ciblage:void 0,d=!!o&&o.isFromRmkt;void 0!=h&&d&&h.ids.push(o.ids);const p=b.getIds();let g=p;void 0!=o&&void 0!=o.ids&&(g=o.ids);const m=this._getSendingDate(i);let y={tr:{idc:i.campaignId,uid:l,sd:m,epi:c,ids:g,epu:r.endpoint,a:r.keys.auth,p:r.keys.p256dh,t:u,c:h,wait:i.waitingTimeInDaysBetweenPushes}};d&&(y.tr.pIds=p);let _=Promise.resolve();return he.isEmpty(c)&&(_=oe.getOptinInfo(p).then(e=>{void 0!=e&&(y.tr.hf=e.href,y.tr.hn=e.hostname,y.tr.lg=e.language,y.tr.pf=e.platform,y.tr.ua=e.userAgent)}).catch(e=>{})),_.then(e=>this.canSendTrigger(s,y)?(1!=n&&this.saveTrigger(y.tr),a&&this._userProfilService.sendProfilToAdrenalead(!0),Z.fetchJsonToUrl(this.getApiBaseUrl(),y,s)):Promise.resolve("204")).catch(e=>Promise.resolve("204"))}saveResultInLSFunc(){return Promise.resolve()}getResultInLSFunc(){return""}}class Y{constructor(){this._campaignStorageService=new U,this._validatedCampaigns=b.storageValidatedCampaigns(),this._campaignsToCheckAgain=b.storageCheckAgain(),this._extCallService=new D(new q,!1),this._mapOfRequestedCalls=new Map}_campaignIsAlreadyValidated(e){return this._validatedCampaigns.hasItem(e.getId())}_putCampaignInLs(e,t){l.log("Putting campaign in LS : "+t.getRootKey()),t.setItem(e.getId(),e)}_removeCampaignInLs(e,t){l.log("Removing campaign in LS : "+t.getRootKey()),t.removeItem(e.getId())}_putCampaignInLsCheckAgain(e){this._putCampaignInLs(e,this._campaignsToCheckAgain)}_removeCampaignInLsCheckAgain(e){this._removeCampaignInLs(e,this._campaignsToCheckAgain)}_putCampaignInLsValidated(e){this._putCampaignInLs(e,this._validatedCampaigns)}_removeCampaignInLsValidated(e){this._removeCampaignInLs(e,this._validatedCampaigns)}_addBeanToListOfCalls(e){this._mapOfRequestedCalls.set(e.getKey(),e)}_callTriggerApi(e,t,r,i,s){if(void 0!=i&&1==i){const i=new X(e,t,r);return l.info("Putting aside the requested call for "+i.getKey()),void this._addBeanToListOfCalls(i)}const n=H.getService();n.getOptinInfo().then(i=>{const a=n.getStoredPushSub();this._extCallService.callApi(a,e,t,s).then(e=>{r(e)}).catch(r=>{l.error(`Error while calling ${t} trigger API `,r),this._handleCallTriggerApiFailed(e,r)})}).catch(e=>{l.error("Error while getting epi ",e)})}_callTriggerApiWithBean(e){return this._callTriggerApi(e.campaign,e.httpMethod,e.callback)}_handleCallTriggerApiFailed(e,t){t!=O.badCiblageMsg&&this._putCampaignInLsCheckAgain(e)}_insertCampaign(e,t){this._callTriggerApi(e,"POST",t=>{201!=t&&204!=t||(this._putCampaignInLsValidated(e),this._removeCampaignInLsCheckAgain(e))},t)}_updateCampaign(e,t){this._callTriggerApi(e,"PUT",t=>{404==t&&(this._putCampaignInLsCheckAgain(e),this._removeCampaignInLsValidated(e))},t)}_deleteCampaign(e,t,r){this._callTriggerApi(e,"DELETE",t=>{204==t&&this._removeCampaignInLsValidated(e)},t,r)}_handleValidatedCampaign(e,t){1!=e.isInstant?this._campaignIsAlreadyValidated(e)?e.canBeUpdated()&&this._updateCampaign(e,t):this._insertCampaign(e,t):x.pushLocalNotifFromCampaign(e)}_handleUnvalidatedCampaign(e,t){this._validatedCampaigns.hasItem(e.getId())&&this._deleteCampaign(e,t)}_checkCampaign(e,t){return new W(e).rulesAreValidated().then(r=>{r?this._handleValidatedCampaign(e,t):this._handleUnvalidatedCampaign(e,t)}).catch(e=>{})}sendDeleteForValidatedCampaignsAndClean(){for(const e of this._validatedCampaigns.getAllItems().values())this._deleteCampaign(e,!1,!0);return Promise.resolve()}checkRulesForKey(e,t,r){let i=Promise.resolve(t);void 0==t&&(i=this._campaignStorageService.getCampaignsForPropertyKey(e));const s=[];return i.then(t=>{void 0==t&&(t=[]),l.log(`campaigns for key ${e} = `,t);for(let e=0;e<t.length;e++)s.push(this._checkCampaign(t[e],r));return Promise.all(s)}).catch(e=>Promise.all(s))}checkRulesForCheckAgainCampaigns(){let e=f.createArrayFromMapValues(this._campaignsToCheckAgain.getAllItems());return l.log("campaigns in checkAgain = ",e),V.getUsedKeysFromCampaigns(e).then(t=>{const r=[];for(let i=0;i<t.size;i++)r.push(this.checkRulesForKey(t[i],e));return Promise.all(r)}).catch(e=>{})}sendRequestedCalls(){this._mapOfRequestedCalls.forEach((e,t)=>{this._callTriggerApiWithBean(e)})}static deleteValidatedCampaignsAndClean(){return(new Y).sendDeleteForValidatedCampaignsAndClean()}}class Z{static getRequestContent(e,t){return{method:e,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}}static fetchJsonToUrl(e,t,r){return new Promise((i,s)=>{if(void 0==e)return void s("Bad parameters, url can't be null");void 0==r&&(r="POST");const n=this.getRequestContent(r,t);l.info("Fetching at "+e+" with body "+JSON.stringify(n));try{fetch(e,n).then(e=>{e.json().then(e=>i(e)).catch(t=>i(e.status))}).catch(e=>{s(e)})}catch(e){return void s(e)}})}}!function(e){e.SPECIAL_CHARS="HTML_SPECIALCHARS",e.ENTITIES="HTML_ENTITIES"}(N||(N={})),function(e){e.NO_QUOTES="ENT_NOQUOTES",e.COMPAT="ENT_COMPAT",e.QUOTES="ENT_QUOTES"}(k||(k={}));class J{static htmlMappingTable(e,t){const r=e||N.SPECIAL_CHARS,i=t||k.QUOTES,s={},n={};if(r==N.SPECIAL_CHARS)s[38]="&amp;",s[60]="&lt;",s[62]="&gt;";else{if(r!=N.ENTITIES)return;s[38]="&amp;",s[60]="&lt;",s[62]="&gt;",s[160]="&nbsp;",s[161]="&iexcl;",s[162]="&cent;",s[163]="&pound;",s[164]="&curren;",s[165]="&yen;",s[166]="&brvbar;",s[167]="&sect;",s[168]="&uml;",s[169]="&copy;",s[170]="&ordf;",s[171]="&laquo;",s[172]="&not;",s[173]="&shy;",s[174]="&reg;",s[175]="&macr;",s[176]="&deg;",s[177]="&plusmn;",s[178]="&sup2;",s[179]="&sup3;",s[180]="&acute;",s[181]="&micro;",s[182]="&para;",s[183]="&middot;",s[184]="&cedil;",s[185]="&sup1;",s[186]="&ordm;",s[187]="&raquo;",s[188]="&frac14;",s[189]="&frac12;",s[190]="&frac34;",s[191]="&iquest;",s[192]="&Agrave;",s[193]="&Aacute;",s[194]="&Acirc;",s[195]="&Atilde;",s[196]="&Auml;",s[197]="&Aring;",s[198]="&AElig;",s[199]="&Ccedil;",s[200]="&Egrave;",s[201]="&Eacute;",s[202]="&Ecirc;",s[203]="&Euml;",s[204]="&Igrave;",s[205]="&Iacute;",s[206]="&Icirc;",s[207]="&Iuml;",s[208]="&ETH;",s[209]="&Ntilde;",s[210]="&Ograve;",s[211]="&Oacute;",s[212]="&Ocirc;",s[213]="&Otilde;",s[214]="&Ouml;",s[215]="&times;",s[216]="&Oslash;",s[217]="&Ugrave;",s[218]="&Uacute;",s[219]="&Ucirc;",s[220]="&Uuml;",s[221]="&Yacute;",s[222]="&THORN;",s[223]="&szlig;",s[224]="&agrave;",s[225]="&aacute;",s[226]="&acirc;",s[227]="&atilde;",s[228]="&auml;",s[229]="&aring;",s[230]="&aelig;",s[231]="&ccedil;",s[232]="&egrave;",s[233]="&eacute;",s[234]="&ecirc;",s[235]="&euml;",s[236]="&igrave;",s[237]="&iacute;",s[238]="&icirc;",s[239]="&iuml;",s[240]="&eth;",s[241]="&ntilde;",s[242]="&ograve;",s[243]="&oacute;",s[244]="&ocirc;",s[245]="&otilde;",s[246]="&ouml;",s[247]="&divide;",s[248]="&oslash;",s[249]="&ugrave;",s[250]="&uacute;",s[251]="&ucirc;",s[252]="&uuml;",s[253]="&yacute;",s[254]="&thorn;",s[255]="&yuml;"}i!=k.NO_QUOTES&&(s[34]="&quot;"),i==k.QUOTES&&(s[39]="&#039;");for(const e in s){n[String.fromCharCode(e)]=s[e]}return n}static htmlDecode(e,t,r){let i=t.toString();const s=J.htmlMappingTable(e,r);if(void 0==s)return"";for(const e in s){const t=s[e];i=i.split(t).join(e)}return i}static htmlSpecialCharsDecode(e,t){return J.htmlDecode(N.SPECIAL_CHARS,e,t)}static htmlEntitiesDecode(e,t){return J.htmlDecode(N.ENTITIES,e,t)}}class ${constructor(){this._LOG=!1,this._calledOptin=!1,this._nbOfActionsToExecute=0,this._nbOfActionsExecuted=0,this._cpFetched=!1,this._lsUserProfile=b.storageUserProfile(),this._checkCampaignService=new Y,this._userProfilService=new j,this._userProfilHasChanged=!1}_log(e,t){this._LOG&&l.log(e,t)}_addToMap(e,t){!ce.isEmpty(e)&&e instanceof Map||(e=new Map);const r=new u(t,void 0,1),i=r.data,s=e.get(i);return void 0!=s&&(r.count+=s.getCount()),e.set(i,r),this._userProfilHasChanged=!0,e}_addToArray(e,t){f.arrayIsUndefinedOrEmpty(e)&&(e=[]);let r=e.length-1;if(r<0&&(r=0),!e[r]||e[r].data!=t){let r=new u(t);e.push(r),this._userProfilHasChanged=!0}return e}_removeFromArray(e,t){if(f.arrayIsUndefinedOrEmpty(e))return;const r=[];for(let i=0;i<e.length;i++){e[i].data==t&&r.push(i)}if(f.arrayIsNotEmpty(r))for(let t=0;t<r.length;t++)e.splice(r[t]-t,1);return e}_removeFromMap(e,t){if(!ce.isEmpty(e))return e.delete(t),e}_checkMap(e){for(;e.size>o.ARRAY_MAX_SIZE;)for(const t of e.keys()){e.delete(t);break}}_checkArray(e){for(;e.length>o.ARRAY_MAX_SIZE;)e.shift()}_checkRulesForKey(e,t){let r=this._fetchCpPromise;return 1!=this._cpFetched&&void 0!=r||(r=Promise.resolve()),r.then(r=>e==p.DateOptin?this._setDateOptin().then(r=>{this._checkCampaignService.checkRulesForKey(e,void 0,t).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))}).catch(e=>Promise.reject(e)):this._checkCampaignService.checkRulesForKey(e,void 0,t).then(e=>Promise.resolve()).catch(e=>Promise.reject(e))).catch(e=>Promise.reject(e))}_setUserProfilItem(e,t,r){this._lsUserProfile.setItem(e,t),r&&(this._userProfilHasChanged=!0)}_removeUserProfilItem(e){this._lsUserProfile.removeItem(e),this._userProfilHasChanged=!0}_setValue(e,t,r,i){if(e==p.Optin){if(1==this._calledOptin)return Promise.resolve(!0);this._calledOptin=!0}if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);let s=this._lsUserProfile.getItem(e),n=!0;t=this._decodeValue(t),(void 0==s||s instanceof u&&s.data!=t)&&(this._userProfilHasChanged=!0),this._log("LS value for "+e+" : ",s);let a=new u(t);return void 0!=i&&(a.time=i),e==p.Optin&&(n=void 0!=s&&s==a.data),void 0==t&&(a=null),this._setUserProfilItem(e,a,!1),void 0==s&&(s=t),e==p.Optin&&n?Promise.resolve(s):this._checkRulesForKey(e,r).then(()=>(e!=p.Optin&&e!=p.DateOptin&&this._incrementActionExecuted(),Promise.resolve(s))).catch(e=>Promise.resolve(s))}_unsetValue(e,t){return this._log("Removing LS value for "+e),this._removeUserProfilItem(e),this._checkRulesForKey(e,t).then(()=>this._incrementActionExecuted()).catch(()=>this._incrementActionExecuted())}_callbackIncrementAndResolvValue(e){return()=>(this._incrementActionExecuted(),Promise.resolve(e))}_checkRulesForKeyThenIncrementThenResolvValue(e,t,r){return this._checkRulesForKey(e,r).then(this._callbackIncrementAndResolvValue(t)).catch(this._callbackIncrementAndResolvValue(t))}_decodeValue(e){return"string"==typeof e&&(e=J.htmlSpecialCharsDecode(e))==e&&(e=J.htmlEntitiesDecode(e)),e}_keyOrValueAreNotOk(e,t){return void 0==e||"null"==e||void 0==t||"null"==t}_addValue(e,t,r){if(this._keyOrValueAreNotOk(e,t))return Promise.resolve(!1);let i=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),i=this._addToMap(i,t),this._checkMap(i),this._log("LS values for "+e+" : ",i),this._setUserProfilItem(e,i,!1),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_removeValue(e,t,r){let i=this._lsUserProfile.getItem(e);return t=this._decodeValue(t),i=this._removeFromMap(i,t),this._checkMap(i),this._log("LS values for "+e+" : ",i),this._setUserProfilItem(e,i,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_incrementValue(e,t,r){void 0==t&&(t=1);let i=this._lsUserProfile.getItem(e);return void 0==i&&(i=new u(0)),i.data+=t,this._log("LS value for "+e+" : ",i),this._setUserProfilItem(e,i,!0),this._checkRulesForKeyThenIncrementThenResolvValue(e,i,r)}_setIds(e){void 0==this._ids&&(b.saveIds(e),this._ids=b.getIds()),this._checkCampaignService.checkRulesForCheckAgainCampaigns()}_saveSubscription(){return H.saveSubscription()}_setDateOptin(){if(void 0!=this._dateOptin)return Promise.resolve();const e=b.getDateOptin();return void 0!=e?(this._dateOptin=e,Promise.resolve()):this._saveSubscription().then(e=>{const t=e.timestamp;return void 0!=t&&t>0&&(this.setValue(y.dateOptin().propertyKey,t),this._dateOptin=t),Promise.resolve()}).catch(e=>Promise.resolve())}_setOptinTrueIfNeeded(){return x.userIsOptin()?this._setValue(p.Optin,!0):Promise.resolve()}_incrementActionExecuted(e){this._nbOfActionsExecuted++,this._userProfilHasChanged&&(this._nbOfActionsExecuted>=this._nbOfActionsToExecute||e)&&this._userProfilService.sendProfilToAdrenalead()}directSetValue(e,t,r,i){this._setValue(e,t,r,i)}setValue(e,t,r,i){return x.whenServiceWorkerReadyDo(this._setValue.bind(this,e,t,r,i))}unsetValue(e,t){return x.whenServiceWorkerReadyDo(this._unsetValue.bind(this,e,t))}addValue(e,t,r){return x.whenServiceWorkerReadyDo(this._addValue.bind(this,e,t,r))}removeValue(e,t,r){return x.whenServiceWorkerReadyDo(this._removeValue.bind(this,e,t,r))}addLastPages(e,t){return this.addValue(y.lastPages().propertyKey,e,t)}incrementValue(e,t,r){return x.whenServiceWorkerReadyDo(this._incrementValue.bind(this,e,t,r))}setIds(e){return void 0!=e&&(e=e.trim()),this._incrementActionExecuted(),void 0==this._ids?(b.saveIds(e),this._ids=b.getIds(),x.canRunProgram().then(e=>{e?U.fetchCampaigns().then(e=>Promise.resolve(!0)).catch(e=>Promise.resolve(!1)):Promise.resolve(!0)}).catch(e=>Promise.resolve(!1))):x.whenServiceWorkerReadyDo(this._setIds.bind(this,e))}rmktIsActive(e){void 0==this._rmktIsActive&&(b.saveRmktIsActive(e),this._rmktIsActive=e)}_deleteOldTriggers(){return Y.deleteValidatedCampaignsAndClean()}_deleteRmktProfil(){return this._userProfilService.deleteProfilRmktInAdrenalead()}optin(){const e=this;return e._deleteOldTriggers().then(t=>e._deleteRmktProfil()).then(t=>e._saveSubscription()).then(e=>this.setValue(p.Optin,!0)).catch(e=>{})}startOfActions(e){this._lsUserProfile.getAllItems(),this._nbOfActionsToExecute=e;const t=this;return x.whenServiceWorkerReadyDo(()=>(console.log("Start of actions"),t._fetchCpPromise=U.getCampaigns(),t._setOptinTrueIfNeeded(),t._fetchCpPromise.then(e=>{t._cpFetched=!0,t._setOptinTrueIfNeeded()}).catch(e=>{})))}incrementNbOfActions(e){void 0==this._nbOfActionsToExecute&&(this._nbOfActionsToExecute=0),this._nbOfActionsToExecute+=e}endOfActions(){this._checkCampaignService.sendRequestedCalls(),this._incrementActionExecuted(!0)}visitTriggers(e,t){return e?this.setValue(R.NadzLastVisit,Date.now(),t):Promise.resolve()}lastPageIsActive(e,t){const r=window.location.href;return e&&he.isNotEmpty(r)?this.setValue(p.UrlLastPage,r,t):Promise.resolve()}setMontantConversion(e,t,r){let i=void 0;try{i=parseFloat(e)}catch(e){}return void 0!=i?this.setValue(p.MontantConversion,i,t,r):Promise.resolve()}setProduitsDansPanier(e,t){return this.setValue(p.ProduitsDansPanier,e,t)}purchased(e,t){return this.setValue(p.Purchased,e,t)}isAuthenticated(e,t){return this.setValue(p.IsAuthenticated,e,t)}}const Q=new $;class X{constructor(e,t,r){this.campaign=e,this.httpMethod=t,this.callback=r}getKey(){return this.httpMethod+"_"+this.campaign.campaignId}}class ee{constructor(e){this.ids=e.ids,this.fIds=e.fIds,this.idv=e.idv,this.epi=e.epi,this.auth=e.auth,this.p256=e.p256,this.profil=e.profil}isNotOk(){return!this.isOk()}isOk(){return void 0!=this.ids&&void 0!=this.auth&&void 0!=this.p256&&void 0!=this.profil}}class te{constructor(e){void 0==e&&(e={}),this.isMobile=e.isMobile,void 0==this.isMobile&&(this.isMobile=e.is_mobile),void 0==this.isMobile&&(this.isMobile=!1),this.browser=e.browser,this.listCountry=e.listCountry||e.list_country,this.cityName=e.cityName||e.city_name,this.postalCode=e.postalCode||e.postal_code,this.ids=e.ids,this.idsExclus=e.idsExclus||e.ids_exclus}getCitiesAsList(){return this.cityName.split(",")}getPostalCodes(){return this.postalCode.split(",")}}class re{constructor(e,t,r,i){this.body=e,this.icon=t,this.data=r,this.actions=i}toString(){let e="body="+this.body;return void 0!=this.icon&&(e+=this.icon),void 0!=this.data&&(e+=this.data),void 0!=this.actions&&(e+=this.actions.join("|")),e}static fromObject(e){return c.objectsHasSamePropertiesAs(e,re)?new re(e.body,e.icon,e.data,e.actions):null}}class ie{constructor(e){void 0==e&&(e={}),this.tag=e.tag,this.data=e.data,this.time=e.time}static createFromTimedValue(e,t){if(!he.isEmpty(e)&&void 0!=t&&!t.isNotOk())return new ie({tag:e,data:t.data,time:t.time})}static createFromArrayOfTimedValue(e,t){if(!he.isEmpty(e)&&!f.arrayIsUndefinedOrEmpty(t))return new ie({tag:e,data:t,time:t[0].time})}}class se{constructor(){this._externalCallService=new D(new le,!1)}_callApi(e,t){return this._externalCallService.getResult(e,t)}_isAuthorizedToDoRmkt(e,t){const r=b.getRmktIsActive();return!x.userIsOptin()&&void 0!=e&&void 0!=e.idv&&1!=e.isFromRandom&&void 0!=t&&r}getOptinFromRmkt(){const e=b.getIdv(),t=b.getIds();return this._isAuthorizedToDoRmkt(e,t)?this._callApi(e.idv,t):(l.info("Tried to call optinFromRmkt but user is either optin, missing idv or ids or is not authorized"),Promise.resolve(void 0))}static getOptinFromRmkt(){return(new se).getOptinFromRmkt()}static getOptinFromRmktAsPushSub(){return se.getOptinFromRmkt().then(e=>{let t=void 0;return void 0!=e&&(t=d.fromOptinInfo(e)),Promise.resolve(t)}).catch(e=>Promise.resolve(void 0))}}var ne,ae;!function(e){e.SAVE_OPTIN_INFO="save",e.GET_OPTIN_INFO="getOptinInfo",e.SAVE_MIGRATION="saveMigration",e.GET_MIGRATION="getMigration"}(ne||(ne={})),function(e){e.MIGRATION_ACTIVATED="migrationActivated",e.MIGRATION_TREATED="migrationTreated"}(ae||(ae={}));class oe{constructor(){}static _getIndexedDB(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB}static getOptinInfo(e){return void 0==e&&(e=b.getIds()),oe.handleIndexedDB(ne.GET_OPTIN_INFO,{key:e})}static saveOptinInfo(e){return oe.handleIndexedDB(ne.SAVE_OPTIN_INFO,e)}static saveMigration(e,t){return new Promise((r,i)=>{oe.getMigration(e).then(s=>{let n=0;void 0!=s&&void 0!=s.count&&(n=s.count),n++,oe.handleIndexedDB(ne.SAVE_MIGRATION,{key:e,value:{value:t,time:Date.now(),count:n}}).then(e=>r(e)).catch(e=>i(e))}).catch(e=>i(e))})}static getMigration(e){return oe.handleIndexedDB(ne.GET_MIGRATION,{key:e})}static handleIndexedDB(e,t){return new Promise((r,i)=>{const s="nadzOptinInfo",n="nadzMigration";try{var a=oe._getIndexedDB();if(a){const i="IndexedDB nadzOpti - ";var o=a.open("nadzOpti");o.onupgradeneeded=(e=>{console.log(i+"onupgradeneeded");var t=e.target.result;try{t.deleteObjectStore(s),t.deleteObjectStore(n)}catch(e){}t.createObjectStore(s,{keyPath:"ids"}).createIndex("ids","ids",{unique:!0}),t.createObjectStore(n,{keyPath:"key"}).createIndex("key","key",{unique:!0})}),o.onsuccess=(i=>{var a=i.target.result;function o(e,t){return a.transaction(e,t).objectStore(e)}function l(e){a.close(),r(e)}function c(e){return o(s,e)}function u(e){return o(n,e)}if(e==ne.SAVE_OPTIN_INFO)c("readwrite").put(t),l(t);else if(e==ne.GET_OPTIN_INFO){var h=c("readonly");(d=h.get(t.key)).onsuccess=(e=>{void 0!=d.result?l(d.result):l(void 0)}),d.onerror=(e=>{})}else if(e==ne.SAVE_MIGRATION)u("readwrite").put(t),l(t);else if(e==ne.GET_MIGRATION){var d;h=u("readonly");(d=h.get(t.key)).onsuccess=(e=>{void 0!=d.result?l(d.result.value):l(void 0)})}else l(void 0)}),o.onerror=(e=>{})}else r(void 0)}catch(e){r(void 0)}})}}class le extends F{constructor(){super("NadzExternalCallRmkt",b.storageRmkt(),o.getCurrentConfig().configOptinInfoApi),this._keyEndpoint="rmkt-opti"}externalCallFunc(...e){const t=e[0][0][0];if(void 0==t||2!=t.length)return O.getPromiseRejectForBadParameters();let r={idv:t[0],ids:t[1]};return Z.fetchJsonToUrl(this.getApiUrl(this._keyEndpoint),r).then(e=>{if("object"==typeof e){let t;return(t=void 0!=e.result?new B(e.result):B.createFromINadzInfo(e)).isFromRmkt=!0,t}}).catch(e=>void 0)}saveResultInLSFunc(e){let t=b.getPushSub();return void 0==t?t=d.fromOptinInfo(e):void 0!=e?(void 0!=e.auth&&void 0!=e.p256dh&&(t.keys=new h(e.auth,e.p256dh)),t.optinInfo=e):t.optinInfo=null,b.savePushSub(t),this._lsService.setItem(p.Optin,e),Promise.resolve()}getResultInLSFunc(){var e;return null===(e=b.getPushSub())||void 0===e?void 0:e.getOptinInfo()}getWaitingTime(){return this.getEndpointWaitingTime(this._keyEndpoint)}}class ce{static isMap(e){return void 0!=e&&e instanceof Map}static isNotMap(e){return!ce.isMap(e)}static isEmpty(e){return void 0==e||e.size<1}static isNotEmpty(e){return!ce.isEmpty(e)}}class ue{static greaterThan(e,t){return void 0!=e&&void 0!=t&&e>t}static greaterThanEquals(e,t){return void 0!=e&&void 0!=t&&e>=t}static lesserThan(e,t){return void 0!=e&&void 0!=t&&e<t}static lesserThanEquals(e,t){return void 0!=e&&void 0!=t&&e<=t}}class he{static isEmpty(e){return void 0==e||e.length<1}static isNotEmpty(e){return!this.isEmpty(e)}static isEqualsIgnoreCase(e,t){return void 0!=e&&void 0!=t&&e.toUpperCase()==t.toUpperCase()}static isNotEqualsIgnoreCase(e,t){return!this.isEqualsIgnoreCase(e,t)}static includesIgnoreCase(e,t){return e.toUpperCase().includes(t.toUpperCase())}static includesNotIgnoreCase(e,t){return!this.includesIgnoreCase(e,t)}static startsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().startsWith(t.toLowerCase()))}static endsWithIgnoreCase(e,t){return"string"==typeof e&&(!this.isEmpty(e)&&!this.isEmpty(t)&&e.toLowerCase().endsWith(t.toLowerCase()))}}class de{static _paramsNotOk(e,t){return!(void 0!=e&&!e.isNotOk()&&void 0!=t)}static compareTimedValueForSort(e,t){return e.time<t.time?-1:e.time>t.time?1:0}static valueIsOlderThan(e,t){return!this._paramsNotOk(e,t)&&ue.greaterThan(e.ageOfValueInMinutes(),t)}static valueIsOlderThanEquals(e,t){return!this._paramsNotOk(e,t)&&ue.greaterThanEquals(e.ageOfValueInMinutes(),t)}static valueIsSmallerThan(e,t){return!this._paramsNotOk(e,t)&&ue.lesserThan(e.ageOfValueInMinutes(),t)}static valueIsSmallerThanEquals(e,t){return!this._paramsNotOk(e,t)&&ue.lesserThanEquals(e.ageOfValueInMinutes(),t)}}window.nadzTrigClean=!0;var pe,ge=(pe=Q,{startOfActions:function(e){return pe.startOfActions(e)},setIds:function(e){return pe.setIds(e)},rmktIsActive:function(e){return pe.rmktIsActive(e)},unsetValue:function(e,t){return pe.unsetValue(e,t)},setValue:function(e,t,r,i){return pe.setValue(e,t,r,i)},addValue:function(e,t,r){return pe.addValue(e,t,r)},removeValue:function(e,t,r){return pe.removeValue(e,t,r)},addLastPage:function(e,t){return pe.addLastPages(e,t)},incrementValue:function(e,t,r){return pe.incrementValue(e,t,r)},optin:function(){return pe.optin()},visitTriggers:function(e,t){return pe.visitTriggers(e,t)},lastPageIsActive:function(e,t){return pe.lastPageIsActive(e,t)},setMontantConversion:function(e,t,r){return pe.setMontantConversion(e,t,r)},setProduitsDansPanier:function(e,t){return pe.setProduitsDansPanier(e,t)},purchased:function(e,t){return pe.purchased(e,t)},isAuthenticated:function(e,t){return pe.isAuthenticated(e,t)},handleActions:function(e){if(void 0!=e&&e.shift&&e.length>0){const t=[];pe.incrementNbOfActions(e.length);for(let r=0;r<e.length;r++){const i=e[r];if(void 0==i)continue;const s=i.shift();i.push(!0),t.push(this[s].apply(this,i))}Promise.all(t).then(e=>{pe.endOfActions()}).catch(e=>{})}}});let me=window[NADZ_TRIGGERS_ARRAY_NAME].length;const ye="nadzIdv",_e="setIds",fe="rmktIsActive";function ve(){return Ie("9"+(Date.now()+Math.round(window.performance.now()))+Math.floor(100*Math.random())+1,!0)}function Ie(e,t){return{idv:e,isFromRandom:t,nadzTrigClean:window.nadzTrigClean}}window.addEventListener("nadzOptinEvent",e=>{if(void 0!=e&&void 0!=e.detail&&void 0!=e.detail.optinInfo){const t=e.detail.optinInfo;void 0!=t.idv&&we(t.idv),void 0!=ge&&void 0!=ge.optin&&ge.optin(),Ee(!0)}},!1);const Ae=[_e];function Ce(e){const t=e[0],r=e[1];t==NADZ_TRIGGERS_WELCOME_PUSH_ACTION&&!0===r&&(window[NADZ_TRIGGERS_WELCOME_PUSH_VAR]=!0)}function Te(e){return new Promise((t,r)=>{if(e.shift){var i=e.shift();Ce(i,e[0]),t(ge[i].apply(ge,e))}})}function Pe(e){if(void 0!=e)return JSON.parse(JSON.stringify(e))}function Ee(e){!function(){if(!(void 0==window[NADZ_TRIGGERS_ARRAY_NAME]||window[NADZ_TRIGGERS_ARRAY_NAME].length<1))for(var e=0;e<me;e++){const t=window[NADZ_TRIGGERS_ARRAY_NAME][e],r=t[0],i=t[1];if(r==NADZ_TRIGGERS_TEST_ACTION){window[NADZ_TRIGGERS_TEST_ACTION]=i,window[NADZ_TRIGGERS_ARRAY_NAME].splice(e,1),me--;break}}}();const t=["startOfActions",me-1];1!=e?window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]=Pe(window[NADZ_TRIGGERS_ARRAY_NAME]):window[NADZ_TRIGGERS_ARRAY_NAME]=Pe(window[NADZ_TRIGGERS_ARRAY_BACKUP_NAME]),Te(t).then(e=>{for(var t=0;t<me;t++){const e=window[NADZ_TRIGGERS_ARRAY_NAME][t];e[0]==NADZ_TRIGGERS_WELCOME_PUSH_ACTION?Ce(e):Te(e)}window[NADZ_TRIGGERS_ARRAY_NAME]=null}).catch(e=>{})}function Se(){if(window[NADZ_TRIGGERS_ARRAY_NAME][0][0]==fe){const e=window[NADZ_TRIGGERS_ARRAY_NAME].shift();me--,Te(e).then(e=>Ee()).catch(e=>{})}else Ee()}function Oe(){return new Promise((e,t)=>{new Promise((e,t)=>{window.nadzTrigAuthorized=!0,e(!0)}).then(t=>{(function(e,t=!1,r=!0){return new Promise(function(i,s){try{if(!t||t&&r){var n=document.getElementsByTagName("body")[0],a=document.createElement("iframe");n||(n=document.documentElement);var o=document.createElement("div");function l(e){var t=e.data;"object"==typeof t&&t.i&&i(t.i)}o.height="1px",o.width="1px",o.style.position="absolute",o.style.top="-42px",o.style.left="-42px",o.style.display="none",n.appendChild(o),a.src=e,a.id="nadz_iframec",a.name="nadz_iframec",a.height="1px",a.width="1px",a.style.position="absolute",a.style.top="-42px",a.style.left="-42px",o.appendChild(a),window.addEventListener?window.addEventListener("message",l,!1):window.attachEvent&&window.attachEvent("onmessage",l,!1),setTimeout(function(){n.removeChild(o),s()},2500)}else i(ve())}catch(e){console.log("Error : ",e)}})})("https://gjigle.com/cgp",window.nadzTrigClean,window.nadzTrigAuthorized).then(t=>{e(t)}).catch(t=>e(void 0)).catch(e=>{})})})}function we(e){let t=e;void 0==e.idv&&void 0==e.isFromRandom&&(t=Ie(e,!1)),localStorage&&localStorage.setItem(ye,JSON.stringify(t)),window[ye]=t}function Re(){let e=function(){if(localStorage){const e=localStorage.getItem(ye),t=JSON.parse(e);return window[ye]=t,t}return{}}();return void 0!=e&&void 0!=e.idv&&e.idv.length>0&&(0==e.isFromRandom||!window.nadzTrigAuthorized)&&e.nadzTrigClean==window.nadzTrigClean}var Ne;return new Promise((e,t)=>{const r=[];new Promise((e,t)=>{for(var r=0;r<me;r++)if(window[NADZ_TRIGGERS_ARRAY_NAME][r][0]==_e){const t=window[NADZ_TRIGGERS_ARRAY_NAME][r][1];void 0!=t&&t.length>0&&e(t.trim());break}void 0!=window.nadzIds&&window.nadzIds.length>0&&e(window.nadzIds.trim())}).then(e=>(e=e,new Promise((t,r)=>{try{fetch("https://notifpush.com/script_parameters/triggers/p_tr_"+e+".json",{method:"GET"}).then(e=>{if(e.ok)try{e.json().then(e=>{t(e._nAdzqTriggers)}).catch(e=>{t(!1)})}catch(e){t(!1)}else t(!1)}).catch(e=>{t(!1)})}catch(e){t(!1)}}))).then(t=>{0==t&&e(!1),t.forEach(e=>{const t=e[0];Ae.includes(t)||r.push(e)});const i=t.map(e=>e[0]);window[NADZ_TRIGGERS_ARRAY_NAME].forEach(e=>{const t=e[0];i.includes(t)&&"handleActions"!=t||r.push(e)});let s=r.find(e=>e[0]==fe);const n=r.find(e=>e[0]==_e);window[NADZ_TRIGGERS_ARRAY_NAME]=[],void 0==s&&(s=[fe,!1]),window[NADZ_TRIGGERS_ARRAY_NAME].push(s),void 0!=n&&window[NADZ_TRIGGERS_ARRAY_NAME].push(n);const a=[];a.push(fe),a.push(_e),r.forEach(e=>{a.includes(e[0])||window[NADZ_TRIGGERS_ARRAY_NAME].push(e)}),me=window[NADZ_TRIGGERS_ARRAY_NAME].length,e(!0)}).catch(t=>e(!1))}).then(e=>{0!=e?"granted"!==Notification.permission?Re()?Se():Oe().then(e=>{void 0==e&&(e=ve()),we(e),Se()}).catch(e=>{}):Se():console.log("Triggers are probably not remotly activated")}).catch(e=>{}),{getNadzTriggerActions:function(){return ge}}}());